<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>효진유통</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background-color: #0a0a0a;
        color: #e0e0e0;
        min-height: 100vh;
        display: flex;
      }

      /* 사이드바 */
      .sidebar {
        width: 200px;
        background-color: #111;
        padding: 20px 0;
        border-right: 1px solid #222;
        position: fixed;
        height: 100vh;
      }

      .logo {
        color: #00ff88;
        font-size: 20px;
        font-weight: bold;
        padding: 0 20px 30px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid transparent;
        color: #888;
        font-size: 14px;
      }

      .nav-item:hover {
        background-color: #1a1a1a;
        color: #fff;
      }

      .nav-item.active {
        background-color: #1a1a1a;
        border-left-color: #00ff88;
        color: #00ff88;
      }

      .nav-item.disabled {
        color: #444;
        cursor: not-allowed;
      }

      /* 메인 콘텐츠 */
      .main-content {
        margin-left: 200px;
        flex: 1;
        padding: 30px 40px;
      }

      .page-title {
        color: #00ff88;
        font-size: 28px;
        margin-bottom: 8px;
      }

      .page-description {
        color: #666;
        margin-bottom: 20px;
      }

      .settings-info {
        background-color: #1a1a1a;
        padding: 12px 20px;
        border-radius: 6px;
        margin-bottom: 25px;
        font-size: 14px;
      }

      .settings-info span {
        color: #00ff88;
      }

      /* 탭 */
      .tabs {
        display: flex;
        gap: 5px;
        margin-bottom: 20px;
        border-bottom: 1px solid #333;
        padding-bottom: 0;
      }

      .tab {
        padding: 12px 20px;
        cursor: pointer;
        color: #888;
        font-size: 14px;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .tab:hover {
        color: #fff;
      }

      .tab.active {
        color: #00ff88;
        border-bottom-color: #00ff88;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* 업로드 영역 */
      .upload-area {
        border: 2px dashed #00ff88;
        border-radius: 12px;
        padding: 50px;
        text-align: center;
        background-color: rgba(0, 255, 136, 0.03);
        margin-bottom: 30px;
        transition: all 0.3s;
        cursor: pointer;
      }

      .upload-area:hover {
        background-color: rgba(0, 255, 136, 0.08);
        cursor: pointer;
      }

      .upload-area.dragover {
        background-color: rgba(0, 255, 136, 0.15);
        border-color: #00ff88;
      }

      .upload-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .upload-text {
        font-size: 16px;
        margin-bottom: 8px;
      }

      .upload-hint {
        color: #666;
        font-size: 13px;
      }

      .file-info {
        background-color: rgba(0, 255, 136, 0.1);
        border-radius: 8px;
        padding: 15px 20px;
        margin-top: 20px;
        display: none;
      }

      .file-info.show {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .file-name {
        color: #00ff88;
        font-weight: 500;
      }

      .file-size {
        color: #888;
        font-size: 13px;
      }

      /* 버튼 */
      .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .btn {
        padding: 14px 30px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background-color: #00ff88;
        color: #000;
      }

      .btn-primary:hover {
        background-color: #00cc6a;
        transform: translateY(-1px);
      }

      .btn-primary:disabled {
        background-color: #333;
        color: #666;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background-color: #8b7500;
        color: #fff;
      }

      .btn-secondary:hover {
        background-color: #a08600;
      }

      .btn-secondary:disabled {
        background-color: #333;
        color: #666;
        cursor: not-allowed;
      }

      .btn-outline {
        background-color: transparent;
        border: 1px solid #444;
        color: #888;
      }

      .btn-outline:hover {
        border-color: #00ff88;
        color: #00ff88;
      }

      /* 스타배송 필터링 체크박스 */
      .star-filter-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 10px 16px;
        background-color: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        transition: all 0.2s;
        user-select: none;
      }

      .star-filter-checkbox:hover {
        border-color: #ffd700;
        background-color: #222;
      }

      .star-filter-checkbox input[type="checkbox"] {
        display: none;
      }

      .star-filter-checkbox .checkmark {
        width: 18px;
        height: 18px;
        border: 2px solid #555;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .star-filter-checkbox input:checked + .checkmark {
        background-color: #ffd700;
        border-color: #ffd700;
      }

      .star-filter-checkbox input:checked + .checkmark::after {
        content: "✓";
        color: #000;
        font-size: 12px;
        font-weight: bold;
      }

      .star-filter-checkbox .checkbox-label {
        color: #888;
        font-size: 14px;
        transition: color 0.2s;
      }

      .star-filter-checkbox:hover .checkbox-label,
      .star-filter-checkbox input:checked ~ .checkbox-label {
        color: #ffd700;
      }

      /* 로딩 스피너 */
      /* [수정] 트렌디한 글래스모피즘 로딩 스타일 */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* 배경: 아주 옅은 검정 투명 + 블러 처리 */
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(15px); /* 배경 흐림 효과 (글래스모피즘) */
        -webkit-backdrop-filter: blur(15px); /* 사파리 호환 */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .progress-container {
        position: relative;
        width: 120px;
        height: 120px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .progress-ring {
        transform: rotate(-90deg);
      }

      .progress-ring__circle {
        stroke-dasharray: 327;
        stroke-dashoffset: 327;
        transition: stroke-dashoffset 0.1s ease;
        stroke-linecap: round;
        /* 여기서 색상을 지정하지 않고 HTML에서 직접 제어하거나 아래에서 덮어씌움 */
      }

      /* 중앙 텍스트 컨테이너 */
      .progress-text-container {
        position: absolute;
        text-align: center;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .loading-label {
        font-size: 14px;
        color: #fff; /* 흰색으로 변경하여 가독성 확보 */
        font-weight: 500;
        margin-bottom: 2px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .loading-percent {
        font-size: 18px;
        font-weight: bold;
        color: #00ff88; /* 시그니처 네온 컬러 적용 */
        font-family: "Roboto", sans-serif;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.3); /* 네온 빛 효과 추가 */
      }

      /* 결과 모달 */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.85);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .modal-overlay.show {
        display: flex;
      }

      .modal {
        background-color: #1a1a1a;
        border-radius: 16px;
        padding: 30px;
        min-width: 450px;
        max-width: 550px;
        border: 1px solid #333;
      }

      .modal-header {
        text-align: center;
        margin-bottom: 25px;
      }

      .modal-icon {
        font-size: 60px;
        margin-bottom: 15px;
      }

      .modal-title {
        font-size: 24px;
        color: #00ff88;
        margin-bottom: 5px;
      }

      .modal-subtitle {
        color: #888;
        font-size: 14px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 25px;
      }

      .stat-card {
        background-color: #222;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
      }

      .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #00ff88;
      }

      .stat-value.warning {
        color: #ff6b6b;
      }

      .stat-label {
        color: #888;
        font-size: 13px;
        margin-top: 5px;
      }

      .accuracy-bar {
        background-color: #222;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 25px;
      }

      .accuracy-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      .accuracy-label {
        color: #888;
        font-size: 14px;
      }

      .accuracy-value {
        color: #00ff88;
        font-weight: bold;
        font-size: 18px;
      }

      .progress-bar {
        height: 10px;
        background-color: #333;
        border-radius: 5px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #00ff88, #00cc6a);
        border-radius: 5px;
        transition: width 0.5s ease;
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      /* 결과 분석 탭 */
      .analysis-container {
        background-color: #1a1a1a;
        border-radius: 12px;
        padding: 25px;
      }

      .analysis-header {
        margin-bottom: 20px;
      }

      .analysis-title {
        font-size: 18px;
        color: #00ff88;
        margin-bottom: 5px;
      }

      .analysis-desc {
        color: #666;
        font-size: 14px;
      }

      .no-data {
        text-align: center;
        padding: 60px;
        color: #666;
      }

      .no-data-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .worker-stats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }

      .worker-card {
        background-color: #222;
        border-radius: 10px;
        padding: 20px;
        transition: all 0.2s;
      }

      .worker-card:hover {
        background-color: #2a2a2a;
        transform: translateY(-2px);
      }

      .worker-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }

      .worker-icon {
        font-size: 24px;
      }

      .worker-name {
        font-size: 16px;
        font-weight: 500;
      }

      .worker-count {
        font-size: 28px;
        font-weight: bold;
        color: #00ff88;
      }

      .worker-stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #333;
      }

      .worker-stat-row:last-child {
        border-bottom: none;
      }

      .worker-label {
        color: #888;
        font-size: 14px;
      }

      .worker-value {
        color: #00ff88;
        font-size: 16px;
        font-weight: bold;
      }

      .worker-range {
        color: #00ff88;
        font-size: 14px;
        font-family: "SF Mono", "Monaco", "Consolas", monospace;
      }

      /* 담당자 관리 탭 */
      .workers-list {
        background-color: #1a1a1a;
        border-radius: 12px;
        padding: 20px;
      }

      .worker-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #333;
      }

      .worker-item:last-child {
        border-bottom: none;
      }

      .worker-item-icon {
        font-size: 24px;
        margin-right: 15px;
      }

      .worker-item-info {
        flex: 1;
      }

      .worker-item-name {
        font-weight: 500;
        margin-bottom: 3px;
      }

      .worker-item-desc {
        color: #666;
        font-size: 13px;
      }

      .worker-item-count {
        background-color: #222;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 13px;
        color: #00ff88;
      }

      /* 알림 토스트 */
      .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background-color: #222;
        border: 1px solid #333;
        border-radius: 10px;
        padding: 15px 25px;
        display: none;
        align-items: center;
        gap: 12px;
        z-index: 1001;
        animation: slideIn 0.3s ease;
      }

      .toast.show {
        display: flex;
      }

      .toast.success {
        border-color: #00ff88;
      }

      .toast.error {
        border-color: #ff6b6b;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* ==================== 원가 마진표 스타일 ==================== */
      .margin-container {
        max-width: 100%;
      }

      .margin-header {
        margin-bottom: 20px;
      }

      .search-container {
        background-color: #1a1a1a;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .search-box {
        display: flex;
        align-items: center;
        background-color: #222;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 12px 16px;
        gap: 10px;
        transition: all 0.2s;
      }

      .search-box:focus-within {
        border-color: #00ff88;
      }

      .search-icon {
        font-size: 18px;
      }

      .search-input {
        flex: 1;
        background: none;
        border: none;
        color: #e0e0e0;
        font-size: 16px;
        outline: none;
      }

      .search-input::placeholder {
        color: #666;
      }

      .search-clear {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        font-size: 16px;
        padding: 4px;
      }

      .search-clear:hover {
        color: #fff;
      }

      .search-result-count {
        margin-top: 12px;
        color: #888;
        font-size: 14px;
      }

      .table-container {
        background-color: #1a1a1a;
        border-radius: 12px;
        overflow: hidden;
      }

      .loading-data {
        text-align: center;
        padding: 60px;
        color: #666;
      }

      .margin-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .margin-table thead {
        background-color: #222;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .margin-table th {
        padding: 14px 12px;
        text-align: left;
        color: #00ff88;
        font-weight: 500;
        border-bottom: 2px solid #333;
        white-space: nowrap;
      }

      .margin-table td {
        padding: 12px;
        border-bottom: 1px solid #2a2a2a;
        color: #e0e0e0;
      }

      .margin-table tbody tr:hover {
        background-color: #222;
      }

      .margin-table .col-name {
        min-width: 200px;
        max-width: 300px;
      }

      .margin-table .col-num {
        text-align: right;
        white-space: nowrap;
      }

      .margin-table .col-center {
        text-align: center;
      }

      .margin-table .highlight {
        color: #00ff88;
        font-weight: 500;
      }

      .margin-table .stock-yes {
        color: #00ff88;
      }

      .margin-table .stock-no {
        color: #ff6b6b;
      }

      .no-results {
        text-align: center;
        padding: 60px;
        color: #666;
      }

      .no-results-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      /* 카드 뷰 (모바일용) */
      .margin-cards {
        display: none;
      }

      .margin-card {
        background-color: #222;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
      }

      .margin-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
        gap: 10px;
      }

      .margin-card-name {
        font-size: 15px;
        font-weight: 500;
        color: #fff;
        flex: 1;
        word-break: keep-all;
      }

      .margin-card-stock {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 4px;
        white-space: nowrap;
      }

      .margin-card-stock.yes {
        background-color: rgba(0, 255, 136, 0.15);
        color: #00ff88;
      }

      .margin-card-stock.no {
        background-color: rgba(255, 107, 107, 0.15);
        color: #ff6b6b;
      }

      .margin-card-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .margin-card-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .margin-card-label {
        font-size: 11px;
        color: #666;
      }

      .margin-card-value {
        font-size: 14px;
        color: #e0e0e0;
      }

      .margin-card-value.highlight {
        color: #00ff88;
        font-weight: 600;
      }

      .margin-card-divider {
        border-top: 1px solid #333;
        margin: 12px 0;
      }

      .margin-card-note {
        font-size: 12px;
        color: #888;
        margin-top: 8px;
      }

      /* 반응형 - 태블릿 */
      @media (max-width: 1024px) {
        .margin-table .col-name {
          min-width: 150px;
        }

        .margin-table th,
        .margin-table td {
          padding: 10px 8px;
          font-size: 13px;
        }
      }

      /* 반응형 - 모바일 */
      @media (max-width: 768px) {
        .sidebar {
          display: none;
        }

        .main-content {
          margin-left: 0;
          padding: 15px;
        }

        .page-title {
          font-size: 22px;
        }

        .search-container {
          padding: 15px;
        }

        .search-box {
          padding: 10px 14px;
        }

        .search-input {
          font-size: 16px; /* iOS 줌 방지 */
        }

        /* 모바일에서 카드 뷰 표시 */
        .table-wrapper {
          display: none;
        }

        .margin-cards {
          display: block;
          padding: 15px;
        }

        .margin-card-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        /* 모바일 네비게이션 */
        .mobile-nav {
          display: flex;
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: #111;
          border-top: 1px solid #222;
          z-index: 100;
          padding: 8px 0;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }

        .mobile-nav-item {
          flex: 0 0 auto;
          min-width: 60px;
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 8px 12px;
          color: #666;
          text-decoration: none;
          font-size: 10px;
          gap: 4px;
        }

        .mobile-nav-item.active {
          color: #00ff88;
        }

        .mobile-nav-icon {
          font-size: 18px;
        }

        body {
          padding-bottom: 70px;
        }
      }

      /* 테이블 래퍼 */
      .table-wrapper {
        overflow-x: auto;
        max-height: 70vh;
      }

      /* 유저 프로필 */
      .user-profile {
        position: fixed;
        top: 20px;
        right: 30px;
        z-index: 100;
      }

      .user-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background-color: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 10px 16px;
        color: #e0e0e0;
        cursor: pointer;
        transition: all 0.2s;
      }

      .user-btn:hover {
        background-color: #222;
        border-color: #00ff88;
      }

      .user-icon {
        font-size: 18px;
      }

      .user-name {
        font-size: 14px;
      }

      .user-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background-color: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        overflow: hidden;
        min-width: 150px;
      }

      .user-dropdown.show {
        display: block;
      }

      .logout-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        padding: 12px 16px;
        background: none;
        border: none;
        color: #ff6b6b;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }

      .logout-btn:hover {
        background-color: rgba(255, 107, 107, 0.1);
      }

      @media (max-width: 768px) {
        .user-profile {
          top: 15px;
          right: 15px;
        }

        .user-btn {
          padding: 8px 12px;
        }

        .user-name {
          display: none;
        }
      }

      /* ==================== 종합 계산기 스타일 ==================== */
      .calc-container {
        max-width: 800px;
      }

      .calc-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
      }

      .calc-tab {
        flex: 1;
        padding: 14px 20px;
        background-color: #1a1a1a;
        border: 1px solid #333;
        border-radius: 10px;
        color: #888;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .calc-tab:hover {
        background-color: #222;
        color: #fff;
      }

      .calc-tab.active {
        background-color: rgba(0, 255, 136, 0.1);
        border-color: #00ff88;
        color: #00ff88;
      }

      .calc-content {
        display: none;
      }

      .calc-content.active {
        display: block;
      }

      .calc-card {
        background-color: #1a1a1a;
        border-radius: 16px;
        padding: 30px;
      }

      .calc-header {
        margin-bottom: 25px;
      }

      .calc-header h3 {
        font-size: 20px;
        color: #fff;
        margin-bottom: 8px;
      }

      .calc-header p {
        color: #666;
        font-size: 14px;
      }

      .calc-inputs {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 25px;
      }

      .input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .input-group label {
        color: #888;
        font-size: 14px;
      }

      .input-wrapper {
        display: flex;
        align-items: center;
        background-color: #222;
        border: 1px solid #333;
        border-radius: 8px;
        overflow: hidden;
        transition: border-color 0.2s;
      }

      .input-wrapper:focus-within {
        border-color: #00ff88;
      }

      .input-wrapper input {
        flex: 1;
        padding: 14px 16px;
        background: none;
        border: none;
        color: #fff;
        font-size: 16px;
        outline: none;
      }

      .input-wrapper input::placeholder {
        color: #555;
      }

      .input-suffix {
        padding-right: 16px;
        color: #666;
        font-size: 14px;
      }

      .calc-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #00ff88, #00cc6a);
        border: none;
        border-radius: 10px;
        color: #000;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }

      .calc-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
      }

      .calc-results {
        margin-top: 30px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .result-card {
        background-color: #222;
        border-radius: 12px;
        padding: 20px;
        border-left: 4px solid #333;
      }

      .result-card.coupang {
        border-left-color: #ff6b35;
      }

      .result-card.smartstore {
        border-left-color: #03c75a;
      }

      .result-card.esm {
        border-left-color: #4a90d9;
      }

      .result-platform {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .platform-icon {
        font-size: 20px;
      }

      .platform-name {
        font-size: 16px;
        font-weight: 500;
        color: #fff;
      }

      .platform-fee {
        margin-left: auto;
        font-size: 12px;
        color: #666;
        background-color: #333;
        padding: 4px 10px;
        border-radius: 20px;
      }

      .result-values {
        display: flex;
        gap: 30px;
      }

      .result-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .result-label {
        font-size: 13px;
        color: #666;
      }

      .result-value {
        font-size: 22px;
        font-weight: 600;
        color: #e0e0e0;
      }

      .result-value.highlight {
        color: #00ff88;
      }

      .result-value.negative {
        color: #ff6b6b;
      }

      /* 슬라이더 스타일 */
      .slider-container {
        background-color: #222;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
      }

      .slider-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .slider-header label {
        color: #888;
        font-size: 14px;
      }

      .slider-value {
        font-size: 24px;
        font-weight: 700;
        color: #00ff88;
      }

      .margin-slider {
        width: 100%;
        height: 8px;
        -webkit-appearance: none;
        background: linear-gradient(
          to right,
          #333 0%,
          #00ff88 var(--value, 20%),
          #333 var(--value, 20%)
        );
        border-radius: 4px;
        outline: none;
        cursor: pointer;
      }

      .margin-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 24px;
        height: 24px;
        background: #00ff88;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 255, 136, 0.4);
        transition: transform 0.2s;
      }

      .margin-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
      }

      .margin-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        background: #00ff88;
        border-radius: 50%;
        cursor: pointer;
        border: none;
      }

      .slider-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        font-size: 12px;
        color: #555;
      }

      .price-results {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
      }

      .price-result-card {
        background-color: #222;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        border-top: 3px solid #333;
        transition: transform 0.2s;
      }

      .price-result-card:hover {
        transform: translateY(-3px);
      }

      .price-result-card.coupang {
        border-top-color: #ff6b35;
      }

      .price-result-card.smartstore {
        border-top-color: #03c75a;
      }

      .price-result-card.esm {
        border-top-color: #4a90d9;
      }

      .price-platform {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 12px;
        font-size: 14px;
        color: #888;
      }

      .price-value {
        font-size: 26px;
        font-weight: 700;
        color: #00ff88;
        margin-bottom: 8px;
      }

      .price-note {
        font-size: 12px;
        color: #555;
      }

      /* 반응형 - 태블릿 */
      @media (max-width: 1024px) {
        .calc-container {
          max-width: 100%;
        }

        .price-results {
          grid-template-columns: repeat(3, 1fr);
          gap: 10px;
        }
      }

      /* 반응형 - 모바일 */
      @media (max-width: 768px) {
        .calc-container {
          padding: 0;
        }

        .calc-tabs {
          flex-direction: row;
          gap: 8px;
        }

        .calc-tab {
          padding: 12px 10px;
          font-size: 13px;
          gap: 5px;
        }

        .calc-card {
          padding: 20px 15px;
          border-radius: 12px;
        }

        .calc-header h3 {
          font-size: 18px;
        }

        .calc-header p {
          font-size: 13px;
        }

        .calc-inputs {
          grid-template-columns: 1fr 1fr;
          gap: 12px;
        }

        .input-group label {
          font-size: 13px;
        }

        .input-wrapper input {
          padding: 12px 14px;
          font-size: 16px; /* iOS 줌 방지 */
        }

        .input-suffix {
          font-size: 13px;
          padding-right: 12px;
        }

        .calc-btn {
          padding: 14px;
          font-size: 15px;
        }

        .result-card {
          padding: 16px;
        }

        .result-platform {
          flex-wrap: wrap;
          gap: 8px;
          margin-bottom: 12px;
        }

        .platform-name {
          font-size: 15px;
        }

        .platform-fee {
          font-size: 11px;
          padding: 3px 8px;
        }

        .result-values {
          flex-direction: row;
          justify-content: space-between;
          gap: 15px;
        }

        .result-item {
          flex: 1;
        }

        .result-label {
          font-size: 12px;
        }

        .result-value {
          font-size: 20px;
        }

        /* 슬라이더 모바일 최적화 */
        .slider-container {
          padding: 16px;
        }

        .slider-header {
          margin-bottom: 20px;
        }

        .slider-value {
          font-size: 28px;
        }

        .margin-slider {
          height: 10px;
        }

        .margin-slider::-webkit-slider-thumb {
          width: 28px;
          height: 28px;
        }

        .margin-slider::-moz-range-thumb {
          width: 28px;
          height: 28px;
        }

        .slider-labels {
          margin-top: 12px;
          font-size: 11px;
        }

        /* 판매가 결과 카드 */
        .price-results {
          grid-template-columns: 1fr;
          gap: 12px;
        }

        .price-result-card {
          padding: 16px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          text-align: left;
        }

        .price-platform {
          margin-bottom: 0;
          font-size: 13px;
        }

        .price-value {
          font-size: 22px;
          margin-bottom: 0;
        }

        .price-note {
          display: none;
        }
      }

      /* 반응형 - 작은 모바일 */
      @media (max-width: 400px) {
        .calc-inputs {
          grid-template-columns: 1fr;
        }

        .result-values {
          flex-direction: column;
          gap: 12px;
        }

        .result-value {
          font-size: 24px;
        }

        .price-result-card {
          flex-direction: column;
          text-align: center;
          gap: 8px;
        }

        .price-value {
          font-size: 26px;
        }

        .price-note {
          display: block;
        }
      }

      /* ==================== 홈 대시보드 스타일 ==================== */
      .home-dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-top: 24px;
      }

      .dashboard-card {
        background: linear-gradient(145deg, #151515 0%, #0d0d0d 100%);
        border: 1px solid #222;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        height: 520px;
        overflow: hidden;
      }

      .dashboard-card-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #1a1a1a 0%, #151515 100%);
        border-bottom: 1px solid #2a2a2a;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
      }

      .dashboard-card-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 15px;
        font-weight: 600;
        color: #fff;
      }

      .dashboard-card-title .icon {
        font-size: 18px;
      }

      .dashboard-card-badge {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
        color: #fff;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
      }

      .dashboard-card-actions {
        display: flex;
        gap: 8px;
      }

      .dashboard-add-btn {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        border: none;
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        color: #000;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      .dashboard-add-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
      }

      .dashboard-card-body {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
      }

      .dashboard-card-body::-webkit-scrollbar {
        width: 5px;
      }

      .dashboard-card-body::-webkit-scrollbar-track {
        background: #1a1a1a;
      }

      .dashboard-card-body::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 3px;
      }

      /* 메모 아이템 */
      .memo-item {
        background: #1a1a1a;
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        padding: 14px 16px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .memo-item:hover {
        background: #222;
        border-color: #333;
        transform: translateY(-2px);
      }

      .memo-item.pinned {
        border-color: #00ff88;
        background: linear-gradient(145deg, #1a2a1f 0%, #1a1a1a 100%);
      }

      .memo-item-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
      }

      .memo-pin-icon {
        color: #00ff88;
        font-size: 12px;
      }

      .memo-title {
        font-size: 14px;
        font-weight: 600;
        color: #fff;
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .memo-content {
        font-size: 13px;
        color: #888;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.5;
      }

      .memo-date {
        font-size: 11px;
        color: #555;
        margin-top: 8px;
      }

      /* 품절상품 아이템 */
      .stock-item {
        background: #1a1a1a;
        border: 1px solid #2a2a2a;
        border-radius: 10px;
        padding: 12px 14px;
        margin-bottom: 8px;
        transition: all 0.2s;
      }

      .stock-item:hover {
        background: #222;
        border-color: #333;
      }

      .stock-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .stock-product-name {
        font-size: 14px;
        font-weight: 500;
        color: #fff;
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .stock-item-actions {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .stock-item:hover .stock-item-actions {
        opacity: 1;
      }

      .stock-action-btn {
        width: 26px;
        height: 26px;
        border-radius: 6px;
        border: none;
        background: #333;
        color: #888;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .stock-action-btn:hover {
        background: #444;
        color: #fff;
      }

      .stock-action-btn.restock:hover {
        background: #00ff88;
        color: #000;
      }

      .stock-action-btn.delete:hover {
        background: #ff6b6b;
        color: #fff;
      }

      .stock-dates {
        display: flex;
        gap: 16px;
        font-size: 12px;
      }

      .stock-date-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .stock-date-label {
        color: #666;
      }

      .stock-date-value {
        color: #ff6b6b;
      }

      .stock-date-value.restock {
        color: #00ff88;
      }

      .stock-date-value.pending {
        color: #ffd700;
      }

      /* 요청 알림 아이템 */
      .request-item {
        background: linear-gradient(145deg, #2a2520 0%, #1a1a1a 100%);
        border: 1px solid #3a3530;
        border-left: 3px solid #ffd700;
        border-radius: 10px;
        padding: 14px 16px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .request-item:hover {
        background: linear-gradient(145deg, #352f28 0%, #222 100%);
        transform: translateX(3px);
      }

      .request-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .request-employee {
        font-size: 14px;
        font-weight: 600;
        color: #ffd700;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .request-time {
        font-size: 11px;
        color: #666;
      }

      .request-detail {
        font-size: 13px;
        color: #aaa;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .request-detail span {
        color: #888;
      }

      /* 빈 상태 */
      .dashboard-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 50px 20px;
        text-align: center;
      }

      .dashboard-empty-icon {
        font-size: 40px;
        margin-bottom: 12px;
        opacity: 0.4;
      }

      .dashboard-empty-text {
        color: #555;
        font-size: 14px;
      }

      /* 메모 모달 */
      .memo-modal-content {
        padding: 0;
      }

      .memo-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid #2a2a2a;
      }

      .memo-modal-title-input {
        flex: 1;
        background: transparent;
        border: none;
        font-size: 20px;
        font-weight: 600;
        color: #fff;
        outline: none;
      }

      .memo-modal-title-input::placeholder {
        color: #555;
      }

      .memo-modal-actions {
        display: flex;
        gap: 8px;
      }

      .memo-modal-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: none;
        background: #222;
        color: #888;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
      }

      .memo-modal-btn:hover {
        background: #333;
        color: #fff;
      }

      .memo-modal-btn.pin.active {
        background: rgba(0, 255, 136, 0.2);
        color: #00ff88;
      }

      .memo-modal-btn.delete:hover {
        background: rgba(255, 107, 107, 0.2);
        color: #ff6b6b;
      }

      .memo-modal-body {
        padding: 20px 24px;
        min-height: 250px;
      }

      .memo-textarea {
        width: 100%;
        min-height: 200px;
        background: transparent;
        border: none;
        color: #e0e0e0;
        font-size: 15px;
        line-height: 1.7;
        resize: none;
        outline: none;
      }

      .memo-textarea::placeholder {
        color: #444;
      }

      .memo-modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        border-top: 1px solid #2a2a2a;
        background: #151515;
      }

      .memo-date-info {
        font-size: 12px;
        color: #555;
      }

      .memo-save-btn {
        padding: 10px 24px;
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        border: none;
        border-radius: 8px;
        color: #000;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .memo-save-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
      }

      /* 품절상품 모달 */
      .stock-form-group {
        margin-bottom: 20px;
      }

      .stock-form-label {
        display: block;
        font-size: 13px;
        color: #888;
        margin-bottom: 8px;
      }

      .stock-form-input {
        width: 100%;
        padding: 12px 16px;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        color: #fff;
        font-size: 15px;
        outline: none;
        transition: border-color 0.2s;
      }

      .stock-form-input:focus {
        border-color: #00ff88;
      }

      .stock-form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      /* 홈 대시보드 반응형 */
      @media (max-width: 1200px) {
        .home-dashboard {
          grid-template-columns: 1fr 1fr;
        }
        .dashboard-card:last-child {
          grid-column: span 2;
        }
      }

      @media (max-width: 768px) {
        .home-dashboard {
          grid-template-columns: 1fr;
        }
        .dashboard-card {
          height: 400px;
        }
        .dashboard-card:last-child {
          grid-column: span 1;
        }
      }

      /* ==================== 도착보장 입고내역서 스타일 ==================== */
      .arrival-container {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 25px;
      }

      @media (max-width: 1024px) {
        .arrival-container {
          grid-template-columns: 1fr;
        }
      }

      .arrival-main {
        background: #111;
        border: 1px solid #222;
        border-radius: 12px;
        padding: 25px;
      }

      .arrival-sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .arrival-card {
        background: #111;
        border: 1px solid #222;
        border-radius: 12px;
        padding: 20px;
      }

      .arrival-card-title {
        color: #00ff88;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .delivery-type-toggle {
        display: flex;
        background: #1a1a1a;
        border-radius: 8px;
        padding: 4px;
        gap: 4px;
      }

      .delivery-type-btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        background: transparent;
        color: #666;
      }

      .delivery-type-btn.active {
        background: #00ff88;
        color: #000;
      }

      .delivery-type-btn:not(.active):hover {
        background: #222;
        color: #fff;
      }

      .mini-calendar {
        margin-top: 15px;
        background: #1a1a1a;
        border-radius: 8px;
        padding: 15px;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .calendar-nav {
        background: none;
        border: none;
        color: #888;
        font-size: 18px;
        cursor: pointer;
        padding: 5px 10px;
        transition: color 0.2s;
      }

      .calendar-nav:hover {
        color: #00ff88;
      }

      .calendar-month {
        color: #fff;
        font-weight: 600;
        font-size: 14px;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        text-align: center;
      }

      .calendar-day-header {
        color: #666;
        font-size: 12px;
        padding: 5px;
      }

      .calendar-day {
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        color: #888;
        transition: all 0.2s;
      }

      .calendar-day:hover {
        background: #333;
        color: #fff;
      }

      .calendar-day.selected {
        background: #00ff88;
        color: #000;
      }

      .calendar-day.today {
        border: 1px solid #00ff88;
      }

      .calendar-day.other-month {
        color: #444;
      }

      .arrival-form-group {
        margin-bottom: 20px;
      }

      .arrival-form-label {
        display: block;
        color: #888;
        font-size: 13px;
        margin-bottom: 8px;
      }

      .arrival-form-input {
        width: 100%;
        padding: 12px 16px;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        color: #e0e0e0;
        font-size: 14px;
        transition: border-color 0.2s;
      }

      .arrival-form-input:focus {
        outline: none;
        border-color: #00ff88;
      }

      .arrival-form-input:read-only {
        background: #0d0d0d;
        color: #666;
      }

      .product-select {
        width: 100%;
        padding: 12px 16px;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        color: #e0e0e0;
        font-size: 14px;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
      }

      .product-select:focus {
        outline: none;
        border-color: #00ff88;
      }

      .added-products-list {
        margin-top: 20px;
        border-top: 1px solid #222;
        padding-top: 20px;
      }

      .added-product-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 15px;
        background: #1a1a1a;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .added-product-info {
        flex: 1;
      }

      .added-product-name {
        color: #fff;
        font-size: 14px;
        margin-bottom: 4px;
      }

      .added-product-detail {
        color: #666;
        font-size: 12px;
      }

      .added-product-remove {
        background: none;
        border: none;
        color: #ff6b6b;
        cursor: pointer;
        font-size: 18px;
        padding: 5px;
        transition: color 0.2s;
      }

      .added-product-remove:hover {
        color: #ff4444;
      }

      .arrival-btn-group {
        display: flex;
        gap: 10px;
        margin-top: 25px;
      }

      .arrival-btn {
        flex: 1;
        padding: 14px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .arrival-btn-primary {
        background: #00ff88;
        color: #000;
      }

      .arrival-btn-primary:hover {
        background: #00cc6a;
      }

      .arrival-btn-secondary {
        background: #333;
        color: #fff;
      }

      .arrival-btn-secondary:hover {
        background: #444;
      }

      .arrival-btn-outline {
        background: transparent;
        border: 1px solid #444;
        color: #888;
      }

      .arrival-btn-outline:hover {
        border-color: #00ff88;
        color: #00ff88;
      }

      .separate-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        padding: 12px 15px;
        background: #1a1a1a;
        border-radius: 8px;
      }

      .separate-checkbox input {
        accent-color: #00ff88;
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .separate-checkbox label {
        color: #888;
        font-size: 13px;
        cursor: pointer;
      }

      .customer-id-section {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .customer-id-input {
        flex: 1;
        padding: 10px 14px;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 6px;
        color: #e0e0e0;
        font-size: 14px;
      }

      .customer-id-input:focus {
        outline: none;
        border-color: #00ff88;
      }

      .customer-id-save {
        padding: 10px 16px;
        background: #00ff88;
        color: #000;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }

      .customer-id-save:hover {
        background: #00cc6a;
      }

      .product-manage-table {
        width: 100%;
        border-collapse: collapse;
      }

      .product-manage-table th,
      .product-manage-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #222;
      }

      .product-manage-table th {
        background: #1a1a1a;
        color: #888;
        font-size: 13px;
        font-weight: 600;
      }

      .product-manage-table td {
        color: #e0e0e0;
        font-size: 14px;
      }

      .product-manage-table tr:hover td {
        background: #1a1a1a;
      }

      .product-action-btn {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 5px 8px;
        font-size: 13px;
        transition: color 0.2s;
      }

      .product-action-btn:hover {
        color: #00ff88;
      }

      .product-action-btn.delete:hover {
        color: #ff6b6b;
      }

      .add-product-row {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .add-product-row input {
        flex: 1;
        padding: 10px 14px;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 6px;
        color: #e0e0e0;
        font-size: 14px;
      }

      .add-product-row input:focus {
        outline: none;
        border-color: #00ff88;
      }

      /* ==================== 박스 재고 파악 스타일 ==================== */
      .box-inventory-container {
        background: #111;
        border: 1px solid #222;
        border-radius: 12px;
        overflow: hidden;
      }

      .box-inventory-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #222;
        background: #0d0d0d;
      }

      .box-inventory-title {
        font-size: 16px;
        font-weight: 600;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .box-inventory-actions {
        display: flex;
        gap: 10px;
      }

      .box-inventory-table-wrapper {
        overflow-x: auto;
        max-height: calc(100vh - 280px);
        overflow-y: auto;
      }

      .box-inventory-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1100px;
      }

      .box-inventory-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .box-inventory-table th {
        background: linear-gradient(180deg, #1a2a1f 0%, #0f1a14 100%);
        color: #00ff88;
        font-size: 11px;
        font-weight: 700;
        padding: 14px 4px;
        text-align: center;
        border-bottom: 2px solid #00ff88;
        white-space: nowrap;
        user-select: none;
        letter-spacing: 0.5px;
      }

      .box-inventory-table th.stock-col {
        color: #00ff88;
        background: linear-gradient(180deg, #1a3a1f 0%, #0f1a14 100%);
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
      }

      .box-inventory-table td {
        padding: 2px;
        border-bottom: 1px solid #1a1a1a;
        vertical-align: middle;
        text-align: center;
      }

      .box-inventory-table tr:hover td {
        background: #1a1a1a;
      }

      .box-inventory-table tr.new-row td {
        background: rgba(0, 255, 136, 0.05);
      }

      .box-input {
        width: 100%;
        padding: 8px 4px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        color: #e0e0e0;
        font-size: 12px;
        transition: all 0.2s;
        text-align: center;
      }

      .box-input:hover {
        background: #1a1a1a;
      }

      .box-input:focus {
        outline: none;
        background: #0d0d0d;
        border-color: #00ff88;
        box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
      }

      .box-input.number-input {
        text-align: right;
        font-family: "SF Mono", "Consolas", monospace;
      }

      .box-input.stock-input {
        color: #00ff88;
        font-weight: 600;
      }

      .box-select {
        width: 100%;
        padding: 8px 4px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        color: #e0e0e0;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        appearance: none;
        text-align: center;
        text-align-last: center;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 4px center;
        padding-right: 18px;
      }

      .box-select:hover {
        background-color: #1a1a1a;
      }

      .box-select:focus {
        outline: none;
        background-color: #0d0d0d;
        border-color: #00ff88;
      }

      .box-select option {
        background: #1a1a1a;
        color: #e0e0e0;
        padding: 8px;
      }

      .box-delete-btn {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: #666;
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 14px;
      }

      .box-delete-btn:hover {
        background: rgba(255, 107, 107, 0.1);
        color: #ff6b6b;
      }

      .box-row-number {
        color: #444;
        font-size: 11px;
        text-align: center;
        font-family: "SF Mono", "Consolas", monospace;
        min-width: 32px;
      }

      .box-empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .box-empty-state .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .box-empty-state p {
        margin-bottom: 20px;
      }

      .col-row-num {
        width: 28px;
        text-align: center;
      }
      .col-name {
        width: 90px;
        max-width: 90px;
      }
      .col-spec {
        width: 95px;
        max-width: 95px;
      }
      .col-material {
        width: 55px;
      }
      .col-strength {
        width: 55px;
      }
      .col-print {
        width: 70px;
      }
      .col-price {
        width: 65px;
      }
      .col-vendor {
        width: 75px;
      }
      .col-moq {
        width: 60px;
      }
      .col-stock {
        width: 70px;
      }
      .col-action {
        width: 32px;
      }

      .btn-save-pulse {
        animation: savePulse 2s infinite;
      }

      @keyframes savePulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(0, 255, 136, 0);
        }
      }

      @keyframes rowSlideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .box-inventory-table tr.row-new {
        animation: rowSlideIn 0.3s ease;
      }

      .inventory-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: rgba(0, 255, 136, 0.1);
        border: 1px solid rgba(0, 255, 136, 0.2);
        border-radius: 20px;
        font-size: 12px;
        color: #00ff88;
      }

      .inventory-badge.warning {
        background: rgba(255, 215, 0, 0.1);
        border-color: rgba(255, 215, 0, 0.2);
        color: #ffd700;
      }
    </style>
  </head>
  <body>
    <!-- 유저 프로필 -->
    <div class="user-profile">
      <div class="user-btn" id="userBtn">
        <span class="user-icon">👤</span>
        <span class="user-name">효진유통 담당자</span>
      </div>
      <div class="user-dropdown" id="userDropdown">
        <button class="logout-btn" onclick="location.href = '/logout'">
          <span>🚪</span>
          <span>로그아웃</span>
        </button>
      </div>
    </div>

    <!-- 사이드바 -->
    <nav class="sidebar">
      <div class="logo" id="logoBtn" style="cursor: pointer">⚡ 효진유통</div>
      <div class="nav-item active" data-page="home">홈</div>
      <div class="nav-item" data-page="margin">원가 마진표</div>
      <div class="nav-item" data-page="calculator">종합 계산기</div>
      <div class="nav-item" data-page="box-inventory">📦 박스 재고 파악</div>
      <div class="nav-item" data-page="classify">송장 분류</div>
      <div class="nav-item" data-page="starfilter">스타배송 필터링</div>
      <div class="nav-item" data-page="tax-free">면세 자료 정리</div>
      <div class="nav-item" data-page="arrival-invoice">
        N배송 입고내역서 생성기
      </div>
      <div class="nav-item" data-page="employees">직원 관리</div>
      <div class="nav-item" data-page="admin-attendance">직원 출퇴근일지</div>
    </nav>

    <!-- 메인 콘텐츠 -->
    <main class="main-content">
      <!-- 홈 페이지 -->
      <section id="page-home" class="page">
        <h1 class="page-title">홈</h1>
        <p class="page-description">효진유통 업무 자동화 시스템</p>

        <!-- 3컬럼 대시보드 -->
        <div class="home-dashboard">
          <!-- 메모장 -->
          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <div class="dashboard-card-title">
                <span class="icon">📝</span>
                메모장
              </div>
              <div class="dashboard-card-actions">
                <button
                  class="dashboard-add-btn"
                  onclick="openMemoModal()"
                  title="새 메모"
                >
                  +
                </button>
              </div>
            </div>
            <div class="dashboard-card-body" id="memoList">
              <div class="dashboard-empty">
                <div class="dashboard-empty-icon">📝</div>
                <div class="dashboard-empty-text">메모가 없습니다</div>
              </div>
            </div>
          </div>

          <!-- 품절상품 리스트 -->
          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <div class="dashboard-card-title">
                <span class="icon">📦</span>
                품절상품
              </div>
              <div class="dashboard-card-actions">
                <button
                  class="dashboard-add-btn"
                  onclick="openStockModal()"
                  title="품절상품 등록"
                >
                  +
                </button>
              </div>
            </div>
            <div class="dashboard-card-body" id="stockList">
              <div class="dashboard-empty">
                <div class="dashboard-empty-icon">✅</div>
                <div class="dashboard-empty-text">품절상품이 없습니다</div>
              </div>
            </div>
          </div>

          <!-- 직원 요청 알림 -->
          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <div class="dashboard-card-title">
                <span class="icon">📬</span>
                직원 요청
              </div>
              <span
                class="dashboard-card-badge"
                id="requestBadge"
                style="display: none"
                >0</span
              >
            </div>
            <div class="dashboard-card-body" id="requestList">
              <div class="dashboard-empty">
                <div class="dashboard-empty-icon">✨</div>
                <div class="dashboard-empty-text">새로운 요청이 없습니다</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 메모 작성/수정 모달 -->
      <div class="modal-overlay" id="memoModal" style="display: none">
        <div class="modal" style="max-width: 550px; padding: 0">
          <div class="memo-modal-content">
            <div class="memo-modal-header">
              <input
                type="text"
                class="memo-modal-title-input"
                id="memoTitleInput"
                placeholder="제목을 입력하세요"
              />
              <div class="memo-modal-actions">
                <button
                  class="memo-modal-btn pin"
                  id="memoPinBtn"
                  onclick="toggleMemoPin()"
                  title="고정"
                >
                  📌
                </button>
                <button
                  class="memo-modal-btn delete"
                  id="memoDeleteBtn"
                  onclick="deleteMemoFromModal()"
                  title="삭제"
                  style="display: none"
                >
                  🗑️
                </button>
                <button
                  class="memo-modal-btn"
                  onclick="closeMemoModal()"
                  title="닫기"
                >
                  ✕
                </button>
              </div>
            </div>
            <div class="memo-modal-body">
              <textarea
                class="memo-textarea"
                id="memoContentInput"
                placeholder="내용을 입력하세요..."
              ></textarea>
            </div>
            <div class="memo-modal-footer">
              <div class="memo-date-info" id="memoDateInfo"></div>
              <button class="memo-save-btn" onclick="saveMemo()">저장</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 품절상품 등록/수정 모달 -->
      <div class="modal-overlay" id="stockModal" style="display: none">
        <div class="modal" style="max-width: 450px">
          <div class="modal-header">
            <div class="modal-icon">📦</div>
            <div class="modal-title" id="stockModalTitle">품절상품 등록</div>
          </div>
          <div style="padding: 20px 0">
            <div class="stock-form-group">
              <label class="stock-form-label">상품명 *</label>
              <input
                type="text"
                class="stock-form-input"
                id="stockProductName"
                placeholder="품절된 상품명 입력"
              />
            </div>
            <div class="stock-form-row">
              <div class="stock-form-group">
                <label class="stock-form-label">품절 날짜</label>
                <input type="date" class="stock-form-input" id="stockOutDate" />
              </div>
              <div class="stock-form-group">
                <label class="stock-form-label">재입고 예정일</label>
                <input
                  type="date"
                  class="stock-form-input"
                  id="stockRestockDate"
                />
              </div>
            </div>
            <div class="stock-form-group">
              <label class="stock-form-label">비고</label>
              <input
                type="text"
                class="stock-form-input"
                id="stockNotes"
                placeholder="추가 메모 (선택사항)"
              />
            </div>
          </div>
          <div class="modal-actions" style="display: flex; gap: 10px">
            <button
              class="btn btn-outline"
              onclick="closeStockModal()"
              style="flex: 1"
            >
              취소
            </button>
            <button
              class="btn btn-primary"
              onclick="saveStock()"
              style="flex: 1"
            >
              저장
            </button>
          </div>
        </div>
      </div>

      <!-- 수정 요청 열람 모달 -->
      <div
        class="modal-overlay"
        id="editRequestViewModal"
        style="display: none"
      >
        <div class="modal" style="max-width: 450px">
          <div class="modal-header">
            <div class="modal-icon">📝</div>
            <div class="modal-title">출퇴근 수정 요청</div>
            <div class="modal-subtitle" id="editRequestViewSubtitle"></div>
          </div>

          <div style="padding: 20px 0">
            <!-- 수정 전 -->
            <div style="margin-bottom: 20px">
              <div style="color: #888; font-size: 13px; margin-bottom: 8px">
                수정 전
              </div>
              <div style="display: flex; gap: 20px; justify-content: center">
                <div
                  style="
                    background: #222;
                    padding: 12px 25px;
                    border-radius: 8px;
                    text-align: center;
                  "
                >
                  <div style="color: #666; font-size: 12px">출근</div>
                  <div
                    id="viewOldClockIn"
                    style="color: #ff6b6b; font-size: 18px; font-weight: 600"
                  >
                    --:--
                  </div>
                </div>
                <div
                  style="
                    background: #222;
                    padding: 12px 25px;
                    border-radius: 8px;
                    text-align: center;
                  "
                >
                  <div style="color: #666; font-size: 12px">퇴근</div>
                  <div
                    id="viewOldClockOut"
                    style="color: #ff6b6b; font-size: 18px; font-weight: 600"
                  >
                    --:--
                  </div>
                </div>
              </div>
            </div>

            <!-- 화살표 -->
            <div
              style="
                text-align: center;
                color: #00ff88;
                font-size: 24px;
                margin: 15px 0;
              "
            >
              ⬇️
            </div>

            <!-- 수정 후 -->
            <div style="margin-bottom: 20px">
              <div style="color: #888; font-size: 13px; margin-bottom: 8px">
                수정 후
              </div>
              <div style="display: flex; gap: 20px; justify-content: center">
                <div
                  style="
                    background: rgba(0, 255, 136, 0.1);
                    border: 1px solid #00ff88;
                    padding: 12px 25px;
                    border-radius: 8px;
                    text-align: center;
                  "
                >
                  <div style="color: #666; font-size: 12px">출근</div>
                  <div
                    id="viewNewClockIn"
                    style="color: #00ff88; font-size: 18px; font-weight: 600"
                  >
                    --:--
                  </div>
                </div>
                <div
                  style="
                    background: rgba(0, 255, 136, 0.1);
                    border: 1px solid #00ff88;
                    padding: 12px 25px;
                    border-radius: 8px;
                    text-align: center;
                  "
                >
                  <div style="color: #666; font-size: 12px">퇴근</div>
                  <div
                    id="viewNewClockOut"
                    style="color: #00ff88; font-size: 18px; font-weight: 600"
                  >
                    --:--
                  </div>
                </div>
              </div>
            </div>

            <!-- 수정 사유 -->
            <div
              style="
                background: #1a1a1a;
                border-radius: 8px;
                padding: 15px;
                margin-top: 20px;
              "
            >
              <div style="color: #888; font-size: 13px; margin-bottom: 8px">
                📋 수정 사유
              </div>
              <div
                id="viewReason"
                style="color: #e0e0e0; font-size: 14px; line-height: 1.6"
              ></div>
            </div>
          </div>

          <div class="modal-actions" style="display: flex; gap: 10px">
            <button
              class="btn btn-outline"
              onclick="closeEditRequestViewModal()"
              style="flex: 1"
            >
              닫기
            </button>
            <button
              class="btn"
              onclick="rejectEditRequest()"
              style="flex: 1; background: #ff6b6b; color: #fff"
            >
              거절
            </button>
            <button
              class="btn btn-primary"
              onclick="approveEditRequest()"
              style="flex: 1"
            >
              수락
            </button>
          </div>
        </div>
      </div>

      <!-- 거절 사유 입력 모달 -->
      <div class="modal-overlay" id="rejectReasonModal" style="display: none">
        <div class="modal" style="max-width: 400px">
          <div class="modal-header">
            <div class="modal-icon" style="color: #ff6b6b">❌</div>
            <div class="modal-title">거절 사유 입력</div>
            <div class="modal-subtitle">거절 사유를 입력해주세요</div>
          </div>

          <div style="padding: 20px 0">
            <textarea
              id="rejectReasonInput"
              rows="4"
              placeholder="거절 사유를 입력하세요"
              style="
                width: 100%;
                padding: 12px;
                background: #1a1a1a;
                border: 1px solid #333;
                border-radius: 8px;
                color: #fff;
                font-size: 14px;
                resize: none;
              "
            ></textarea>
          </div>

          <div class="modal-actions" style="display: flex; gap: 10px">
            <button
              class="btn btn-outline"
              onclick="closeRejectReasonModal()"
              style="flex: 1"
            >
              취소
            </button>
            <button
              class="btn"
              onclick="submitRejectReason()"
              style="flex: 1; background: #ff6b6b; color: #fff"
            >
              전송
            </button>
          </div>
        </div>
      </div>

      <!-- 원가 마진표 페이지 -->
      <section id="page-margin" class="page" style="display: none">
        <div class="margin-container">
          <div class="margin-header">
            <h1 class="page-title">📊 원가 마진표</h1>
            <p class="page-description">
              상품별 원가 및 마진 정보를 조회합니다
            </p>
          </div>

          <!-- 검색 영역 -->
          <div class="search-container">
            <div
              style="
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
              "
            >
              <div class="search-box" style="flex: 1; min-width: 200px">
                <span class="search-icon">🔍</span>
                <input
                  type="text"
                  id="marginSearch"
                  class="search-input"
                  placeholder="상품명 검색..."
                  autocomplete="off"
                />
                <button
                  class="search-clear"
                  id="searchClear"
                  style="display: none"
                >
                  ✕
                </button>
              </div>
              <button
                class="btn btn-primary"
                id="addMarginBtn"
                onclick="showAddMarginModal()"
                style="white-space: nowrap; display: none"
              >
                ➕ 상품 추가
              </button>
            </div>
            <div class="search-result-count" id="resultCount">총 0개 상품</div>
          </div>

          <!-- 테이블 영역 -->
          <div class="table-container" id="marginTableContainer">
            <div class="loading-data">데이터 로딩중...</div>
          </div>
        </div>

        <!-- 원가 마진표 추가/수정 모달 (DB 연결 시에만 사용) -->
        <div class="modal-overlay" id="marginProductModal">
          <div class="modal" style="max-width: 600px">
            <div class="modal-header">
              <div class="modal-icon">📦</div>
              <div class="modal-title" id="marginModalTitle">상품 추가</div>
              <div class="modal-subtitle">원가 및 마진 정보 입력</div>
            </div>

            <div style="max-height: 400px; overflow-y: auto; padding: 0 5px">
              <div style="display: grid; grid-template-columns: 1fr; gap: 12px">
                <div>
                  <label
                    style="
                      display: block;
                      color: #888;
                      font-size: 13px;
                      margin-bottom: 5px;
                    "
                    >상품명 *</label
                  >
                  <input
                    type="text"
                    id="marginName"
                    placeholder="상품명"
                    style="
                      width: 100%;
                      padding: 12px;
                      background: #222;
                      border: 1px solid #333;
                      border-radius: 8px;
                      color: #fff;
                      font-size: 14px;
                      box-sizing: border-box;
                    "
                  />
                </div>
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 12px;
                  "
                >
                  <div>
                    <label
                      style="
                        display: block;
                        color: #888;
                        font-size: 13px;
                        margin-bottom: 5px;
                      "
                      >인상전 상품가</label
                    >
                    <input
                      type="number"
                      id="marginPrePrice"
                      placeholder="0"
                      style="
                        width: 100%;
                        padding: 12px;
                        background: #222;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        box-sizing: border-box;
                      "
                    />
                  </div>
                  <div>
                    <label
                      style="
                        display: block;
                        color: #888;
                        font-size: 13px;
                        margin-bottom: 5px;
                      "
                      >인상후 상품가</label
                    >
                    <input
                      type="number"
                      id="marginPostPrice"
                      placeholder="0"
                      style="
                        width: 100%;
                        padding: 12px;
                        background: #222;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        box-sizing: border-box;
                      "
                    />
                  </div>
                </div>
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr;
                    gap: 12px;
                  "
                >
                  <div>
                    <label
                      style="
                        display: block;
                        color: #888;
                        font-size: 13px;
                        margin-bottom: 5px;
                      "
                      >물량지원</label
                    >
                    <input
                      type="number"
                      id="marginSupply"
                      placeholder="1"
                      step="0.1"
                      style="
                        width: 100%;
                        padding: 12px;
                        background: #222;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        box-sizing: border-box;
                      "
                    />
                  </div>
                  <div>
                    <label
                      style="
                        display: block;
                        color: #888;
                        font-size: 13px;
                        margin-bottom: 5px;
                      "
                      >프로모션할인률</label
                    >
                    <input
                      type="number"
                      id="marginPromo"
                      placeholder="0"
                      step="0.01"
                      style="
                        width: 100%;
                        padding: 12px;
                        background: #222;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        box-sizing: border-box;
                      "
                    />
                  </div>
                  <div>
                    <label
                      style="
                        display: block;
                        color: #888;
                        font-size: 13px;
                        margin-bottom: 5px;
                      "
                      >장려금률</label
                    >
                    <input
                      type="number"
                      id="marginIncentive"
                      placeholder="0"
                      step="0.01"
                      style="
                        width: 100%;
                        padding: 12px;
                        background: #222;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        box-sizing: border-box;
                      "
                    />
                  </div>
                </div>
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 12px;
                  "
                >
                  <div>
                    <label
                      style="
                        display: block;
                        color: #888;
                        font-size: 13px;
                        margin-bottom: 5px;
                      "
                      >배송비</label
                    >
                    <input
                      type="number"
                      id="marginShipping"
                      placeholder="0"
                      style="
                        width: 100%;
                        padding: 12px;
                        background: #222;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        box-sizing: border-box;
                      "
                    />
                  </div>
                  <div>
                    <label
                      style="
                        display: block;
                        color: #888;
                        font-size: 13px;
                        margin-bottom: 5px;
                      "
                      >박스비</label
                    >
                    <input
                      type="number"
                      id="marginBox"
                      placeholder="0"
                      style="
                        width: 100%;
                        padding: 12px;
                        background: #222;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        box-sizing: border-box;
                      "
                    />
                  </div>
                </div>
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 12px;
                  "
                >
                  <div>
                    <label
                      style="
                        display: block;
                        color: #888;
                        font-size: 13px;
                        margin-bottom: 5px;
                      "
                      >인상전 총 원가</label
                    >
                    <input
                      type="number"
                      id="marginPreCost"
                      placeholder="0"
                      style="
                        width: 100%;
                        padding: 12px;
                        background: #222;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        box-sizing: border-box;
                      "
                    />
                  </div>
                  <div>
                    <label
                      style="
                        display: block;
                        color: #888;
                        font-size: 13px;
                        margin-bottom: 5px;
                      "
                      >인상후 총 원가</label
                    >
                    <input
                      type="number"
                      id="marginPostCost"
                      placeholder="0"
                      style="
                        width: 100%;
                        padding: 12px;
                        background: #222;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        box-sizing: border-box;
                      "
                    />
                  </div>
                </div>
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr;
                    gap: 12px;
                  "
                >
                  <div>
                    <label
                      style="
                        display: block;
                        color: #888;
                        font-size: 13px;
                        margin-bottom: 5px;
                      "
                      >인상전 재고</label
                    >
                    <select
                      id="marginStock"
                      style="
                        width: 100%;
                        padding: 12px;
                        background: #222;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        box-sizing: border-box;
                      "
                    >
                      <option value="">선택</option>
                      <option value="o">O (있음)</option>
                      <option value="x">X (없음)</option>
                    </select>
                  </div>
                  <div>
                    <label
                      style="
                        display: block;
                        color: #888;
                        font-size: 13px;
                        margin-bottom: 5px;
                      "
                      >1박스 최대 수량</label
                    >
                    <input
                      type="text"
                      id="marginBoxQty"
                      placeholder=""
                      style="
                        width: 100%;
                        padding: 12px;
                        background: #222;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        box-sizing: border-box;
                      "
                    />
                  </div>
                  <div>
                    <label
                      style="
                        display: block;
                        color: #888;
                        font-size: 13px;
                        margin-bottom: 5px;
                      "
                      >기타사항</label
                    >
                    <input
                      type="text"
                      id="marginNote"
                      placeholder=""
                      style="
                        width: 100%;
                        padding: 12px;
                        background: #222;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        box-sizing: border-box;
                      "
                    />
                  </div>
                </div>
              </div>
            </div>

            <input type="hidden" id="marginEditId" />

            <div class="modal-actions" style="margin-top: 20px">
              <button class="btn btn-primary" onclick="saveMarginProduct()">
                저장
              </button>
              <button class="btn btn-outline" onclick="closeMarginModal()">
                취소
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- 종합 계산기 페이지 -->
      <section id="page-calculator" class="page" style="display: none">
        <div class="calc-container">
          <h1 class="page-title">🧮 종합 계산기</h1>
          <p class="page-description">마진 계산 및 판매가 책정을 위한 계산기</p>

          <!-- 계산기 탭 -->
          <div class="calc-tabs">
            <button class="calc-tab active" data-calc="margin">
              💰 마진 계산기
            </button>
            <button class="calc-tab" data-calc="price">🏷️ 판매가 책정기</button>
          </div>

          <!-- 마진 계산기 -->
          <div class="calc-content active" id="calc-margin">
            <div class="calc-card">
              <div class="calc-header">
                <h3>마진 계산기</h3>
                <p>현재 판매가 기준으로 플랫폼별 마진을 계산합니다</p>
              </div>

              <div class="calc-inputs">
                <div class="input-group">
                  <label>현재 판매가</label>
                  <div class="input-wrapper">
                    <input
                      type="number"
                      id="marginSalePrice"
                      placeholder="0"
                      min="0"
                    />
                    <span class="input-suffix">원</span>
                  </div>
                </div>
                <div class="input-group">
                  <label>상품 원가</label>
                  <div class="input-wrapper">
                    <input
                      type="number"
                      id="marginCost"
                      placeholder="0"
                      min="0"
                    />
                    <span class="input-suffix">원</span>
                  </div>
                </div>
                <div class="input-group">
                  <label>배송비</label>
                  <div class="input-wrapper">
                    <input
                      type="number"
                      id="marginShipping"
                      placeholder="0"
                      min="0"
                    />
                    <span class="input-suffix">원</span>
                  </div>
                </div>
                <div class="input-group">
                  <label>박스비</label>
                  <div class="input-wrapper">
                    <input
                      type="number"
                      id="marginBox"
                      placeholder="0"
                      min="0"
                    />
                    <span class="input-suffix">원</span>
                  </div>
                </div>
              </div>

              <button class="calc-btn" onclick="calculateMargin()">
                계산하기
              </button>

              <div
                class="calc-results"
                id="marginResults"
                style="display: none"
              >
                <div class="result-card coupang">
                  <div class="result-platform">
                    <span class="platform-icon">🟠</span>
                    <span class="platform-name">쿠팡</span>
                    <span class="platform-fee">수수료 12%</span>
                  </div>
                  <div class="result-values">
                    <div class="result-item">
                      <span class="result-label">마진</span>
                      <span class="result-value" id="coupangMargin">0원</span>
                    </div>
                    <div class="result-item">
                      <span class="result-label">마진률</span>
                      <span class="result-value highlight" id="coupangRate"
                        >0%</span
                      >
                    </div>
                  </div>
                </div>
                <div class="result-card smartstore">
                  <div class="result-platform">
                    <span class="platform-icon">🟢</span>
                    <span class="platform-name">스마트스토어</span>
                    <span class="platform-fee">수수료 6.7%</span>
                  </div>
                  <div class="result-values">
                    <div class="result-item">
                      <span class="result-label">마진</span>
                      <span class="result-value" id="smartstoreMargin"
                        >0원</span
                      >
                    </div>
                    <div class="result-item">
                      <span class="result-label">마진률</span>
                      <span class="result-value highlight" id="smartstoreRate"
                        >0%</span
                      >
                    </div>
                  </div>
                </div>
                <div class="result-card esm">
                  <div class="result-platform">
                    <span class="platform-icon">🔵</span>
                    <span class="platform-name">ESM (G마켓/옥션)</span>
                    <span class="platform-fee">수수료 15%</span>
                  </div>
                  <div class="result-values">
                    <div class="result-item">
                      <span class="result-label">마진</span>
                      <span class="result-value" id="esmMargin">0원</span>
                    </div>
                    <div class="result-item">
                      <span class="result-label">마진률</span>
                      <span class="result-value highlight" id="esmRate"
                        >0%</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 판매가 책정기 -->
          <div class="calc-content" id="calc-price">
            <div class="calc-card">
              <div class="calc-header">
                <h3>판매가 책정기</h3>
                <p>원하는 마진률에 따른 판매가를 계산합니다</p>
              </div>

              <div class="calc-inputs">
                <div class="input-group">
                  <label>상품 원가</label>
                  <div class="input-wrapper">
                    <input
                      type="number"
                      id="priceCost"
                      placeholder="0"
                      min="0"
                    />
                    <span class="input-suffix">원</span>
                  </div>
                </div>
                <div class="input-group">
                  <label>배송비</label>
                  <div class="input-wrapper">
                    <input
                      type="number"
                      id="priceShipping"
                      placeholder="0"
                      min="0"
                    />
                    <span class="input-suffix">원</span>
                  </div>
                </div>
                <div class="input-group">
                  <label>박스비</label>
                  <div class="input-wrapper">
                    <input
                      type="number"
                      id="priceBox"
                      placeholder="0"
                      min="0"
                    />
                    <span class="input-suffix">원</span>
                  </div>
                </div>
              </div>

              <div class="slider-container">
                <div class="slider-header">
                  <label>목표 마진률</label>
                  <span class="slider-value" id="targetMarginValue">20%</span>
                </div>
                <input
                  type="range"
                  id="targetMarginSlider"
                  class="margin-slider"
                  min="0"
                  max="100"
                  value="20"
                />
                <div class="slider-labels">
                  <span>0%</span>
                  <span>25%</span>
                  <span>50%</span>
                  <span>75%</span>
                  <span>100%</span>
                </div>
              </div>

              <div class="price-results" id="priceResults">
                <div class="price-result-card coupang">
                  <div class="price-platform">
                    <span class="platform-icon">🟠</span>
                    <span>쿠팡</span>
                  </div>
                  <div class="price-value" id="coupangPrice">0원</div>
                  <div class="price-note">수수료 12% 적용</div>
                </div>
                <div class="price-result-card smartstore">
                  <div class="price-platform">
                    <span class="platform-icon">🟢</span>
                    <span>스마트스토어</span>
                  </div>
                  <div class="price-value" id="smartstorePrice">0원</div>
                  <div class="price-note">수수료 6.7% 적용</div>
                </div>
                <div class="price-result-card esm">
                  <div class="price-platform">
                    <span class="platform-icon">🔵</span>
                    <span>ESM</span>
                  </div>
                  <div class="price-value" id="esmPrice">0원</div>
                  <div class="price-note">수수료 15% 적용</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 박스 재고 파악 페이지 -->
      <section id="page-box-inventory" class="page" style="display: none">
        <h1 class="page-title">📦 박스 재고 파악</h1>
        <p class="page-description">박스 종류별 재고 현황을 관리합니다.</p>

        <div class="box-inventory-container">
          <div class="box-inventory-header">
            <div class="box-inventory-title">
              <span>재고 목록</span>
              <span id="boxInventoryCount" class="inventory-badge">0개</span>
              <span
                id="boxInventoryModified"
                class="inventory-badge warning"
                style="display: none"
                >변경사항 있음</span
              >
            </div>
            <div class="box-inventory-actions">
              <button class="btn btn-outline" onclick="addBoxRow()">
                <span>➕</span> 행 추가
              </button>
              <button
                id="btnSaveBoxInventory"
                class="btn btn-primary"
                onclick="saveBoxInventory()"
              >
                <span>💾</span> 저장
              </button>
            </div>
          </div>

          <div class="box-inventory-table-wrapper">
            <table class="box-inventory-table">
              <thead>
                <tr>
                  <th class="col-row-num">#</th>
                  <th class="col-name">박스명(CJ)</th>
                  <th class="col-name">박스명(박스포유)</th>
                  <th class="col-name">박스명(기타)</th>
                  <th class="col-spec">박스규격</th>
                  <th class="col-material">재질</th>
                  <th class="col-strength">강도</th>
                  <th class="col-print">인쇄</th>
                  <th class="col-price">단가</th>
                  <th class="col-vendor">구매처</th>
                  <th class="col-moq">MOQ(팔레트)</th>
                  <th class="col-moq">MOQ(낱개)</th>
                  <th class="col-stock stock-col">재고(CJ)</th>
                  <th class="col-stock stock-col">재고(효진)</th>
                  <th class="col-action"></th>
                </tr>
              </thead>
              <tbody id="boxInventoryBody"></tbody>
            </table>

            <div
              id="boxEmptyState"
              class="box-empty-state"
              style="display: none"
            >
              <div class="empty-icon">📦</div>
              <p>
                등록된 박스 재고가 없습니다.<br /><span
                  style="font-size: 12px; color: #555"
                  >우측 상단의 [행 추가] 버튼을 눌러 추가하세요.</span
                >
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- 스타배송 필터 페이지 -->
      <section id="page-starfilter" class="page" style="display: none">
        <h1 class="page-title">스타배송 필터</h1>
        <p class="page-description">
          엑셀 파일에서 '판매자 스타배송' 주문을 자동으로 제거합니다
        </p>

        <div class="upload-area" id="starUploadArea">
          <div class="upload-icon">📊</div>
          <div class="upload-text">
            엑셀 파일을 여기에 드래그하거나 클릭하여 선택하세요
          </div>
          <div class="upload-hint">.xlsx 및 .xls 형식 지원 • 초고속 처리</div>
          <input
            type="file"
            id="starFileInput"
            accept=".xls,.xlsx"
            style="display: none"
          />
          <div class="file-info" id="starFileInfo">
            <span>📄</span>
            <span class="file-name" id="starFileName"></span>
            <span class="file-size" id="starFileSize"></span>
          </div>
        </div>

        <div class="button-group">
          <button class="btn btn-primary" id="starFilterBtn" disabled>
            ⚡ 필터 시작
          </button>
        </div>
      </section>

      <!-- 송장 분류 페이지 -->
      <section id="page-classify" class="page" style="display: none">
        <h1 class="page-title">송장 분류</h1>
        <p class="page-description">
          주문 엑셀 파일을 담당자별로 자동 분류합니다
        </p>

        <div class="settings-info">
          📋 <span>현재 설정:</span> <span id="settingsInfo">로딩중...</span>
        </div>

        <!-- 탭 -->
        <div class="tabs">
          <div class="tab active" data-tab="upload">📁 파일 업로드</div>
          <div class="tab" data-tab="workers">👥 담당자</div>
          <div class="tab" data-tab="analysis">📊 결과 분석</div>
        </div>

        <!-- 파일 업로드 탭 -->
        <div class="tab-content active" id="tab-upload">
          <div class="upload-area" id="classifyUploadArea">
            <div class="upload-icon">📊</div>
            <div class="upload-text">
              엑셀 파일을 여기에 드래그하거나 클릭하여 선택하세요
            </div>
            <div class="upload-hint">.xlsx 및 .xls 형식 지원 • 초고속 처리</div>
            <input
              type="file"
              id="classifyFileInput"
              accept=".xls,.xlsx"
              style="display: none"
            />
            <div class="file-info" id="classifyFileInfo">
              <span>📄</span>
              <span class="file-name" id="classifyFileName"></span>
              <span class="file-size" id="classifyFileSize"></span>
            </div>
          </div>

          <div class="button-group">
            <button class="btn btn-primary" id="classifyBtn" disabled>
              ⚡ 분류 시작
            </button>
            <button class="btn btn-secondary" id="downloadBtn" disabled>
              📁 결과 다운로드
            </button>
            <button class="btn btn-outline" id="reviewBtn" disabled>
              🔍 미분류 검토
            </button>
            <label class="star-filter-checkbox">
              <input type="checkbox" id="starFilterCheck" />
              <span class="checkmark"></span>
              <span class="checkbox-label">⭐ 스타배송 필터링</span>
            </label>
          </div>
        </div>

        <!-- 담당자 탭 -->
        <div class="tab-content" id="tab-workers">
          <div class="workers-list" id="workersList">
            <!-- 동적 생성 -->
          </div>

          <!-- 담당자 상품 규칙 모달 (DB 연결 시에만 사용) -->
          <div class="modal-overlay" id="workerProductsModal">
            <div
              class="modal"
              style="
                max-width: 800px;
                max-height: 80vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
              "
            >
              <div class="modal-header" style="flex-shrink: 0">
                <div class="modal-icon" id="workerModalIcon">📋</div>
                <div class="modal-title" id="workerModalTitle">담당자</div>
                <div class="modal-subtitle" id="workerModalSubtitle">
                  상품 규칙 관리
                </div>
              </div>

              <div
                id="workerAddBtnArea"
                style="
                  padding: 0 20px;
                  margin-bottom: 15px;
                  flex-shrink: 0;
                  display: none;
                "
              >
                <button
                  class="btn btn-primary"
                  onclick="showAddProductForm()"
                  style="width: 100%"
                >
                  ➕ 새 상품 규칙 추가
                </button>
              </div>

              <!-- 상품 추가 폼 (숨김) -->
              <div
                id="addProductForm"
                style="
                  display: none;
                  padding: 0 20px;
                  margin-bottom: 15px;
                  flex-shrink: 0;
                "
              >
                <div
                  style="background: #222; border-radius: 8px; padding: 15px"
                >
                  <div
                    style="
                      display: grid;
                      grid-template-columns: 1fr 1fr 1fr;
                      gap: 10px;
                      margin-bottom: 10px;
                    "
                  >
                    <input
                      type="text"
                      id="newBrand"
                      placeholder="브랜드 (비워두면 All)"
                      style="
                        padding: 10px;
                        background: #333;
                        border: 1px solid #444;
                        border-radius: 6px;
                        color: #fff;
                      "
                    />
                    <input
                      type="text"
                      id="newProductName"
                      placeholder="상품명 *"
                      style="
                        padding: 10px;
                        background: #333;
                        border: 1px solid #444;
                        border-radius: 6px;
                        color: #fff;
                      "
                    />
                    <input
                      type="text"
                      id="newOrderOption"
                      placeholder="옵션 (비워두면 All)"
                      style="
                        padding: 10px;
                        background: #333;
                        border: 1px solid #444;
                        border-radius: 6px;
                        color: #fff;
                      "
                    />
                  </div>
                  <div style="display: flex; gap: 10px">
                    <button
                      class="btn btn-primary"
                      id="saveProductBtn"
                      onclick="saveNewProduct()"
                      style="flex: 1"
                    >
                      저장
                    </button>
                    <button
                      class="btn btn-outline"
                      onclick="hideAddProductForm()"
                    >
                      취소
                    </button>
                  </div>
                </div>
              </div>

              <div
                id="workerProductsList"
                style="flex: 1; overflow-y: auto; padding: 0 20px"
              >
                <!-- 동적 생성 -->
              </div>

              <div
                class="modal-actions"
                style="flex-shrink: 0; padding-top: 15px"
              >
                <button
                  class="btn btn-outline"
                  onclick="closeWorkerProductsModal()"
                >
                  닫기
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 결과 분석 탭 -->
        <div class="tab-content" id="tab-analysis">
          <div class="analysis-container">
            <div class="analysis-header">
              <div class="analysis-title">담당자별 주문 현황</div>
              <div class="analysis-desc">
                가장 최근 분류 결과를 기준으로 표시됩니다
              </div>
            </div>
            <div id="analysisContent">
              <div class="no-data">
                <div class="no-data-icon">📊</div>
                <div>분류 결과가 없습니다</div>
                <div style="margin-top: 8px; font-size: 13px">
                  파일을 업로드하고 분류를 시작해주세요
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 면세 자료 정리 페이지 -->
      <section id="page-tax-free" class="page" style="display: none">
        <h1 class="page-title">📋 면세 자료 정리</h1>
        <p class="page-description">
          쿠팡 매출자료에서 면세(FREE) 데이터만 추출합니다
        </p>

        <!-- 업로드 영역 -->
        <div id="taxFreeUploadSection">
          <div
            class="upload-area"
            id="taxFreeUploadArea"
            onclick="document.getElementById('taxFreeInput').click()"
          >
            <div class="upload-icon">📊</div>
            <div class="upload-text">
              쿠팡 매출자료 엑셀 파일을 업로드하세요
            </div>
            <div class="upload-hint">여러 파일 선택 가능 (.xls, .xlsx)</div>
            <input
              type="file"
              id="taxFreeInput"
              accept=".xls,.xlsx"
              multiple
              style="display: none"
              onchange="handleTaxFreeFiles(this.files)"
            />
          </div>

          <div class="file-info" id="taxFreeFileInfo">
            <span>📁</span>
            <span class="file-name" id="taxFreeFileName"></span>
            <span class="file-size" id="taxFreeFileSize"></span>
          </div>

          <div class="button-group" style="margin-top: 20px">
            <button
              class="btn btn-primary"
              id="taxFreeProcessBtn"
              onclick="processTaxFree()"
              disabled
            >
              🚀 면세 자료 정리 시작
            </button>
            <button class="btn btn-outline" onclick="resetTaxFree()">
              🔄 초기화
            </button>
          </div>
        </div>

        <!-- 결과 영역 -->
        <div id="taxFreeResultSection" style="display: none; margin-top: 30px">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2 style="color: #00ff88; font-size: 20px">📊 분석 결과</h2>
            <div style="display: flex; gap: 10px">
              <button class="btn btn-primary" onclick="downloadTaxFree()">
                📥 엑셀 다운로드
              </button>
              <button class="btn btn-outline" onclick="resetTaxFree()">
                🔄 새로 분석
              </button>
            </div>
          </div>

          <!-- 파일 처리 정보 -->
          <div
            id="taxFreeFileStatus"
            style="
              background: #1a1a1a;
              border-radius: 12px;
              padding: 16px 20px;
              margin-bottom: 20px;
              border: 1px solid #333;
            "
          >
            <div
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                align-items: center;
              "
            >
              <div style="display: flex; align-items: center; gap: 8px">
                <span style="color: #888">📁 업로드:</span>
                <span
                  style="color: #fff; font-weight: 600"
                  id="taxFreeUploadedCount"
                  >0</span
                >
                <span style="color: #666">개</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px">
                <span style="color: #888">✅ 처리됨:</span>
                <span
                  style="color: #00ff88; font-weight: 600"
                  id="taxFreeProcessedCount"
                  >0</span
                >
                <span style="color: #666">개</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px">
                <span style="color: #888">📅 분석 월:</span>
                <span
                  style="color: #a855f7; font-weight: 600"
                  id="taxFreeMonthCount"
                  >0</span
                >
                <span style="color: #666">개월</span>
              </div>
              <div
                id="taxFreeDuplicateInfo"
                style="display: none; align-items: center; gap: 8px"
              >
                <span style="color: #ff6b6b">⚠️ 중복 제외:</span>
                <span
                  style="color: #ff6b6b; font-weight: 600"
                  id="taxFreeDuplicateCount"
                  >0</span
                >
                <span style="color: #666">개</span>
              </div>
            </div>
          </div>

          <!-- 중복 파일 경고 -->
          <div
            id="taxFreeDuplicateWarning"
            style="
              display: none;
              background: rgba(255, 107, 107, 0.1);
              border: 1px solid #ff6b6b;
              border-radius: 12px;
              padding: 16px 20px;
              margin-bottom: 20px;
            "
          >
            <div style="color: #ff6b6b; font-weight: 600; margin-bottom: 10px">
              ⚠️ 중복 파일이 감지되어 자동으로 제외되었습니다
            </div>
            <div
              id="taxFreeDuplicateList"
              style="color: #888; font-size: 13px"
            ></div>
          </div>

          <!-- 요약 카드 -->
          <div
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
              gap: 20px;
              margin-bottom: 30px;
            "
          >
            <div
              style="
                background: linear-gradient(135deg, #1a472a 0%, #0d2818 100%);
                border-radius: 16px;
                padding: 25px;
                border: 1px solid #00ff88;
              "
            >
              <div style="color: #888; font-size: 14px; margin-bottom: 8px">
                📋 추출된 면세 데이터
              </div>
              <div
                style="font-size: 32px; font-weight: bold; color: #00ff88"
                id="taxFreeRowCount"
              >
                0
              </div>
              <div style="color: #666; font-size: 13px">건</div>
            </div>
            <div
              style="
                background: linear-gradient(135deg, #2a1a47 0%, #18102b 100%);
                border-radius: 16px;
                padding: 25px;
                border: 1px solid #a855f7;
              "
            >
              <div style="color: #888; font-size: 14px; margin-bottom: 8px">
                💰 연간 면세 매출 합계
              </div>
              <div
                style="font-size: 32px; font-weight: bold; color: #a855f7"
                id="taxFreeYearlySales"
              >
                0
              </div>
              <div style="color: #666; font-size: 13px">원</div>
            </div>
            <div
              style="
                background: linear-gradient(135deg, #473a1a 0%, #2b2510 100%);
                border-radius: 16px;
                padding: 25px;
                border: 1px solid #ffd700;
              "
            >
              <div style="color: #888; font-size: 14px; margin-bottom: 8px">
                📦 연간 전체 매출 합계
              </div>
              <div
                style="font-size: 32px; font-weight: bold; color: #ffd700"
                id="taxFreeTotalSales"
              >
                0
              </div>
              <div style="color: #666; font-size: 13px">원</div>
            </div>
          </div>

          <!-- 월별 상세 테이블 -->
          <div
            style="
              background: #111;
              border-radius: 12px;
              border: 1px solid #222;
              overflow: hidden;
            "
          >
            <div
              style="
                padding: 20px;
                border-bottom: 1px solid #222;
                background: #0a0a0a;
              "
            >
              <h3 style="color: #fff; font-size: 16px; margin: 0">
                📅 월별 상세 내역
              </h3>
            </div>
            <div style="overflow-x: auto">
              <table style="width: 100%; border-collapse: collapse">
                <thead>
                  <tr style="background: #1a1a1a">
                    <th
                      style="
                        padding: 14px;
                        text-align: left;
                        color: #888;
                        font-weight: 500;
                        border-bottom: 1px solid #333;
                      "
                    >
                      월
                    </th>
                    <th
                      style="
                        padding: 14px;
                        text-align: center;
                        color: #888;
                        font-weight: 500;
                        border-bottom: 1px solid #333;
                      "
                    >
                      파일수
                    </th>
                    <th
                      style="
                        padding: 14px;
                        text-align: right;
                        color: #00ff88;
                        font-weight: 500;
                        border-bottom: 1px solid #333;
                      "
                    >
                      면세 주문수
                    </th>
                    <th
                      style="
                        padding: 14px;
                        text-align: right;
                        color: #00ff88;
                        font-weight: 500;
                        border-bottom: 1px solid #333;
                      "
                    >
                      면세 매출
                    </th>
                    <th
                      style="
                        padding: 14px;
                        text-align: right;
                        color: #ffd700;
                        font-weight: 500;
                        border-bottom: 1px solid #333;
                      "
                    >
                      전체 주문수
                    </th>
                    <th
                      style="
                        padding: 14px;
                        text-align: right;
                        color: #ffd700;
                        font-weight: 500;
                        border-bottom: 1px solid #333;
                      "
                    >
                      전체 매출
                    </th>
                    <th
                      style="
                        padding: 14px;
                        text-align: right;
                        color: #a855f7;
                        font-weight: 500;
                        border-bottom: 1px solid #333;
                      "
                    >
                      면세 비율
                    </th>
                  </tr>
                </thead>
                <tbody id="taxFreeMonthlyTable"></tbody>
                <tfoot
                  id="taxFreeYearlyTotal"
                  style="background: #1a1a1a; font-weight: 600"
                ></tfoot>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- 도착보장 입고내역서 페이지 -->
      <section id="page-arrival-invoice" class="page" style="display: none">
        <h1 class="page-title">도착보장 입고내역서</h1>
        <p class="page-description">네이버 도착보장 입고내역서를 생성합니다</p>

        <div class="arrival-container">
          <!-- 메인 입력 영역 -->
          <div class="arrival-main">
            <div class="arrival-form-group">
              <label class="arrival-form-label">배송 유형</label>
              <div class="delivery-type-toggle">
                <button
                  type="button"
                  class="delivery-type-btn active"
                  data-type="화물"
                  onclick="selectDeliveryType('화물')"
                >
                  🚛 화물
                </button>
                <button
                  type="button"
                  class="delivery-type-btn"
                  data-type="택배"
                  onclick="selectDeliveryType('택배')"
                >
                  📦 택배
                </button>
              </div>
            </div>

            <div class="arrival-form-group">
              <label class="arrival-form-label">입고예정일</label>
              <div class="date-picker-container">
                <input
                  type="text"
                  id="arrivalDate"
                  class="arrival-form-input"
                  placeholder="YYYYMMDD 형식으로 입력"
                  maxlength="8"
                />
                <div class="mini-calendar" id="miniCalendar"></div>
              </div>
            </div>

            <div class="arrival-form-group">
              <label class="arrival-form-label">상품명</label>
              <select
                id="arrivalProductSelect"
                class="product-select"
                onchange="onProductSelect()"
              >
                <option value="">-- 상품을 선택하세요 --</option>
              </select>
            </div>

            <div class="arrival-form-group">
              <label class="arrival-form-label">상품 바코드</label>
              <input
                type="text"
                id="arrivalBarcode"
                class="arrival-form-input"
                readonly
                placeholder="상품 선택 시 자동 입력"
              />
            </div>

            <div class="arrival-form-group">
              <label class="arrival-form-label">수량 (EA)</label>
              <input
                type="number"
                id="arrivalQuantity"
                class="arrival-form-input"
                placeholder="수량 입력"
                min="1"
              />
            </div>

            <div class="arrival-form-group">
              <label class="arrival-form-label">특이사항</label>
              <input
                type="text"
                id="arrivalNote"
                class="arrival-form-input"
                placeholder="특이사항 입력 (선택)"
              />
            </div>

            <div class="separate-checkbox">
              <input type="checkbox" id="generateSeparate" />
              <label for="generateSeparate"
                >상품별 개별 입고내역서 생성 (ZIP 다운로드)</label
              >
            </div>

            <div class="arrival-btn-group">
              <button
                type="button"
                class="arrival-btn arrival-btn-outline"
                onclick="clearArrivalForm()"
              >
                취소
              </button>
              <button
                type="button"
                class="arrival-btn arrival-btn-secondary"
                onclick="addArrivalItem()"
              >
                ➕ 상품 추가
              </button>
              <button
                type="button"
                class="arrival-btn arrival-btn-primary"
                onclick="generateArrivalInvoice()"
              >
                📄 입고내역서 생성
              </button>
            </div>

            <!-- 추가된 상품 리스트 -->
            <div
              class="added-products-list"
              id="addedProductsList"
              style="display: none"
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 15px;
                "
              >
                <span style="color: #00ff88; font-weight: 600"
                  >추가된 상품</span
                >
                <span id="addedCount" style="color: #888; font-size: 13px"
                  >0개</span
                >
              </div>
              <div id="addedProductsContainer"></div>
            </div>
          </div>

          <!-- 사이드바 설정 영역 -->
          <div class="arrival-sidebar">
            <!-- 고객ID 설정 -->
            <div class="arrival-card">
              <div class="arrival-card-title">🆔 고객ID 설정</div>
              <div
                id="currentCustomerIdDisplay"
                style="
                  background: #1a1a1a;
                  padding: 10px 14px;
                  border-radius: 6px;
                  margin-bottom: 12px;
                  display: none;
                "
              >
                <span style="color: #888; font-size: 12px">현재 고객ID:</span>
                <span
                  id="currentCustomerIdText"
                  style="
                    color: #00ff88;
                    font-size: 14px;
                    font-weight: 600;
                    margin-left: 8px;
                  "
                ></span>
              </div>
              <div class="customer-id-section">
                <input
                  type="text"
                  id="customerIdInput"
                  class="customer-id-input"
                  placeholder="고객ID 입력"
                />
                <button
                  type="button"
                  class="customer-id-save"
                  onclick="saveCustomerId()"
                >
                  저장
                </button>
              </div>
              <p style="color: #666; font-size: 12px; margin-top: 10px">
                한번 저장하면 자동으로 입력됩니다
              </p>
            </div>

            <!-- 상품 관리 -->
            <div
              class="arrival-card"
              style="
                flex: 1;
                overflow: hidden;
                display: flex;
                flex-direction: column;
              "
            >
              <div
                class="arrival-card-title"
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <span>📦 도착보장 상품 관리</span>
                <button
                  type="button"
                  class="product-action-btn"
                  onclick="toggleArrivalAddProductForm()"
                  style="color: #00ff88; font-size: 14px"
                >
                  + 추가
                </button>
              </div>

              <!-- 상품 추가 폼 -->
              <div
                id="arrivalAddProductForm"
                style="display: none; margin-bottom: 15px"
              >
                <div class="add-product-row">
                  <input
                    type="text"
                    id="arrivalNewProductName"
                    placeholder="상품명"
                  />
                  <input
                    type="text"
                    id="arrivalNewProductBarcode"
                    placeholder="바코드"
                  />
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px">
                  <button
                    type="button"
                    class="arrival-btn arrival-btn-outline"
                    style="flex: 1; padding: 8px"
                    onclick="toggleArrivalAddProductForm()"
                  >
                    취소
                  </button>
                  <button
                    type="button"
                    class="arrival-btn arrival-btn-primary"
                    style="flex: 1; padding: 8px"
                    onclick="saveNewArrivalProduct()"
                  >
                    저장
                  </button>
                </div>
              </div>

              <div style="flex: 1; overflow-y: auto; max-height: 400px">
                <table class="product-manage-table">
                  <thead>
                    <tr>
                      <th>상품명</th>
                      <th>바코드</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="arrivalProductsTableBody">
                    <tr>
                      <td colspan="3" style="text-align: center; color: #666">
                        상품을 등록하세요
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 직원 관리 페이지 -->
      <section id="page-employees" class="page" style="display: none">
        <h1 class="page-title">직원 관리</h1>
        <p class="page-description">알바생 계정 및 급여 설정을 관리합니다</p>

        <div class="content-card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h3>👥 직원 목록</h3>
            <button class="btn btn-primary" onclick="showAddEmployeeModal()">
              ➕ 직원 추가
            </button>
          </div>

          <div id="employeeList">
            <div style="text-align: center; padding: 40px; color: #666">
              로딩중...
            </div>
          </div>
        </div>

        <!-- 공휴일 관리 -->
        <div class="content-card" style="margin-top: 20px">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h3>📅 공휴일 관리</h3>
            <button class="btn btn-primary" onclick="showAddHolidayModal()">
              ➕ 공휴일 추가
            </button>
          </div>

          <div style="margin-bottom: 15px">
            <select
              id="holidayYear"
              onchange="loadHolidays()"
              style="
                padding: 8px 12px;
                background: #222;
                border: 1px solid #333;
                border-radius: 6px;
                color: #fff;
                margin-right: 10px;
              "
            >
              <option value="2025">2025년</option>
              <option value="2026">2026년</option>
            </select>
            <select
              id="holidayMonth"
              onchange="loadHolidays()"
              style="
                padding: 8px 12px;
                background: #222;
                border: 1px solid #333;
                border-radius: 6px;
                color: #fff;
              "
            >
              <option value="1">1월</option>
              <option value="2">2월</option>
              <option value="3">3월</option>
              <option value="4">4월</option>
              <option value="5">5월</option>
              <option value="6">6월</option>
              <option value="7">7월</option>
              <option value="8">8월</option>
              <option value="9">9월</option>
              <option value="10">10월</option>
              <option value="11">11월</option>
              <option value="12">12월</option>
            </select>
          </div>

          <div id="holidayList">
            <div style="text-align: center; padding: 20px; color: #666">
              등록된 공휴일이 없습니다
            </div>
          </div>
        </div>
      </section>

      <!-- 직원 출퇴근일지 페이지 -->
      <section id="page-admin-attendance" class="page" style="display: none">
        <h1 class="page-title">직원 출퇴근일지</h1>
        <p class="page-description">직원들의 출퇴근 기록을 조회합니다</p>

        <div class="content-card">
          <div
            style="
              display: flex;
              gap: 15px;
              margin-bottom: 20px;
              flex-wrap: wrap;
              align-items: center;
            "
          >
            <select
              id="adminAttYear"
              onchange="loadAdminAttendance()"
              style="
                padding: 10px 15px;
                background: #222;
                border: 1px solid #333;
                border-radius: 8px;
                color: #fff;
              "
            >
              <option value="2025">2025년</option>
              <option value="2026">2026년</option>
            </select>
            <select
              id="adminAttMonth"
              onchange="loadAdminAttendance()"
              style="
                padding: 10px 15px;
                background: #222;
                border: 1px solid #333;
                border-radius: 8px;
                color: #fff;
              "
            >
              <option value="1">1월</option>
              <option value="2">2월</option>
              <option value="3">3월</option>
              <option value="4">4월</option>
              <option value="5">5월</option>
              <option value="6">6월</option>
              <option value="7">7월</option>
              <option value="8">8월</option>
              <option value="9">9월</option>
              <option value="10">10월</option>
              <option value="11">11월</option>
              <option value="12">12월</option>
            </select>
          </div>

          <div id="adminAttendanceList">
            <div style="text-align: center; padding: 40px; color: #666">
              직원을 선택하세요
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- 로딩중 이펙트 -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="progress-container">
        <svg class="progress-ring" width="120" height="120">
          <circle
            class="progress-ring__circle-bg"
            stroke="rgba(255,255,255,0.1)"
            stroke-width="8"
            fill="transparent"
            r="52"
            cx="60"
            cy="60"
          />
          <circle
            class="progress-ring__circle"
            id="progressCircle"
            stroke="#00ff88"
            stroke-width="8"
            fill="transparent"
            r="52"
            cx="60"
            cy="60"
          />
        </svg>
        <div class="progress-text-container">
          <div class="loading-label">Loading</div>
          <div class="loading-percent" id="loadingPercent">0%</div>
        </div>
      </div>
    </div>

    <!-- 결과 모달 -->
    <div class="modal-overlay" id="resultModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-icon">✅</div>
          <div class="modal-title">분류 완료!</div>
          <div class="modal-subtitle" id="modalSubtitle"></div>
          <div
            class="modal-subtitle"
            id="starFilterMessage"
            style="color: #ffd700; margin-top: 5px; display: none"
          ></div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">전체 주문</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statSuccess">0</div>
            <div class="stat-label">분류 성공</div>
          </div>
          <div class="stat-card">
            <div class="stat-value warning" id="statFailed">0</div>
            <div class="stat-label">분류 실패</div>
          </div>
        </div>

        <div class="accuracy-bar">
          <div class="accuracy-header">
            <span class="accuracy-label">분류 정확도</span>
            <span class="accuracy-value" id="accuracyValue">0%</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="progressFill"
              style="width: 0%"
            ></div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-primary" id="modalDownloadBtn">
            📁 결과 다운로드
          </button>
          <button class="btn btn-outline" id="modalCloseBtn">닫기</button>
        </div>
      </div>
    </div>

    <!-- 토스트 -->
    <div class="toast" id="toast">
      <span id="toastIcon">✅</span>
      <span id="toastMessage"></span>
    </div>

    <!-- 모바일 하단 네비게이션 -->
    <nav class="mobile-nav" id="mobileNav" style="display: none">
      <a class="mobile-nav-item active" data-page="home">
        <span class="mobile-nav-icon">🏠</span>
        <span>홈</span>
      </a>
      <a class="mobile-nav-item" data-page="margin">
        <span class="mobile-nav-icon">📊</span>
        <span>원가표</span>
      </a>
      <a class="mobile-nav-item" data-page="calculator">
        <span class="mobile-nav-icon">🧮</span>
        <span>계산기</span>
      </a>
      <a class="mobile-nav-item" data-page="classify">
        <span class="mobile-nav-icon">📋</span>
        <span>송장</span>
      </a>
      <a class="mobile-nav-item" data-page="starfilter">
        <span class="mobile-nav-icon">⭐</span>
        <span>필터</span>
      </a>
      <a class="mobile-nav-item" data-page="employees">
        <span class="mobile-nav-icon">👥</span>
        <span>직원</span>
      </a>
      <a class="mobile-nav-item" data-page="admin-attendance">
        <span class="mobile-nav-icon">📅</span>
        <span>출퇴근</span>
      </a>
    </nav>

    <script>
      // 상태 관리
      let currentResultId = null;
      let currentStats = null;
      let selectedFile = null;
      let marginData = [];
      let dbConnected = false; // DB 연결 상태

      // DOM 요소
      const loadingOverlay = document.getElementById("loadingOverlay");
      const resultModal = document.getElementById("resultModal");
      const toast = document.getElementById("toast");

      // 초기화
      document.addEventListener("DOMContentLoaded", async () => {
        showLoading(); // [추가] 전체 로딩 시작

        try {
          await checkDbStatus();
          await loadSettings();

          setupNavigation();
          setupTabs();
          setupUploadAreas();
          setupButtons();
          setupMarginSearch();
          setupUserProfile();
          setupCalculator();
          checkMobile();
          window.addEventListener("resize", checkMobile);

          // 관리자 홈 대시보드 로드 (병렬 처리로 속도 향상)
          await Promise.all([
            loadEditRequests(),
            loadMemos(),
            loadOutOfStock(),
          ]);
        } catch (e) {
          console.error("초기화 중 오류:", e);
        } finally {
          hideLoading(); // [추가] 모든 초기화가 끝나면 로딩 제거
        }
      });

      // DB 연결 상태 확인
      async function checkDbStatus() {
        try {
          const response = await fetch("/api/db-status");
          const data = await response.json();
          dbConnected = data.db_connected;

          // DB 연결 시 CRUD 버튼 표시
          if (dbConnected) {
            const addMarginBtn = document.getElementById("addMarginBtn");
            if (addMarginBtn) addMarginBtn.style.display = "block";
          }

          console.log("DB 연결 상태:", dbConnected ? "연결됨" : "미연결");
        } catch (error) {
          console.log("DB 상태 확인 실패 - JSON 모드로 작동");
          dbConnected = false;
        }
      }

      // 유저 프로필 드롭다운 설정
      function setupUserProfile() {
        const userBtn = document.getElementById("userBtn");
        const userDropdown = document.getElementById("userDropdown");

        if (userBtn && userDropdown) {
          userBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle("show");
          });

          // 외부 클릭 시 닫기
          document.addEventListener("click", () => {
            userDropdown.classList.remove("show");
          });
        }
      }

      // 모바일 체크
      function checkMobile() {
        const isMobile = window.innerWidth <= 768;
        const mobileNav = document.getElementById("mobileNav");
        if (mobileNav) {
          mobileNav.style.display = isMobile ? "flex" : "none";
        }
      }

      // 원가 마진표 데이터 로드
      async function loadMarginData(search = "") {
        showLoading(); // [추가] 로딩 시작
        const container = document.getElementById("marginTableContainer");

        try {
          const url = search
            ? `/api/margin?search=${encodeURIComponent(search)}`
            : "/api/margin";
          const response = await fetch(url);
          const result = await response.json();

          marginData = result.data;
          document.getElementById("resultCount").textContent =
            `총 ${result.total}개 상품`;

          renderMarginTable(marginData);
        } catch (error) {
          console.error("원가 마진표 로드 오류:", error);
          container.innerHTML =
            '<div class="loading-data">데이터 로드 실패</div>';
        } finally {
          hideLoading(); // [추가] 로딩 종료 (성공하든 실패하든 무조건 실행)
        }
      }

      // 원가 마진표 렌더링
      function renderMarginTable(data) {
        const container = document.getElementById("marginTableContainer");

        if (data.length === 0) {
          container.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">🔍</div>
                        <div>검색 결과가 없습니다</div>
                    </div>
                `;
          return;
        }

        // 테이블 뷰 (데스크톱)
        let tableHtml = `
                <div class="table-wrapper">
                    <table class="margin-table">
                        <thead>
                            <tr>
                                <th class="col-name">상품명</th>
                                <th class="col-num">인상전 상품가</th>
                                <th class="col-num">인상후 상품가</th>
                                <th class="col-num">물량지원</th>
                                <th class="col-num">프로모션할인률</th>
                                <th class="col-num">장려금률</th>
                                <th class="col-num">배송비</th>
                                <th class="col-num">박스비</th>
                                <th class="col-num">인상전 총 원가</th>
                                <th class="col-num">인상후 총 원가</th>
                                <th class="col-center">인상전 재고</th>
                                <th class="col-center">1박스 최대 수량</th>
                                <th>기타사항</th>
                                ${
                                  dbConnected
                                    ? '<th class="col-center">관리</th>'
                                    : ""
                                }
                            </tr>
                        </thead>
                        <tbody>
            `;

        data.forEach((item) => {
          const hasStock = item["인상전 재고"] === "o";
          const stockClass = hasStock ? "stock-yes" : "stock-no";
          const stockText = hasStock ? "O" : "X";

          // 재고 유무에 따라 하이라이트 결정
          const preHighlight = hasStock ? "highlight" : "";
          const postHighlight = hasStock ? "" : "highlight";

          tableHtml += `
                    <tr>
                        <td class="col-name">${item["상품명"]}</td>
                        <td class="col-num ${preHighlight}">${formatNumber(
                          item["인상전 상품가"],
                        )}</td>
                        <td class="col-num ${postHighlight}">${formatNumber(
                          item["인상후 상품가"],
                        )}</td>
                        <td class="col-num">${item["물량지원"]}</td>
                        <td class="col-num">${formatPercent(
                          item["프로모션할인률"],
                        )}</td>
                        <td class="col-num">${formatPercent(
                          item["장려금률"],
                        )}</td>
                        <td class="col-num">${formatNumber(item["배송비"])}</td>
                        <td class="col-num">${formatNumber(item["박스비"])}</td>
                        <td class="col-num ${preHighlight}">${formatNumber(
                          item["인상전 총 원가"],
                        )}</td>
                        <td class="col-num ${postHighlight}">${formatNumber(
                          item["인상후 총 원가"],
                        )}</td>
                        <td class="col-center ${stockClass}">${stockText}</td>
                        <td class="col-center">${
                          item["1박스 최대 수량"] || "-"
                        }</td>
                        <td>${item["기타사항"] || "-"}</td>
                        ${
                          dbConnected && item.id
                            ? `
                        <td class="col-center">
                          <button onclick='showEditMarginModal(${JSON.stringify(
                            item,
                          )})' style="padding: 4px 8px; background: #333; border: none; border-radius: 4px; color: #fff; cursor: pointer; margin-right: 4px;">✏️</button>
                          <button onclick="deleteMarginProduct(${
                            item.id
                          })" style="padding: 4px 8px; background: #ff4444; border: none; border-radius: 4px; color: #fff; cursor: pointer;">🗑️</button>
                        </td>
                        `
                            : dbConnected
                              ? '<td class="col-center">-</td>'
                              : ""
                        }
                    </tr>
                `;
        });

        tableHtml += "</tbody></table></div>";

        // 카드 뷰 (모바일)
        let cardsHtml = '<div class="margin-cards">';

        data.forEach((item) => {
          const hasStock = item["인상전 재고"] === "o";
          const stockClass = hasStock ? "yes" : "no";
          const stockText = hasStock ? "재고있음" : "재고없음";

          // 재고 유무에 따라 하이라이트 결정
          const preHighlight = hasStock ? "highlight" : "";
          const postHighlight = hasStock ? "" : "highlight";

          cardsHtml += `
                    <div class="margin-card">
                        <div class="margin-card-header">
                            <div class="margin-card-name">${
                              item["상품명"]
                            }</div>
                            <span class="margin-card-stock ${stockClass}">${stockText}</span>
                        </div>
                        <div class="margin-card-grid">
                            <div class="margin-card-item">
                                <span class="margin-card-label">인상전 상품가</span>
                                <span class="margin-card-value ${preHighlight}">${formatNumber(
                                  item["인상전 상품가"],
                                )}원</span>
                            </div>
                            <div class="margin-card-item">
                                <span class="margin-card-label">인상후 상품가</span>
                                <span class="margin-card-value ${postHighlight}">${formatNumber(
                                  item["인상후 상품가"],
                                )}원</span>
                            </div>
                            <div class="margin-card-item">
                                <span class="margin-card-label">인상전 총 원가</span>
                                <span class="margin-card-value ${preHighlight}">${formatNumber(
                                  item["인상전 총 원가"],
                                )}원</span>
                            </div>
                            <div class="margin-card-item">
                                <span class="margin-card-label">인상후 총 원가</span>
                                <span class="margin-card-value ${postHighlight}">${formatNumber(
                                  item["인상후 총 원가"],
                                )}원</span>
                            </div>
                        </div>
                        <div class="margin-card-divider"></div>
                        <div class="margin-card-grid">
                            <div class="margin-card-item">
                                <span class="margin-card-label">물량지원</span>
                                <span class="margin-card-value">${
                                  item["물량지원"]
                                }</span>
                            </div>
                            <div class="margin-card-item">
                                <span class="margin-card-label">장려금률</span>
                                <span class="margin-card-value">${formatPercent(
                                  item["장려금률"],
                                )}</span>
                            </div>
                            <div class="margin-card-item">
                                <span class="margin-card-label">배송비</span>
                                <span class="margin-card-value">${formatNumber(
                                  item["배송비"],
                                )}원</span>
                            </div>
                            <div class="margin-card-item">
                                <span class="margin-card-label">1박스 최대 수량</span>
                                <span class="margin-card-value">${
                                  item["1박스 최대 수량"] || "-"
                                }</span>
                            </div>
                        </div>
                        ${
                          item["기타사항"]
                            ? `<div class="margin-card-note">📝 ${item["기타사항"]}</div>`
                            : ""
                        }
                    </div>
                `;
        });

        cardsHtml += "</div>";

        container.innerHTML = tableHtml + cardsHtml;
      }

      // 숫자 포맷
      function formatNumber(num) {
        if (num === null || num === undefined || num === "") return "-";
        return Math.round(num).toLocaleString();
      }

      // 퍼센트 포맷
      function formatPercent(num) {
        if (num === null || num === undefined || num === "" || num === 0)
          return "-";
        return (num * 100).toFixed(1) + "%";
      }

      // 검색 설정
      function setupMarginSearch() {
        const searchInput = document.getElementById("marginSearch");
        const clearBtn = document.getElementById("searchClear");
        let debounceTimer;

        if (searchInput) {
          searchInput.addEventListener("input", (e) => {
            const value = e.target.value;
            clearBtn.style.display = value ? "block" : "none";

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
              loadMarginData(value);
            }, 300);
          });
        }

        if (clearBtn) {
          clearBtn.addEventListener("click", () => {
            searchInput.value = "";
            clearBtn.style.display = "none";
            loadMarginData();
          });
        }
      }

      // 설정 로드
      async function loadSettings() {
        try {
          const response = await fetch("/settings");
          const data = await response.json();

          if (data.status === "loaded") {
            document.getElementById("settingsInfo").textContent =
              `${data.workers.length}명의 담당자, ${data.total_products}개 상품 규칙`;

            // 담당자 목록은 새 API로 로드
            loadWorkers();
          } else {
            document.getElementById("settingsInfo").textContent =
              "설정 로드 실패";
          }
        } catch (error) {
          console.error("설정 로드 오류:", error);
          document.getElementById("settingsInfo").textContent =
            "설정 로드 오류";
        }
      }

      // 담당자 목록 로드 (새 API)
      async function loadWorkers() {
        try {
          const response = await fetch("/api/workers");
          const data = await response.json();
          renderWorkersList(data.data, data.db_connected);
        } catch (error) {
          console.error("담당자 로드 오류:", error);
          // 폴백: 기존 방식
          try {
            const response = await fetch("/settings");
            const data = await response.json();
            if (data.status === "loaded") {
              renderWorkersListLegacy(data.workers);
            }
          } catch (e) {
            console.error("폴백도 실패:", e);
          }
        }
      }

      // 담당자 목록 렌더링 (새 버전 - DB 지원)
      function renderWorkersList(workers, canEdit) {
        const container = document.getElementById("workersList");

        if (!workers || workers.length === 0) {
          container.innerHTML =
            '<div style="text-align: center; padding: 40px; color: #666;">담당자 데이터가 없습니다</div>';
          return;
        }

        container.innerHTML = workers
          .map(
            (worker) => `
                <div class="worker-item" style="cursor: ${
                  canEdit ? "pointer" : "default"
                };" ${
                  canEdit
                    ? `onclick="openWorkerProducts(${worker.id}, '${
                        worker.name
                      }', '${worker.icon || "📋"}')"`
                    : ""
                }>
                    <span class="worker-item-icon">${worker.icon || "📋"}</span>
                    <div class="worker-item-info">
                        <div class="worker-item-name">${worker.name}</div>
                        <div class="worker-item-desc">${
                          worker.description || ""
                        }</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span style="color: #666; font-size: 13px;">${
                        worker.product_count || 0
                      }개 규칙</span>
                      ${canEdit ? '<span style="color: #00ff88;">▶</span>' : ""}
                    </div>
                </div>
            `,
          )
          .join("");
      }

      // 담당자 목록 렌더링 (레거시 - 하위 호환)
      function renderWorkersListLegacy(workers) {
        const container = document.getElementById("workersList");
        const icons = {
          송과장님: "🍧",
          영재씨: "🍯",
          효상: "🍜",
          강민씨: "🍜",
          부모님: "☕",
          합배송: "📦",
          복수주문: "📋",
          분류실패: "❓",
        };
        const descriptions = {
          송과장님: "팥빙수재료 및 특정 상품 담당",
          영재씨: "미에로화이바, 꿀차, 파우치음료 담당",
          효상: "백제 쌀국수, 떡국 담당",
          강민씨: "백제 브랜드 모든 상품 담당",
          부모님: "쟈뎅, 부국, 린저, 카페재료 담당",
          합배송: "한 주문번호에 여러 다른 상품",
          복수주문: "한 상품을 2개 이상 주문",
          분류실패: "매칭되지 않은 상품 (수동 검토 필요)",
        };

        container.innerHTML = workers
          .map(
            (worker) => `
                <div class="worker-item">
                    <span class="worker-item-icon">${
                      icons[worker] || "📋"
                    }</span>
                    <div class="worker-item-info">
                        <div class="worker-item-name">${worker}</div>
                        <div class="worker-item-desc">${
                          descriptions[worker] || ""
                        }</div>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      // ==================== 담당자 상품 규칙 CRUD ====================
      let currentWorkerId = null;
      let currentWorkerName = "";
      let editingProductId = null;

      async function openWorkerProducts(workerId, workerName, icon) {
        if (!dbConnected) {
          showToast("info", "DB 연결 시에만 수정 가능합니다");
          return;
        }

        currentWorkerId = workerId;
        currentWorkerName = workerName;

        document.getElementById("workerModalIcon").textContent = icon;
        document.getElementById("workerModalTitle").textContent = workerName;
        document.getElementById("workerModalSubtitle").textContent =
          "상품 규칙 관리";
        document.getElementById("workerAddBtnArea").style.display = "block";

        await loadWorkerProducts(workerId);
        document.getElementById("workerProductsModal").classList.add("show");
      }

      async function loadWorkerProducts(workerId) {
        const container = document.getElementById("workerProductsList");
        container.innerHTML =
          '<div style="text-align: center; padding: 20px; color: #666;">로딩중...</div>';

        try {
          const response = await fetch(`/api/workers/${workerId}/products`);
          const data = await response.json();

          if (!data.data || data.data.length === 0) {
            container.innerHTML =
              '<div style="text-align: center; padding: 40px; color: #666;">등록된 상품 규칙이 없습니다</div>';
            return;
          }

          const canEdit = data.db_connected !== false;

          container.innerHTML = data.data
            .map(
              (product) => `
            <div class="worker-product-item" style="display: flex; align-items: center; padding: 12px; background: #222; border-radius: 8px; margin-bottom: 8px;">
              <div style="flex: 1;">
                <div style="color: #00ff88; font-size: 13px; margin-bottom: 4px;">${
                  product.brand || "(브랜드 없음)"
                }</div>
                <div style="font-size: 14px;">${product.product_name}</div>
                <div style="color: #666; font-size: 12px; margin-top: 2px;">옵션: ${
                  product.order_option
                }</div>
              </div>
              ${
                canEdit
                  ? `
              <div style="display: flex; gap: 8px;">
                <button onclick="editWorkerProduct(${product.id}, '${escapeHtml(
                  product.brand || "",
                )}', '${escapeHtml(product.product_name)}', '${escapeHtml(
                  product.order_option,
                )}')" style="padding: 6px 12px; background: #333; border: none; border-radius: 4px; color: #fff; cursor: pointer;">✏️</button>
                <button onclick="deleteWorkerProduct(${
                  product.id
                })" style="padding: 6px 12px; background: #ff4444; border: none; border-radius: 4px; color: #fff; cursor: pointer;">🗑️</button>
              </div>
              `
                  : ""
              }
            </div>
          `,
            )
            .join("");
        } catch (error) {
          console.error("상품 규칙 로드 오류:", error);
          container.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #ff6b6b;">로드 실패</div>';
        }
      }

      function escapeHtml(str) {
        if (!str) return "";
        return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
      }

      function showAddProductForm() {
        document.getElementById("addProductForm").style.display = "block";
        document.getElementById("newBrand").value = "";
        document.getElementById("newProductName").value = "";
        document.getElementById("newOrderOption").value = "";
        document.getElementById("saveProductBtn").textContent = "저장";
        document.getElementById("saveProductBtn").onclick = saveNewProduct;
        editingProductId = null;
      }

      function hideAddProductForm() {
        document.getElementById("addProductForm").style.display = "none";
        editingProductId = null;
      }

      async function saveNewProduct() {
        const brand = document.getElementById("newBrand").value.trim();
        const productName = document
          .getElementById("newProductName")
          .value.trim();
        const orderOption =
          document.getElementById("newOrderOption").value.trim() || "All";

        if (!productName) {
          showToast("error", "상품명을 입력해주세요");
          return;
        }

        try {
          const response = await fetch(
            `/api/workers/${currentWorkerId}/products`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                brand,
                product_name: productName,
                order_option: orderOption,
              }),
            },
          );

          const result = await response.json();

          if (result.success) {
            showToast("success", "상품 규칙이 추가되었습니다");
            hideAddProductForm();
            loadWorkerProducts(currentWorkerId);
            loadSettings();
          } else {
            showToast("error", result.error || "추가 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
      }

      function editWorkerProduct(productId, brand, productName, orderOption) {
        editingProductId = productId;
        document.getElementById("addProductForm").style.display = "block";
        document.getElementById("newBrand").value = brand || "";
        document.getElementById("newProductName").value = productName || "";
        document.getElementById("newOrderOption").value = orderOption || "All";
        document.getElementById("saveProductBtn").textContent = "수정";
        document.getElementById("saveProductBtn").onclick = updateWorkerProduct;
      }

      async function updateWorkerProduct() {
        const brand = document.getElementById("newBrand").value.trim();
        const productName = document
          .getElementById("newProductName")
          .value.trim();
        const orderOption =
          document.getElementById("newOrderOption").value.trim() || "All";

        if (!productName) {
          showToast("error", "상품명을 입력해주세요");
          return;
        }

        try {
          const response = await fetch(
            `/api/workers/${currentWorkerId}/products/${editingProductId}`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                brand,
                product_name: productName,
                order_option: orderOption,
              }),
            },
          );

          const result = await response.json();

          if (result.success) {
            showToast("success", "상품 규칙이 수정되었습니다");
            hideAddProductForm();
            loadWorkerProducts(currentWorkerId);
          } else {
            showToast("error", result.error || "수정 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
      }

      async function deleteWorkerProduct(productId) {
        if (!confirm("이 상품 규칙을 삭제하시겠습니까?")) return;

        try {
          const response = await fetch(
            `/api/workers/${currentWorkerId}/products/${productId}`,
            {
              method: "DELETE",
            },
          );

          const result = await response.json();

          if (result.success) {
            showToast("success", "삭제되었습니다");
            loadWorkerProducts(currentWorkerId);
            loadSettings();
          } else {
            showToast("error", result.error || "삭제 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
      }

      function closeWorkerProductsModal() {
        document.getElementById("workerProductsModal").classList.remove("show");
        hideAddProductForm();
      }

      // ==================== 원가 마진표 CRUD ====================

      function showAddMarginModal() {
        if (!dbConnected) {
          showToast("info", "DB 연결 시에만 추가 가능합니다");
          return;
        }

        document.getElementById("marginModalTitle").textContent = "상품 추가";
        document.getElementById("marginEditId").value = "";

        // 폼 초기화
        document.getElementById("marginName").value = "";
        document.getElementById("marginPrePrice").value = "";
        document.getElementById("marginPostPrice").value = "";
        document.getElementById("marginSupply").value = "1";
        document.getElementById("marginPromo").value = "0";
        document.getElementById("marginIncentive").value = "0";
        document.getElementById("marginShipping").value = "0";
        document.getElementById("marginBox").value = "0";
        document.getElementById("marginPreCost").value = "";
        document.getElementById("marginPostCost").value = "";
        document.getElementById("marginStock").value = "";
        document.getElementById("marginBoxQty").value = "";
        document.getElementById("marginNote").value = "";

        document.getElementById("marginProductModal").classList.add("show");
      }

      function showEditMarginModal(item) {
        if (!dbConnected) {
          showToast("info", "DB 연결 시에만 수정 가능합니다");
          return;
        }

        document.getElementById("marginModalTitle").textContent = "상품 수정";
        document.getElementById("marginEditId").value = item.id;

        document.getElementById("marginName").value = item["상품명"] || "";
        document.getElementById("marginPrePrice").value =
          item["인상전 상품가"] || "";
        document.getElementById("marginPostPrice").value =
          item["인상후 상품가"] || "";
        document.getElementById("marginSupply").value = item["물량지원"] || 1;
        document.getElementById("marginPromo").value =
          item["프로모션할인률"] || 0;
        document.getElementById("marginIncentive").value =
          item["장려금률"] || 0;
        document.getElementById("marginShipping").value = item["배송비"] || 0;
        document.getElementById("marginBox").value = item["박스비"] || 0;
        document.getElementById("marginPreCost").value =
          item["인상전 총 원가"] || "";
        document.getElementById("marginPostCost").value =
          item["인상후 총 원가"] || "";
        document.getElementById("marginStock").value =
          item["인상전 재고"] || "";
        document.getElementById("marginBoxQty").value =
          item["1박스 최대 수량"] || "";
        document.getElementById("marginNote").value = item["기타사항"] || "";

        document.getElementById("marginProductModal").classList.add("show");
      }

      function closeMarginModal() {
        document.getElementById("marginProductModal").classList.remove("show");
      }

      async function saveMarginProduct() {
        const productId = document.getElementById("marginEditId").value;
        const productData = {
          상품명: document.getElementById("marginName").value.trim(),
          "인상전 상품가":
            parseFloat(document.getElementById("marginPrePrice").value) || 0,
          "인상후 상품가":
            parseFloat(document.getElementById("marginPostPrice").value) || 0,
          물량지원:
            parseFloat(document.getElementById("marginSupply").value) || 1,
          프로모션할인률:
            parseFloat(document.getElementById("marginPromo").value) || 0,
          장려금률:
            parseFloat(document.getElementById("marginIncentive").value) || 0,
          배송비:
            parseFloat(document.getElementById("marginShipping").value) || 0,
          박스비: parseFloat(document.getElementById("marginBox").value) || 0,
          "인상전 총 원가":
            parseFloat(document.getElementById("marginPreCost").value) || 0,
          "인상후 총 원가":
            parseFloat(document.getElementById("marginPostCost").value) || 0,
          "인상전 재고": document.getElementById("marginStock").value,
          "1박스 최대 수량": document.getElementById("marginBoxQty").value,
          기타사항: document.getElementById("marginNote").value,
        };

        if (!productData["상품명"]) {
          showToast("error", "상품명을 입력해주세요");
          return;
        }

        try {
          let response;
          if (productId) {
            response = await fetch(`/api/margin/${productId}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(productData),
            });
          } else {
            response = await fetch("/api/margin", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(productData),
            });
          }

          const result = await response.json();

          if (result.success) {
            showToast(
              "success",
              productId ? "수정되었습니다" : "추가되었습니다",
            );
            closeMarginModal();
            loadMarginData(document.getElementById("marginSearch").value);
          } else {
            showToast("error", result.error || "저장 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
      }

      async function deleteMarginProduct(productId) {
        if (!confirm("이 상품을 삭제하시겠습니까?")) return;

        try {
          const response = await fetch(`/api/margin/${productId}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            showToast("success", "삭제되었습니다");
            loadMarginData(document.getElementById("marginSearch").value);
          } else {
            showToast("error", result.error || "삭제 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
      }

      // 네비게이션 설정
      function setupNavigation() {
        // 로고 클릭 시 홈으로 이동
        document.getElementById("logoBtn").addEventListener("click", () => {
          navigateToPage("home");
        });

        // 사이드바 네비게이션
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.addEventListener("click", () => {
            const page = item.dataset.page;
            navigateToPage(page);
          });
        });

        // 모바일 네비게이션
        document.querySelectorAll(".mobile-nav-item").forEach((item) => {
          item.addEventListener("click", (e) => {
            e.preventDefault();
            const page = item.dataset.page;
            navigateToPage(page);
          });
        });
      }

      // 페이지 이동 함수
      function navigateToPage(page) {
        // 사이드바 활성화
        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        const sideNavItem = document.querySelector(
          `.nav-item[data-page="${page}"]`,
        );
        if (sideNavItem) sideNavItem.classList.add("active");

        // 모바일 네비게이션 활성화
        document
          .querySelectorAll(".mobile-nav-item")
          .forEach((n) => n.classList.remove("active"));
        const mobileNavItem = document.querySelector(
          `.mobile-nav-item[data-page="${page}"]`,
        );
        if (mobileNavItem) mobileNavItem.classList.add("active");

        // 페이지 전환
        document
          .querySelectorAll(".page")
          .forEach((p) => (p.style.display = "none"));
        document.getElementById(`page-${page}`).style.display = "block";

        // 페이지별 데이터 로드
        if (page === "margin" && marginData.length === 0) {
          loadMarginData();
        } else if (page === "employees") {
          loadEmployees();
          loadHolidays();
          const now = new Date();
          if (document.getElementById("holidayYear")) {
            document.getElementById("holidayYear").value = now.getFullYear();
            document.getElementById("holidayMonth").value = now.getMonth() + 1;
          }
        } else if (page === "admin-attendance") {
          const now = new Date();
          const currentYear = now.getFullYear();
          const currentMonth = now.getMonth() + 1;

          if (document.getElementById("adminAttYear")) {
            document.getElementById("adminAttYear").value = currentYear;
            document.getElementById("adminAttMonth").value = currentMonth;
          }
          // [수정됨] 명시적으로 연도와 월을 전달하여 즉시 로딩되게 함
          loadAdminAttendance(currentYear, currentMonth);
        } else if (page === "arrival-invoice") {
          initArrivalInvoice();
        } else if (page === "box-inventory") {
          loadBoxInventory();
        }
      }

      // 탭 설정
      function setupTabs() {
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            const tabId = tab.dataset.tab;

            // 탭 활성화
            document
              .querySelectorAll(".tab")
              .forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");

            // 탭 콘텐츠 전환
            document
              .querySelectorAll(".tab-content")
              .forEach((c) => c.classList.remove("active"));
            document.getElementById(`tab-${tabId}`).classList.add("active");
          });
        });
      }

      // 업로드 영역 설정
      function setupUploadAreas() {
        // 송장 분류 업로드
        const classifyArea = document.getElementById("classifyUploadArea");
        const classifyInput = document.getElementById("classifyFileInput");

        classifyArea.addEventListener("click", () => classifyInput.click());
        classifyArea.addEventListener("dragover", handleDragOver);
        classifyArea.addEventListener("dragleave", handleDragLeave);
        classifyArea.addEventListener("drop", (e) => handleDrop(e, "classify"));
        classifyInput.addEventListener("change", (e) =>
          handleFileSelect(e, "classify"),
        );

        // 스타배송 필터 업로드
        const starArea = document.getElementById("starUploadArea");
        const starInput = document.getElementById("starFileInput");

        starArea.addEventListener("click", () => starInput.click());
        starArea.addEventListener("dragover", handleDragOver);
        starArea.addEventListener("dragleave", handleDragLeave);
        starArea.addEventListener("drop", (e) => handleDrop(e, "star"));
        starInput.addEventListener("change", (e) =>
          handleFileSelect(e, "star"),
        );
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add("dragover");
      }

      function handleDragLeave(e) {
        e.currentTarget.classList.remove("dragover");
      }

      function handleDrop(e, type) {
        e.preventDefault();
        e.currentTarget.classList.remove("dragover");

        const file = e.dataTransfer.files[0];
        if (file) {
          processFile(file, type);
        }
      }

      function handleFileSelect(e, type) {
        const file = e.target.files[0];
        if (file) {
          processFile(file, type);
        }
      }

      function processFile(file, type) {
        const validExts = [".xls", ".xlsx"];
        const ext = file.name
          .substring(file.name.lastIndexOf("."))
          .toLowerCase();

        if (!validExts.includes(ext)) {
          showToast("error", ".xls 또는 .xlsx 파일만 업로드 가능합니다");
          return;
        }

        if (type === "classify") {
          selectedFile = file;
          document.getElementById("classifyFileName").textContent = file.name;
          document.getElementById("classifyFileSize").textContent =
            `크기: ${formatFileSize(file.size)}`;
          document.getElementById("classifyFileInfo").classList.add("show");
          document.getElementById("classifyBtn").disabled = false;
        } else {
          document.getElementById("starFileName").textContent = file.name;
          document.getElementById("starFileSize").textContent =
            `크기: ${formatFileSize(file.size)}`;
          document.getElementById("starFileInfo").classList.add("show");
          document.getElementById("starFilterBtn").disabled = false;
        }
      }

      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + " KB";
        return (bytes / (1024 * 1024)).toFixed(2) + " MB";
      }

      // ==================== 면세 자료 정리 ====================

      let taxFreeFiles = [];
      let taxFreeSessionId = null;

      function handleTaxFreeFiles(files) {
        taxFreeFiles = Array.from(files);

        if (taxFreeFiles.length > 0) {
          const totalSize = taxFreeFiles.reduce((sum, f) => sum + f.size, 0);
          document.getElementById("taxFreeFileInfo").classList.add("show");
          document.getElementById("taxFreeFileName").textContent =
            taxFreeFiles.length === 1
              ? taxFreeFiles[0].name
              : `${taxFreeFiles.length}개 파일 선택됨`;
          document.getElementById("taxFreeFileSize").textContent =
            formatFileSize(totalSize);
          document.getElementById("taxFreeProcessBtn").disabled = false;
        }
      }

      function resetTaxFree() {
        taxFreeFiles = [];
        taxFreeSessionId = null;
        document.getElementById("taxFreeInput").value = "";
        document.getElementById("taxFreeFileInfo").classList.remove("show");
        document.getElementById("taxFreeProcessBtn").disabled = true;
        document.getElementById("taxFreeResultSection").style.display = "none";
        document.getElementById("taxFreeUploadSection").style.display = "block";
      }

      async function processTaxFree() {
        if (taxFreeFiles.length === 0) {
          showToast("error", "파일을 선택해주세요");
          return;
        }

        const formData = new FormData();
        taxFreeFiles.forEach((file) => formData.append("files", file));

        document.getElementById("taxFreeProcessBtn").disabled = true;
        document.getElementById("taxFreeProcessBtn").textContent = "처리 중...";

        try {
          const response = await fetch("/api/tax-free/process", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            taxFreeSessionId = result.session_id;
            displayTaxFreeResult(result);
            showToast("success", `면세 데이터 ${result.row_count}건 추출 완료`);
          } else {
            showToast("error", result.error || "처리 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }

        document.getElementById("taxFreeProcessBtn").disabled = false;
        document.getElementById("taxFreeProcessBtn").textContent =
          "🚀 면세 자료 정리 시작";
      }

      function displayTaxFreeResult(result) {
        document.getElementById("taxFreeUploadSection").style.display = "none";
        document.getElementById("taxFreeResultSection").style.display = "block";

        const fileInfo = result.file_info;
        document.getElementById("taxFreeUploadedCount").textContent =
          fileInfo.total_uploaded;
        document.getElementById("taxFreeProcessedCount").textContent =
          fileInfo.processed;
        document.getElementById("taxFreeMonthCount").textContent =
          fileInfo.total_months;

        if (fileInfo.duplicates && fileInfo.duplicates.length > 0) {
          document.getElementById("taxFreeDuplicateInfo").style.display =
            "flex";
          document.getElementById("taxFreeDuplicateCount").textContent =
            fileInfo.duplicates.length;
          document.getElementById("taxFreeDuplicateWarning").style.display =
            "block";

          let dupHtml = "";
          fileInfo.duplicates.forEach((dup) => {
            const monthInfo = dup.month
              ? ` (${dup.month}월 중복)`
              : " (동일 파일)";
            dupHtml += `<div>• ${dup.filename} → ${dup.duplicate_of}${monthInfo}</div>`;
          });
          document.getElementById("taxFreeDuplicateList").innerHTML = dupHtml;
        } else {
          document.getElementById("taxFreeDuplicateInfo").style.display =
            "none";
          document.getElementById("taxFreeDuplicateWarning").style.display =
            "none";
        }

        document.getElementById("taxFreeRowCount").textContent =
          result.row_count.toLocaleString();
        document.getElementById("taxFreeYearlySales").textContent = Math.round(
          result.yearly_summary.free_sales,
        ).toLocaleString();
        document.getElementById("taxFreeTotalSales").textContent = Math.round(
          result.yearly_summary.total_sales,
        ).toLocaleString();

        const tbody = document.getElementById("taxFreeMonthlyTable");
        const tfoot = document.getElementById("taxFreeYearlyTotal");

        const sortedMonths = Object.keys(result.monthly_stats).sort();

        let html = "";
        let totalFileCount = 0;
        sortedMonths.forEach((month) => {
          const stats = result.monthly_stats[month];
          const freeRatio =
            stats.total_count > 0
              ? ((stats.free_count / stats.total_count) * 100).toFixed(1)
              : 0;
          const fileCount = stats.file_count || 1;
          totalFileCount += fileCount;

          const fileCountStyle =
            fileCount > 1
              ? "color: #ff6b6b; font-weight: bold;"
              : "color: #888;";
          const fileCountWarning = fileCount > 1 ? " ⚠️" : "";

          html += `
            <tr style="border-bottom: 1px solid #222;">
              <td style="padding: 14px; color: #fff;">${month}</td>
              <td style="padding: 14px; text-align: center; ${fileCountStyle}" title="${(
                stats.files || []
              ).join(", ")}">${fileCount}개${fileCountWarning}</td>
              <td style="padding: 14px; text-align: right; color: #00ff88;">${stats.free_count.toLocaleString()}건</td>
              <td style="padding: 14px; text-align: right; color: #00ff88;">${Math.round(
                stats.free_sales,
              ).toLocaleString()}원</td>
              <td style="padding: 14px; text-align: right; color: #ffd700;">${stats.total_count.toLocaleString()}건</td>
              <td style="padding: 14px; text-align: right; color: #ffd700;">${Math.round(
                stats.total_sales,
              ).toLocaleString()}원</td>
              <td style="padding: 14px; text-align: right; color: #a855f7;">${freeRatio}%</td>
            </tr>
          `;
        });
        tbody.innerHTML = html;

        const yearly = result.yearly_summary;
        const yearlyRatio =
          yearly.total_count > 0
            ? ((yearly.free_count / yearly.total_count) * 100).toFixed(1)
            : 0;

        tfoot.innerHTML = `
          <tr style="border-top: 2px solid #333;">
            <td style="padding: 14px; color: #fff;">연간 합계</td>
            <td style="padding: 14px; text-align: center; color: #888;">${totalFileCount}개</td>
            <td style="padding: 14px; text-align: right; color: #00ff88; font-weight: bold;">${yearly.free_count.toLocaleString()}건</td>
            <td style="padding: 14px; text-align: right; color: #00ff88; font-weight: bold;">${Math.round(
              yearly.free_sales,
            ).toLocaleString()}원</td>
            <td style="padding: 14px; text-align: right; color: #ffd700; font-weight: bold;">${yearly.total_count.toLocaleString()}건</td>
            <td style="padding: 14px; text-align: right; color: #ffd700; font-weight: bold;">${Math.round(
              yearly.total_sales,
            ).toLocaleString()}원</td>
            <td style="padding: 14px; text-align: right; color: #a855f7; font-weight: bold;">${yearlyRatio}%</td>
          </tr>
        `;
      }

      function downloadTaxFree() {
        if (!taxFreeSessionId) {
          showToast("error", "다운로드할 데이터가 없습니다");
          return;
        }
        window.location.href = `/api/tax-free/download/${taxFreeSessionId}`;
      }

      // 버튼 설정
      function setupButtons() {
        // 분류 시작
        document
          .getElementById("classifyBtn")
          .addEventListener("click", startClassification);

        // 결과 다운로드
        document
          .getElementById("downloadBtn")
          .addEventListener("click", downloadResult);
        document
          .getElementById("modalDownloadBtn")
          .addEventListener("click", downloadResult);

        // 모달 닫기
        document
          .getElementById("modalCloseBtn")
          .addEventListener("click", () => {
            resultModal.classList.remove("show");
          });

        // 스타배송 필터
        document
          .getElementById("starFilterBtn")
          .addEventListener("click", startStarFilter);
      }

      // 분류 시작
      async function startClassification() {
        if (!selectedFile) return;

        showLoading();

        try {
          const formData = new FormData();
          formData.append("file", selectedFile);

          // 스타배송 필터링 체크박스 상태 추가
          const filterStar = document.getElementById("starFilterCheck").checked;
          formData.append("filter_star", filterStar);

          const response = await fetch("/classify", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          hideLoading();

          // 이미 필터링된 파일인 경우 팝업 표시
          if (result.error === "already_filtered") {
            alert(result.message);
            return;
          }

          if (result.success) {
            currentResultId = result.session_id;
            currentStats = result.stats;

            // 결과 모달 표시 (스타배송 메시지 포함)
            showResultModal(result.stats);

            // 분석 탭 업데이트
            updateAnalysisTab(result.stats);

            // 다운로드 버튼 활성화
            document.getElementById("downloadBtn").disabled = false;
          } else {
            showToast("error", result.error || "분류 중 오류가 발생했습니다");
          }
        } catch (error) {
          hideLoading();
          console.error("분류 오류:", error);
          showToast("error", "서버 연결 오류");
        }
      }

      // 결과 다운로드
      function downloadResult() {
        if (!currentResultId) {
          showToast("error", "다운로드할 결과가 없습니다");
          return;
        }

        window.location.href = `/download/${currentResultId}`;
        showToast("success", "다운로드가 시작되었습니다");
      }

      // 스타배송 필터
      async function startStarFilter() {
        const input = document.getElementById("starFileInput");
        if (!input.files[0]) return;

        showLoading();

        try {
          const formData = new FormData();
          formData.append("file", input.files[0]);

          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          hideLoading();

          if (response.ok) {
            const blob = await response.blob();
            const deletedCount = response.headers.get("X-Deleted-Count");

            // 다운로드
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `pa${Date.now()}.xlsx`;
            a.click();
            window.URL.revokeObjectURL(url);

            showToast(
              "success",
              `${deletedCount}개의 스타배송 주문이 삭제되었습니다`,
            );
          } else {
            const error = await response.json();
            showToast("error", error.error || "처리 중 오류가 발생했습니다");
          }
        } catch (error) {
          hideLoading();
          console.error("필터 오류:", error);
          showToast("error", "서버 연결 오류");
        }
      }

      // 결과 모달 표시
      function showResultModal(stats) {
        const summary = stats.summary;

        document.getElementById("statTotal").textContent = summary.total_orders;
        document.getElementById("statSuccess").textContent =
          summary.success_count;
        document.getElementById("statFailed").textContent =
          summary.failed_count;
        document.getElementById("accuracyValue").textContent =
          summary.auto_classification_rate + "%";
        document.getElementById("progressFill").style.width =
          summary.auto_classification_rate + "%";
        document.getElementById("modalSubtitle").textContent =
          `총 ${summary.total_orders}건의 주문이 처리되었습니다`;

        // 스타배송 필터링 메시지 표시
        const starMsgEl = document.getElementById("starFilterMessage");
        if (summary.star_filtered) {
          if (summary.star_deleted > 0) {
            starMsgEl.textContent = `⭐ 총 ${summary.star_deleted}건의 스타배송 주문이 제거되었습니다`;
            starMsgEl.style.color = "#ffd700";
          } else {
            starMsgEl.textContent = `⭐ 따로 제거할 스타배송 주문이 없었습니다`;
            starMsgEl.style.color = "#888";
          }
          starMsgEl.style.display = "block";
        } else {
          starMsgEl.style.display = "none";
        }

        resultModal.classList.add("show");
      }

      // 분석 탭 업데이트
      function updateAnalysisTab(stats) {
        const container = document.getElementById("analysisContent");
        const workers = stats.workers; // 이제 배열로 순서 유지됨

        let html = '<div class="worker-stats">';

        for (const data of workers) {
          if (data.count > 0) {
            html += `
                        <div class="worker-card">
                            <div class="worker-header">
                                <span class="worker-icon">${
                                  data.icon || "📋"
                                }</span>
                                <span class="worker-name">${data.name}</span>
                            </div>
                            <div class="worker-stat-row">
                                <span class="worker-label">총 송장수:</span>
                                <span class="worker-value">${
                                  data.count
                                }건</span>
                            </div>
                            <div class="worker-stat-row">
                                <span class="worker-label">송장 범위:</span>
                                <span class="worker-range">${
                                  data.range
                                    ? data.range.replace(" ~ ", "번 ~ ") + "번"
                                    : "-"
                                }</span>
                            </div>
                        </div>
                    `;
          }
        }

        html += "</div>";
        container.innerHTML = html;
      }

      // 로딩 표시
      function showLoading() {
        loadingOverlay.classList.add("show");
      }

      function hideLoading() {
        loadingOverlay.classList.remove("show");
      }

      // 토스트 표시
      function showToast(type, message) {
        const toastEl = document.getElementById("toast");
        const iconEl = document.getElementById("toastIcon");
        const msgEl = document.getElementById("toastMessage");

        iconEl.textContent = type === "success" ? "✅" : "❌";
        msgEl.textContent = message;

        toastEl.className = `toast show ${type}`;

        setTimeout(() => {
          toastEl.classList.remove("show");
        }, 3000);
      }

      // ==================== 종합 계산기 ====================

      // 계산기 설정
      function setupCalculator() {
        // 계산기 탭 전환
        document.querySelectorAll(".calc-tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            const calcType = tab.dataset.calc;

            // 탭 활성화
            document
              .querySelectorAll(".calc-tab")
              .forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");

            // 콘텐츠 전환
            document
              .querySelectorAll(".calc-content")
              .forEach((c) => c.classList.remove("active"));
            document.getElementById(`calc-${calcType}`).classList.add("active");
          });
        });

        // 마진률 슬라이더
        const slider = document.getElementById("targetMarginSlider");
        const sliderValue = document.getElementById("targetMarginValue");

        if (slider) {
          // 슬라이더 초기값 설정
          updateSliderBackground(slider);

          slider.addEventListener("input", () => {
            sliderValue.textContent = slider.value + "%";
            updateSliderBackground(slider);
            calculatePrice();
          });
        }

        // 판매가 책정기 입력 필드 이벤트
        ["priceCost", "priceShipping", "priceBox"].forEach((id) => {
          const input = document.getElementById(id);
          if (input) {
            input.addEventListener("input", calculatePrice);
          }
        });
      }

      // 슬라이더 배경 업데이트
      function updateSliderBackground(slider) {
        const value = slider.value;
        slider.style.setProperty("--value", value + "%");
        slider.style.background = `linear-gradient(to right, #00ff88 0%, #00ff88 ${value}%, #333 ${value}%)`;
      }

      // 마진 계산기
      function calculateMargin() {
        const salePrice =
          parseFloat(document.getElementById("marginSalePrice").value) || 0;
        const cost =
          parseFloat(document.getElementById("marginCost").value) || 0;
        const shipping =
          parseFloat(document.getElementById("marginShipping").value) || 0;
        const box = parseFloat(document.getElementById("marginBox").value) || 0;

        if (salePrice <= 0) {
          showToast("error", "판매가를 입력해주세요");
          return;
        }

        const totalCost = cost + shipping + box;

        // 플랫폼별 수수료율
        const platforms = {
          coupang: { rate: 0.88, name: "쿠팡" },
          smartstore: { rate: 0.933, name: "스마트스토어" },
          esm: { rate: 0.85, name: "ESM" },
        };

        // 각 플랫폼별 마진 계산
        Object.keys(platforms).forEach((platform) => {
          const rate = platforms[platform].rate;
          const margin = salePrice * rate - totalCost;
          const marginRate = (margin / salePrice) * 100;

          // 마진 표시
          const marginEl = document.getElementById(`${platform}Margin`);
          const rateEl = document.getElementById(`${platform}Rate`);

          marginEl.textContent = formatCurrency(margin) + "원";
          rateEl.textContent = marginRate.toFixed(1) + "%";

          // 음수면 빨간색
          if (margin < 0) {
            marginEl.classList.add("negative");
            rateEl.classList.remove("highlight");
            rateEl.classList.add("negative");
          } else {
            marginEl.classList.remove("negative");
            rateEl.classList.add("highlight");
            rateEl.classList.remove("negative");
          }
        });

        // 결과 표시
        document.getElementById("marginResults").style.display = "flex";
      }

      // 판매가 책정기
      function calculatePrice() {
        const cost =
          parseFloat(document.getElementById("priceCost").value) || 0;
        const shipping =
          parseFloat(document.getElementById("priceShipping").value) || 0;
        const box = parseFloat(document.getElementById("priceBox").value) || 0;
        const targetMargin =
          parseFloat(document.getElementById("targetMarginSlider").value) / 100;

        const totalCost = cost + shipping + box;

        if (totalCost <= 0) {
          document.getElementById("coupangPrice").textContent = "0원";
          document.getElementById("smartstorePrice").textContent = "0원";
          document.getElementById("esmPrice").textContent = "0원";
          return;
        }

        // 플랫폼별 수수료율 (판매가 대비 수취율)
        const platforms = {
          coupang: { rate: 0.88 }, // 12% 수수료
          smartstore: { rate: 0.933 }, // 6.7% 수수료
          esm: { rate: 0.85 }, // 15% 수수료
        };

        // 판매가 = 원가총합 / (수취율 - 마진률)
        // 마진 = 판매가 * 마진률
        // 수취금액 = 판매가 * 수취율 = 원가총합 + 마진
        Object.keys(platforms).forEach((platform) => {
          const feeRate = platforms[platform].rate;
          let price = 0;

          // 수취율 - 마진률이 0보다 커야 함
          const denominator = feeRate - targetMargin;

          if (denominator > 0) {
            price = totalCost / denominator;
          } else {
            price = 0; // 불가능한 마진률
          }

          const priceEl = document.getElementById(`${platform}Price`);

          if (price > 0 && isFinite(price)) {
            priceEl.textContent = formatCurrency(Math.ceil(price)) + "원";
            priceEl.style.color = "#00ff88";
          } else {
            priceEl.textContent = "계산불가";
            priceEl.style.color = "#ff6b6b";
          }
        });
      }

      // 통화 포맷
      function formatCurrency(num) {
        return Math.round(num).toLocaleString();
      }

      // ==================== 직원 관리 ====================

      let employeesData = [];

      // 직원 목록 로드
      async function loadEmployees() {
        showLoading(); // [추가] 로딩 시작
        try {
          const response = await fetch("/api/employees");
          const result = await response.json();

          if (result.success) {
            employeesData = result.data;
            renderEmployeeList();
          } else {
            document.getElementById("employeeList").innerHTML =
              '<div style="text-align: center; padding: 20px; color: #ff6b6b;">로드 실패</div>';
          }
        } catch (error) {
          console.error("직원 로드 오류:", error);
        } finally {
          hideLoading(); // [추가] 로딩 종료
        }
      }

      function renderEmployeeList() {
        const container = document.getElementById("employeeList");

        if (!employeesData.length) {
          container.innerHTML =
            '<div style="text-align: center; padding: 40px; color: #666;">등록된 직원이 없습니다</div>';
          return;
        }

        let html = '<div style="display: grid; gap: 15px;">';

        employeesData.forEach((emp) => {
          const statusBadge = emp.enabled
            ? '<span style="background: rgba(0,255,136,0.2); color: #00ff88; padding: 4px 10px; border-radius: 12px; font-size: 12px;">활성</span>'
            : '<span style="background: rgba(255,107,107,0.2); color: #ff6b6b; padding: 4px 10px; border-radius: 12px; font-size: 12px;">비활성</span>';

          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #1a1a1a; border-radius: 12px;">
              <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 45px; height: 45px; background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">👤</div>
                <div>
                  <div style="font-weight: 600; margin-bottom: 4px;">${
                    emp.name
                  } ${statusBadge}</div>
                  <div style="color: #666; font-size: 13px;">ID: ${
                    emp.username
                  } | 시급: ${emp.hourly_wage.toLocaleString()}원 | 만근: ${(
                    emp.full_attendance_bonus || 100000
                  ).toLocaleString()}원</div>
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="showEditEmployeeModal(${
                  emp.id
                })" style="padding: 8px 12px; background: #333; border: none; border-radius: 6px; color: #fff; cursor: pointer;">✏️ 수정</button>
                <button onclick="toggleEmployeeStatus(${emp.id}, ${
                  emp.enabled
                })" style="padding: 8px 12px; background: ${
                  emp.enabled ? "#ff4444" : "#00cc6a"
                }; border: none; border-radius: 6px; color: #fff; cursor: pointer;">
                  ${emp.enabled ? "🚫 비활성화" : "✅ 활성화"}
                </button>
              </div>
            </div>
          `;
        });

        html += "</div>";
        container.innerHTML = html;
      }

      function showAddEmployeeModal() {
        const modal = `
          <div class="modal-overlay show" id="employeeModal" onclick="if(event.target===this)this.remove()">
            <div class="modal" style="max-width: 500px;">
              <div class="modal-header">
                <div class="modal-icon">👤</div>
                <div class="modal-title">직원 추가</div>
              </div>
              <div style="display: grid; gap: 15px; padding: 20px 0;">
                <div>
                  <label style="display: block; color: #888; font-size: 13px; margin-bottom: 5px;">이름 *</label>
                  <input type="text" id="empName" placeholder="이름" style="width: 100%; padding: 12px; background: #222; border: 1px solid #333; border-radius: 8px; color: #fff; box-sizing: border-box;">
                </div>
                <div>
                  <label style="display: block; color: #888; font-size: 13px; margin-bottom: 5px;">아이디 *</label>
                  <input type="text" id="empUsername" placeholder="로그인 아이디" style="width: 100%; padding: 12px; background: #222; border: 1px solid #333; border-radius: 8px; color: #fff; box-sizing: border-box;">
                </div>
                <div>
                  <label style="display: block; color: #888; font-size: 13px; margin-bottom: 5px;">비밀번호 *</label>
                  <input type="password" id="empPassword" placeholder="비밀번호" style="width: 100%; padding: 12px; background: #222; border: 1px solid #333; border-radius: 8px; color: #fff; box-sizing: border-box;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; color: #888; font-size: 13px; margin-bottom: 5px;">시급</label>
                    <input type="number" id="empWage" value="10700" style="width: 100%; padding: 12px; background: #222; border: 1px solid #333; border-radius: 8px; color: #fff; box-sizing: border-box;">
                  </div>
                  <div>
                    <label style="display: block; color: #888; font-size: 13px; margin-bottom: 5px;">만근수당</label>
                    <input type="number" id="empBonus" value="100000" style="width: 100%; padding: 12px; background: #222; border: 1px solid #333; border-radius: 8px; color: #fff; box-sizing: border-box;">
                  </div>
                </div>
                <div>
                  <label style="display: block; color: #888; font-size: 13px; margin-bottom: 8px;">소정근로일</label>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <div class="day-toggle selected" data-day="1" onclick="toggleDay(this)" style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: #00ff88; color: #000; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">월</div>
                    <div class="day-toggle selected" data-day="2" onclick="toggleDay(this)" style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: #00ff88; color: #000; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">화</div>
                    <div class="day-toggle selected" data-day="3" onclick="toggleDay(this)" style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: #00ff88; color: #000; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">수</div>
                    <div class="day-toggle selected" data-day="4" onclick="toggleDay(this)" style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: #00ff88; color: #000; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">목</div>
                    <div class="day-toggle selected" data-day="5" onclick="toggleDay(this)" style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: #00ff88; color: #000; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">금</div>
                    <div class="day-toggle" data-day="6" onclick="toggleDay(this)" style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: #222; color: #666; border: 1px solid #333; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">토</div>
                    <div class="day-toggle" data-day="0" onclick="toggleDay(this)" style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: #222; color: #666; border: 1px solid #333; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">일</div>
                  </div>
                </div>
              </div>
              <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveEmployee()">저장</button>
                <button class="btn btn-outline" onclick="document.getElementById('employeeModal').remove()">취소</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML("beforeend", modal);
      }

      function toggleDay(el) {
        const isSelected = el.classList.contains("selected");
        if (isSelected) {
          el.classList.remove("selected");
          el.style.background = "#222";
          el.style.color = "#666";
          el.style.border = "1px solid #333";
        } else {
          el.classList.add("selected");
          el.style.background = "#00ff88";
          el.style.color = "#000";
          el.style.border = "none";
        }
      }

      function getSelectedDays() {
        const dayToggles = document.querySelectorAll(
          "#employeeModal .day-toggle.selected",
        );
        const days = [];
        dayToggles.forEach((el) => days.push(el.dataset.day));
        return days.join(",");
      }

      function showEditEmployeeModal(empId) {
        const emp = employeesData.find((e) => e.id === empId);
        if (!emp) return;

        const scheduledDays = (emp.scheduled_days || "1,2,3,4,5").split(",");
        const dayNames = ["일", "월", "화", "수", "목", "금", "토"];

        let dayToggles = "";
        [1, 2, 3, 4, 5, 6, 0].forEach((dayNum) => {
          const isSelected = scheduledDays.includes(String(dayNum));
          const bgColor = isSelected ? "#00ff88" : "#222";
          const textColor = isSelected ? "#000" : "#666";
          const border = isSelected ? "none" : "1px solid #333";
          const selectedClass = isSelected ? "selected" : "";
          // 역슬래시(\)를 모두 제거했습니다.
          dayToggles += `<div class="day-toggle ${selectedClass}" data-day="${dayNum}" onclick="toggleDay(this)" style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: ${bgColor}; color: ${textColor}; border: ${border}; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">${dayNames[dayNum]}</div>`;
        });

        const modal = `
          <div class="modal-overlay show" id="employeeModal" onclick="if(event.target===this)this.remove()">
            <div class="modal" style="max-width: 500px;">
              <div class="modal-header">
                <div class="modal-icon">✏️</div>
                <div class="modal-title">직원 수정</div>
              </div>
              <div style="display: grid; gap: 15px; padding: 20px 0;">
                <input type="hidden" id="empId" value="${emp.id}">
                <div>
                  <label style="display: block; color: #888; font-size: 13px; margin-bottom: 5px;">이름</label>
                  <input type="text" id="empName" value="${
                    emp.name
                  }" style="width: 100%; padding: 12px; background: #222; border: 1px solid #333; border-radius: 8px; color: #fff; box-sizing: border-box;">
                </div>
                <div>
                  <label style="display: block; color: #888; font-size: 13px; margin-bottom: 5px;">아이디 (변경 불가)</label>
                  <input type="text" value="${
                    emp.username
                  }" disabled style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #222; border-radius: 8px; color: #666; box-sizing: border-box;">
                </div>
                <div>
                  <label style="display: block; color: #888; font-size: 13px; margin-bottom: 5px;">새 비밀번호 (변경 시에만)</label>
                  <input type="password" id="empPassword" placeholder="변경할 비밀번호" style="width: 100%; padding: 12px; background: #222; border: 1px solid #333; border-radius: 8px; color: #fff; box-sizing: border-box;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; color: #888; font-size: 13px; margin-bottom: 5px;">시급</label>
                    <input type="number" id="empWage" value="${
                      emp.hourly_wage
                    }" style="width: 100%; padding: 12px; background: #222; border: 1px solid #333; border-radius: 8px; color: #fff; box-sizing: border-box;">
                  </div>
                  <div>
                    <label style="display: block; color: #888; font-size: 13px; margin-bottom: 5px;">만근수당</label>
                    <input type="number" id="empBonus" value="${
                      emp.full_attendance_bonus || 100000
                    }" style="width: 100%; padding: 12px; background: #222; border: 1px solid #333; border-radius: 8px; color: #fff; box-sizing: border-box;">
                  </div>
                </div>
                <div>
                  <label style="display: block; color: #888; font-size: 13px; margin-bottom: 8px;">소정근로일</label>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    ${dayToggles}
                  </div>
                </div>
              </div>
              <div class="modal-actions">
                <button class="btn btn-primary" onclick="updateEmployee()">저장</button>
                <button class="btn btn-outline" onclick="document.getElementById('employeeModal').remove()">취소</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML("beforeend", modal);
      }

      async function saveEmployee() {
        const data = {
          name: document.getElementById("empName").value.trim(),
          username: document.getElementById("empUsername").value.trim(),
          password: document.getElementById("empPassword").value,
          hourly_wage:
            parseInt(document.getElementById("empWage").value) || 10700,
          full_attendance_bonus:
            parseInt(document.getElementById("empBonus").value) || 100000,
          scheduled_days: getSelectedDays() || "1,2,3,4,5",
        };

        if (!data.name || !data.username || !data.password) {
          showToast("error", "필수 항목을 입력해주세요");
          return;
        }

        try {
          const response = await fetch("/api/employees", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success) {
            showToast("success", "직원이 추가되었습니다");
            document.getElementById("employeeModal").remove();
            loadEmployees();
          } else {
            showToast("error", result.error || "추가 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
      }

      async function updateEmployee() {
        const empId = document.getElementById("empId").value;
        const data = {
          name: document.getElementById("empName").value.trim(),
          password: document.getElementById("empPassword").value || undefined,
          hourly_wage:
            parseInt(document.getElementById("empWage").value) || 10700,
          full_attendance_bonus:
            parseInt(document.getElementById("empBonus").value) || 100000,
          scheduled_days: getSelectedDays() || "1,2,3,4,5",
        };

        try {
          const response = await fetch(`/api/employees/${empId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success) {
            showToast("success", "직원 정보가 수정되었습니다");
            document.getElementById("employeeModal").remove();
            loadEmployees();
          } else {
            showToast("error", result.error || "수정 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
      }

      async function toggleEmployeeStatus(empId, currentStatus) {
        const action = currentStatus ? "비활성화" : "활성화";
        if (!confirm(`이 직원을 ${action}하시겠습니까?`)) return;

        try {
          const response = await fetch(`/api/employees/${empId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ enabled: !currentStatus }),
          });

          const result = await response.json();

          if (result.success) {
            showToast("success", `직원이 ${action}되었습니다`);
            loadEmployees();
          } else {
            showToast("error", result.error || "처리 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
      }

      // ==================== 공휴일 관리 ====================

      let holidaysData = [];

      // 공휴일 로드
      async function loadHolidays() {
        showLoading(); // [추가]
        const year =
          document.getElementById("holidayYear")?.value ||
          new Date().getFullYear();
        const month =
          document.getElementById("holidayMonth")?.value ||
          new Date().getMonth() + 1;

        try {
          const response = await fetch(
            `/api/holidays?year=${year}&month=${month}`,
          );
          const result = await response.json();

          if (result.success) {
            holidaysData = result.data;
            renderHolidayList();
          }
        } catch (error) {
          console.error("공휴일 로드 오류:", error);
        } finally {
          hideLoading(); // [추가]
        }
      }

      function renderHolidayList() {
        const container = document.getElementById("holidayList");

        if (!holidaysData.length) {
          container.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #666;">등록된 공휴일이 없습니다</div>';
          return;
        }

        let html = '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';

        holidaysData.forEach((h) => {
          const dateObj = new Date(h.holiday_date);
          const dayNames = ["일", "월", "화", "수", "목", "금", "토"];
          html += `
            <div style="display: inline-flex; align-items: center; gap: 10px; padding: 10px 15px; background: #222; border-radius: 8px;">
              <span>📅 ${dateObj.getMonth() + 1}/${dateObj.getDate()} (${
                dayNames[dateObj.getDay()]
              }) - ${h.name}</span>
              <button onclick="deleteHoliday(${
                h.id
              })" style="background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 16px;">✕</button>
            </div>
          `;
        });

        html += "</div>";
        container.innerHTML = html;
      }

      function showAddHolidayModal() {
        const modal = `
          <div class="modal-overlay show" id="holidayModal" onclick="if(event.target===this)this.remove()">
            <div class="modal" style="max-width: 400px;">
              <div class="modal-header">
                <div class="modal-icon">📅</div>
                <div class="modal-title">공휴일 추가</div>
              </div>
              <div style="display: grid; gap: 15px; padding: 20px 0;">
                <div>
                  <label style="display: block; color: #888; font-size: 13px; margin-bottom: 5px;">날짜 *</label>
                  <input type="date" id="holidayDate" style="width: 100%; padding: 12px; background: #222; border: 1px solid #333; border-radius: 8px; color: #fff; box-sizing: border-box;">
                </div>
                <div>
                  <label style="display: block; color: #888; font-size: 13px; margin-bottom: 5px;">공휴일명</label>
                  <input type="text" id="holidayName" placeholder="예: 설날, 추석" style="width: 100%; padding: 12px; background: #222; border: 1px solid #333; border-radius: 8px; color: #fff; box-sizing: border-box;">
                </div>
              </div>
              <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveHoliday()">추가</button>
                <button class="btn btn-outline" onclick="document.getElementById('holidayModal').remove()">취소</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML("beforeend", modal);
      }

      async function saveHoliday() {
        const date = document.getElementById("holidayDate").value;
        const name =
          document.getElementById("holidayName").value.trim() || "공휴일";

        if (!date) {
          showToast("error", "날짜를 선택해주세요");
          return;
        }

        try {
          const response = await fetch("/api/holidays", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ date, name }),
          });

          const result = await response.json();

          if (result.success) {
            showToast("success", "공휴일이 추가되었습니다");
            document.getElementById("holidayModal").remove();
            loadHolidays();
          } else {
            showToast("error", result.error || "추가 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
      }

      async function deleteHoliday(holidayId) {
        if (!confirm("이 공휴일을 삭제하시겠습니까?")) return;

        try {
          const response = await fetch(`/api/holidays/${holidayId}`, {
            method: "DELETE",
          });
          const result = await response.json();

          if (result.success) {
            showToast("success", "공휴일이 삭제되었습니다");
            loadHolidays();
          } else {
            showToast("error", result.error || "삭제 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
      }

      // ==================== 직원 출퇴근일지 (관리자) ====================

      let adminAttendanceData = [];
      let adminPendingRequests = []; // 직원들의 대기중인 수정 요청

      // 직원 출퇴근일지 로드
      async function loadAdminAttendance(y, m) {
        showLoading(); // [추가]
        const year =
          y ||
          document.getElementById("adminAttYear")?.value ||
          new Date().getFullYear();
        const month =
          m ||
          document.getElementById("adminAttMonth")?.value ||
          new Date().getMonth() + 1;
        try {
          const [attResponse, reqResponse] = await Promise.all([
            fetch(`/api/admin/attendance?year=${year}&month=${month}`),
            fetch("/api/attendance-edit-requests?status=pending"),
          ]);

          const attResult = await attResponse.json();
          const reqResult = await reqResponse.json();

          if (attResult.success) {
            adminAttendanceData = attResult.data;
            adminPendingRequests = reqResult.success
              ? reqResult.data || []
              : [];
            renderAdminAttendance();
          } else {
            document.getElementById("adminAttendanceList").innerHTML =
              '<div style="text-align: center; padding: 20px; color: #ff6b6b;">로드 실패</div>';
          }
        } catch (error) {
          console.error("출퇴근 로드 오류:", error);
        } finally {
          hideLoading(); // [추가]
        }
      }

      function renderAdminAttendance() {
        const container = document.getElementById("adminAttendanceList");

        if (!adminAttendanceData.length) {
          container.innerHTML =
            '<div style="text-align: center; padding: 40px; color: #666;">등록된 직원이 없습니다</div>';
          return;
        }

        let html = "";

        adminAttendanceData.forEach((empData) => {
          const emp = empData.employee;
          const records = empData.records;
          const isConfirmed = empData.is_confirmed;
          const confirmation = empData.confirmation;

          // 요약 계산
          let totalHours = 0;
          let workDays = 0;
          let incompleteCount = 0;
          let basePay = 0;
          let overtimePay = 0;

          records.forEach((r) => {
            if (r.clock_in && r.clock_out) {
              workDays++;
              const [inH, inM] = r.clock_in.split(":").map(Number);
              const [outH, outM] = r.clock_out.split(":").map(Number);
              let mins = outH * 60 + outM - (inH * 60 + inM);
              // 점심시간 공제
              if (inH < 13 && outH >= 12) mins -= 60;
              totalHours += mins / 60;

              // 급여 계산 (정규 8시간 기준)
              const dailyHours = mins / 60;
              const regularHours = Math.min(dailyHours, 8);
              const overtimeHours = Math.max(0, dailyHours - 8);
              const multiplier = r.is_holiday_work ? 1.5 : 1.0;
              basePay += regularHours * emp.hourly_wage * multiplier;
              overtimePay += overtimeHours * emp.hourly_wage * 1.5 * multiplier;
            } else if (r.clock_in || r.clock_out) {
              incompleteCount++;
            }
          });

          const estimatedPay = empData.salary_breakdown
            ? empData.salary_breakdown.total_pay
            : Math.round(basePay + overtimePay);

          html += `
            <div style="background: #1a1a1a; border-radius: 12px; margin-bottom: 20px; overflow: hidden;">
              <div style="padding: 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="flex: 1; min-width: 200px;">
                  <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                    ${emp.name}
                    ${
                      isConfirmed
                        ? '<span style="background: rgba(0,255,136,0.2); color: #00ff88; padding: 4px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px;">확정됨</span>'
                        : ""
                    }
                  </div>
                  <div style="display: flex; flex-wrap: wrap; gap: 15px; color: #888; font-size: 13px;">
                    <span>📅 출근 <strong style="color: #00ff88;">${workDays}일</strong></span>
                    <span>⏱️ 근무 <strong style="color: #00ff88;">${totalHours.toFixed(
                      1,
                    )}시간</strong></span>
                    <span>💰 예상 <strong style="color: #ffd700;">${estimatedPay.toLocaleString()}원</strong></span>
                    ${
                      incompleteCount > 0
                        ? `<span style="color: #ff6b6b;">⚠️ 미완료 ${incompleteCount}건</span>`
                        : ""
                    }
                  </div>
                </div>
                <button onclick="toggleAttendanceDetail(${
                  emp.id
                })" style="padding: 10px 20px; background: #333; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 14px;">
                  📋 상세보기
                </button>
              </div>

              ${
                isConfirmed
                  ? `
                <div style="padding: 15px 20px; background: rgba(0,255,136,0.05); border-top: 1px solid rgba(0,255,136,0.2);">
                  <div style="color: #00ff88; font-weight: 500;">✅ ${
                    emp.name
                  }님은 이번달 급여에 동의하였습니다.</div>
                  <div style="color: #888; font-size: 13px; margin-top: 5px;">
                    확정 금액: ${(
                      confirmation?.total_amount || 0
                    ).toLocaleString()}원 |
                    확정일: ${new Date(
                      confirmation?.confirmed_at,
                    ).toLocaleString()}
                  </div>
                </div>
              `
                  : ""
              }

              <div id="detail-${
                emp.id
              }" style="display: none; padding: 15px 20px; max-height: 400px; overflow-y: auto;">
                ${renderAttendanceDetailTable(
                  records,
                  emp.id,
                  adminPendingRequests.filter((r) => r.employee_id === emp.id),
                )}
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      function renderAttendanceDetailTable(
        records,
        empId,
        pendingRequests = [],
      ) {
        if (!records.length) {
          return '<div style="text-align: center; padding: 20px; color: #666;">출퇴근 기록이 없습니다</div>';
        }

        // pending 요청을 날짜별로 맵핑
        const pendingByDate = {};
        pendingRequests.forEach((req) => {
          pendingByDate[req.request_date] = req;
        });

        let html = `
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #222;">
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #333;">날짜</th>
                <th style="padding: 10px; text-align: center; border-bottom: 1px solid #333;">출근</th>
                <th style="padding: 10px; text-align: center; border-bottom: 1px solid #333;">퇴근</th>
                <th style="padding: 10px; text-align: center; border-bottom: 1px solid #333;">근무시간</th>
                <th style="padding: 10px; text-align: center; border-bottom: 1px solid #333;">수정승인</th>
              </tr>
            </thead>
            <tbody>
        `;

        records.forEach((r) => {
          const isIncomplete =
            (r.clock_in && !r.clock_out) || (!r.clock_in && r.clock_out);
          const rowStyle = isIncomplete
            ? "background: rgba(255,107,107,0.1);"
            : "";

          let hours = "-";
          if (r.clock_in && r.clock_out) {
            const [inH, inM] = r.clock_in.split(":").map(Number);
            const [outH, outM] = r.clock_out.split(":").map(Number);
            let mins = outH * 60 + outM - (inH * 60 + inM);
            if (inH < 13 && outH >= 12) mins -= 60;
            hours = (mins / 60).toFixed(1) + "h";
          }

          // 해당 날짜에 수정 요청이 있는지 확인
          const hasPendingRequest = !!pendingByDate[r.work_date];
          let approvalCell = '<span style="color: #666;">-</span>';

          if (hasPendingRequest) {
            approvalCell = `<button onclick="approveEdit(${empId}, '${r.work_date}')" style="padding: 4px 8px; background: #ffd700; border: none; border-radius: 4px; color: #000; cursor: pointer; font-size: 12px; font-weight: 500;">승인</button>`;
          }

          html += `
            <tr style="${rowStyle}">
              <td style="padding: 10px; border-bottom: 1px solid #222;">${
                r.work_date
              }</td>
              <td style="padding: 10px; text-align: center; border-bottom: 1px solid #222;">${
                r.clock_in ? r.clock_in.substring(0, 5) : "-"
              }</td>
              <td style="padding: 10px; text-align: center; border-bottom: 1px solid #222;">${
                r.clock_out ? r.clock_out.substring(0, 5) : "-"
              }</td>
              <td style="padding: 10px; text-align: center; border-bottom: 1px solid #222; color: #00ff88;">${hours}</td>
              <td style="padding: 10px; text-align: center; border-bottom: 1px solid #222;">
                ${approvalCell}
              </td>
            </tr>
          `;
        });

        html += "</tbody></table>";
        return html;
      }

      function toggleAttendanceDetail(empId) {
        const detail = document.getElementById(`detail-${empId}`);
        if (detail) {
          detail.style.display =
            detail.style.display === "none" ? "block" : "none";
        }
      }

      async function approveEdit(empId, date) {
        if (
          !confirm(
            `${date} 출퇴근 기록 수정을 승인하시겠습니까?\n(해당 수정 요청이 반영됩니다)`,
          )
        )
          return;

        try {
          // 먼저 해당 날짜의 수정 요청을 찾아서 승인
          const pendingReq = adminPendingRequests.find(
            (r) => r.employee_id === empId && r.request_date === date,
          );

          if (pendingReq) {
            // 수정 요청 승인 API 호출
            const response = await fetch(
              `/api/attendance-edit-request/${pendingReq.id}/approve`,
              {
                method: "POST",
              },
            );

            const result = await response.json();

            if (result.success) {
              showToast("success", `${date} 수정 요청이 승인되었습니다`);
              loadAdminAttendance(); // 데이터 새로고침
              loadEditRequests(); // 수정 요청 목록도 새로고침
            } else {
              showToast("error", result.error || "승인 실패");
            }
          } else {
            showToast("error", "해당 날짜의 수정 요청을 찾을 수 없습니다");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
      }

      // ==================== 출퇴근 수정 요청 관리 ====================

      let editRequests = [];
      let currentViewingRequest = null;

      async function loadEditRequests() {
        try {
          const response = await fetch(
            "/api/attendance-edit-requests?status=pending",
          );
          const result = await response.json();

          if (result.success) {
            editRequests = result.data || [];
            renderEditRequests();
          }
        } catch (error) {
          console.error("수정 요청 로드 실패:", error);
        }
      }

      function renderEditRequests() {
        const list = document.getElementById("requestList");
        const badge = document.getElementById("requestBadge");

        if (!list) return;

        if (editRequests.length === 0) {
          badge.style.display = "none";
          list.innerHTML = `
            <div class="dashboard-empty">
              <div class="dashboard-empty-icon">✨</div>
              <div class="dashboard-empty-text">새로운 요청이 없습니다</div>
            </div>
          `;
          return;
        }

        badge.style.display = "inline";
        badge.textContent = editRequests.length;

        let html = "";
        editRequests.forEach((req) => {
          const [y, m, d] = req.request_date.split("-");
          const empName = req.users?.name || "직원";
          const createdAt = new Date(req.created_at);
          const timeAgo = getTimeAgo(createdAt);

          html += `
            <div class="request-item" onclick="viewEditRequest(${req.id})">
              <div class="request-item-header">
                <div class="request-employee">
                  <span>👤</span> ${empName}
                </div>
                <div class="request-time">${timeAgo}</div>
              </div>
              <div class="request-detail">
                <span>${parseInt(m)}월 ${parseInt(d)}일</span> 출퇴근 수정 요청
              </div>
            </div>
          `;
        });

        list.innerHTML = html;
      }

      function getTimeAgo(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return "방금 전";
        if (minutes < 60) return `${minutes}분 전`;
        if (hours < 24) return `${hours}시간 전`;
        if (days < 7) return `${days}일 전`;
        return date.toLocaleDateString();
      }

      function viewEditRequest(requestId) {
        const req = editRequests.find((r) => r.id === requestId);
        if (!req) return;

        currentViewingRequest = req;

        const [y, m, d] = req.request_date.split("-");
        const empName = req.users?.name || "직원";

        document.getElementById("editRequestViewSubtitle").textContent =
          `${empName} - ${parseInt(m)}월 ${parseInt(d)}일`;
        document.getElementById("viewOldClockIn").textContent = req.old_clock_in
          ? req.old_clock_in.substring(0, 5)
          : "--:--";
        document.getElementById("viewOldClockOut").textContent =
          req.old_clock_out ? req.old_clock_out.substring(0, 5) : "--:--";
        document.getElementById("viewNewClockIn").textContent = req.new_clock_in
          ? req.new_clock_in.substring(0, 5)
          : "--:--";
        document.getElementById("viewNewClockOut").textContent =
          req.new_clock_out ? req.new_clock_out.substring(0, 5) : "--:--";
        document.getElementById("viewReason").textContent = req.reason;

        document.getElementById("editRequestViewModal").style.display = "flex";
      }

      function closeEditRequestViewModal() {
        document.getElementById("editRequestViewModal").style.display = "none";
        currentViewingRequest = null;
      }

      async function approveEditRequest() {
        if (!currentViewingRequest) return;

        if (!confirm("이 수정 요청을 승인하시겠습니까?")) return;

        const requestId = currentViewingRequest.id;
        showLoading();
        closeEditRequestViewModal();

        try {
          const response = await fetch(
            `/api/attendance-edit-request/${requestId}/approve`,
            {
              method: "POST",
            },
          );

          const result = await response.json();

          if (result.success) {
            showToast("success", "수정 요청이 승인되었습니다");
            loadEditRequests();
          } else {
            showToast("error", result.error || "승인 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
        hideLoading();
      }

      function rejectEditRequest() {
        if (!currentViewingRequest) return;

        document.getElementById("editRequestViewModal").style.display = "none";
        document.getElementById("rejectReasonInput").value = "";
        document.getElementById("rejectReasonModal").style.display = "flex";
      }

      function closeRejectReasonModal() {
        document.getElementById("rejectReasonModal").style.display = "none";
      }

      async function submitRejectReason() {
        const reason = document
          .getElementById("rejectReasonInput")
          .value.trim();

        if (!reason) {
          showToast("error", "거절 사유를 입력해주세요");
          return;
        }

        if (!currentViewingRequest) return;

        const requestId = currentViewingRequest.id;
        showLoading();
        closeRejectReasonModal();

        try {
          const response = await fetch(
            `/api/attendance-edit-request/${requestId}/reject`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ reject_reason: reason }),
            },
          );

          const result = await response.json();

          if (result.success) {
            showToast("success", "수정 요청이 거절되었습니다");
            loadEditRequests();
          } else {
            showToast("error", result.error || "거절 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
        hideLoading();
        currentViewingRequest = null;
      }

      // ==================== 메모장 기능 ====================
      let memoData = [];
      let currentMemoId = null;
      let currentMemoPinned = false;

      async function loadMemos() {
        try {
          const response = await fetch("/api/memos");
          const result = await response.json();
          if (result.success) {
            memoData = result.data;
            renderMemos();
          }
        } catch (error) {
          console.error("메모 로드 오류:", error);
        }
      }

      function renderMemos() {
        const container = document.getElementById("memoList");
        if (!container) return;

        if (!memoData.length) {
          container.innerHTML = `
            <div class="dashboard-empty">
              <div class="dashboard-empty-icon">📝</div>
              <div class="dashboard-empty-text">메모가 없습니다</div>
            </div>
          `;
          return;
        }

        let html = "";
        memoData.forEach((memo) => {
          const updatedAt = new Date(memo.updated_at).toLocaleDateString();
          html += `
            <div class="memo-item ${memo.is_pinned ? "pinned" : ""}" onclick="openMemoModal(${memo.id})">
              <div class="memo-item-header">
                ${memo.is_pinned ? '<span class="memo-pin-icon">📌</span>' : ""}
                <div class="memo-title">${escapeHtml(memo.title)}</div>
              </div>
              <div class="memo-content">${escapeHtml(memo.content || "")}</div>
              <div class="memo-date">${updatedAt}</div>
            </div>
          `;
        });
        container.innerHTML = html;
      }

      function openMemoModal(memoId = null) {
        const modal = document.getElementById("memoModal");
        const titleInput = document.getElementById("memoTitleInput");
        const contentInput = document.getElementById("memoContentInput");
        const pinBtn = document.getElementById("memoPinBtn");
        const deleteBtn = document.getElementById("memoDeleteBtn");
        const dateInfo = document.getElementById("memoDateInfo");

        currentMemoId = memoId;

        if (memoId) {
          const memo = memoData.find((m) => m.id === memoId);
          if (memo) {
            titleInput.value = memo.title;
            contentInput.value = memo.content || "";
            currentMemoPinned = memo.is_pinned;
            pinBtn.classList.toggle("active", memo.is_pinned);
            deleteBtn.style.display = "flex";
            dateInfo.textContent = `수정: ${new Date(memo.updated_at).toLocaleString()}`;
          }
        } else {
          titleInput.value = "";
          contentInput.value = "";
          currentMemoPinned = false;
          pinBtn.classList.remove("active");
          deleteBtn.style.display = "none";
          dateInfo.textContent = "";
        }

        modal.style.display = "flex";
        titleInput.focus();
      }

      function closeMemoModal() {
        document.getElementById("memoModal").style.display = "none";
        currentMemoId = null;
      }

      function toggleMemoPin() {
        currentMemoPinned = !currentMemoPinned;
        document
          .getElementById("memoPinBtn")
          .classList.toggle("active", currentMemoPinned);
      }

      async function saveMemo() {
        const title = document.getElementById("memoTitleInput").value.trim();
        const content = document.getElementById("memoContentInput").value;

        if (!title && !content) {
          showToast("error", "제목 또는 내용을 입력하세요");
          return;
        }

        showLoading();
        try {
          const url = currentMemoId
            ? `/api/memos/${currentMemoId}`
            : "/api/memos";
          const method = currentMemoId ? "PUT" : "POST";

          const response = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              title,
              content,
              is_pinned: currentMemoPinned,
            }),
          });

          const result = await response.json();
          if (result.success) {
            showToast(
              "success",
              currentMemoId ? "메모가 수정되었습니다" : "메모가 저장되었습니다",
            );
            closeMemoModal();
            loadMemos();
          } else {
            showToast("error", result.error || "저장 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
        hideLoading();
      }

      async function deleteMemoFromModal() {
        if (!currentMemoId) return;
        if (!confirm("이 메모를 삭제하시겠습니까?")) return;

        showLoading();
        try {
          const response = await fetch(`/api/memos/${currentMemoId}`, {
            method: "DELETE",
          });
          const result = await response.json();
          if (result.success) {
            showToast("success", "메모가 삭제되었습니다");
            closeMemoModal();
            loadMemos();
          } else {
            showToast("error", result.error || "삭제 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
        hideLoading();
      }

      // ==================== 품절상품 기능 ====================
      let stockData = [];
      let currentStockId = null;

      async function loadOutOfStock() {
        try {
          const response = await fetch("/api/out-of-stock");
          const result = await response.json();
          if (result.success) {
            stockData = result.data;
            renderStock();
          }
        } catch (error) {
          console.error("품절상품 로드 오류:", error);
        }
      }

      function renderStock() {
        const container = document.getElementById("stockList");
        if (!container) return;

        if (!stockData.length) {
          container.innerHTML = `
            <div class="dashboard-empty">
              <div class="dashboard-empty-icon">✅</div>
              <div class="dashboard-empty-text">품절상품이 없습니다</div>
            </div>
          `;
          return;
        }

        let html = "";
        stockData.forEach((item) => {
          const outDate = item.out_date ? formatDate(item.out_date) : "-";
          const restockDate = item.restock_date
            ? formatDate(item.restock_date)
            : null;

          html += `
            <div class="stock-item">
              <div class="stock-item-header">
                <div class="stock-product-name">${escapeHtml(item.product_name)}</div>
                <div class="stock-item-actions">
                  <button class="stock-action-btn restock" onclick="markRestocked(${item.id})" title="재입고 완료">✓</button>
                  <button class="stock-action-btn" onclick="openStockModal(${item.id})" title="수정">✏️</button>
                  <button class="stock-action-btn delete" onclick="deleteStock(${item.id})" title="삭제">🗑️</button>
                </div>
              </div>
              <div class="stock-dates">
                <div class="stock-date-item">
                  <span class="stock-date-label">품절:</span>
                  <span class="stock-date-value">${outDate}</span>
                </div>
                <div class="stock-date-item">
                  <span class="stock-date-label">재입고:</span>
                  <span class="stock-date-value ${restockDate ? "restock" : "pending"}">${restockDate || "미정"}</span>
                </div>
              </div>
            </div>
          `;
        });
        container.innerHTML = html;
      }

      function formatDate(dateStr) {
        if (!dateStr) return "";
        const [y, m, d] = dateStr.split("-");
        return `${parseInt(m)}/${parseInt(d)}`;
      }

      function openStockModal(itemId = null) {
        const modal = document.getElementById("stockModal");
        const title = document.getElementById("stockModalTitle");
        const nameInput = document.getElementById("stockProductName");
        const outDateInput = document.getElementById("stockOutDate");
        const restockDateInput = document.getElementById("stockRestockDate");
        const notesInput = document.getElementById("stockNotes");

        currentStockId = itemId;

        if (itemId) {
          const item = stockData.find((s) => s.id === itemId);
          if (item) {
            title.textContent = "품절상품 수정";
            nameInput.value = item.product_name;
            outDateInput.value = item.out_date || "";
            restockDateInput.value = item.restock_date || "";
            notesInput.value = item.notes || "";
          }
        } else {
          title.textContent = "품절상품 등록";
          nameInput.value = "";
          outDateInput.value = new Date().toISOString().split("T")[0];
          restockDateInput.value = "";
          notesInput.value = "";
        }

        modal.style.display = "flex";
        nameInput.focus();
      }

      function closeStockModal() {
        document.getElementById("stockModal").style.display = "none";
        currentStockId = null;
      }

      async function saveStock() {
        const productName = document
          .getElementById("stockProductName")
          .value.trim();
        const outDate = document.getElementById("stockOutDate").value;
        const restockDate = document.getElementById("stockRestockDate").value;
        const notes = document.getElementById("stockNotes").value;

        if (!productName) {
          showToast("error", "상품명을 입력하세요");
          return;
        }

        showLoading();
        try {
          const url = currentStockId
            ? `/api/out-of-stock/${currentStockId}`
            : "/api/out-of-stock";
          const method = currentStockId ? "PUT" : "POST";

          const response = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              product_name: productName,
              out_date: outDate,
              restock_date: restockDate || null,
              notes,
            }),
          });

          const result = await response.json();
          if (result.success) {
            showToast(
              "success",
              currentStockId ? "수정되었습니다" : "등록되었습니다",
            );
            closeStockModal();
            loadOutOfStock();
          } else {
            showToast("error", result.error || "저장 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
        hideLoading();
      }

      async function deleteStock(itemId) {
        if (!confirm("이 품절상품을 삭제하시겠습니까?")) return;

        showLoading();
        try {
          const response = await fetch(`/api/out-of-stock/${itemId}`, {
            method: "DELETE",
          });
          const result = await response.json();
          if (result.success) {
            showToast("success", "삭제되었습니다");
            loadOutOfStock();
          } else {
            showToast("error", result.error || "삭제 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
        hideLoading();
      }

      async function markRestocked(itemId) {
        if (!confirm("재입고 완료 처리하시겠습니까?")) return;

        showLoading();
        try {
          const response = await fetch(`/api/out-of-stock/${itemId}/restock`, {
            method: "POST",
          });
          const result = await response.json();
          if (result.success) {
            showToast("success", "재입고 완료 처리되었습니다");
            loadOutOfStock();
          } else {
            showToast("error", result.error || "처리 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
        hideLoading();
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // 모달 외부 클릭 시 닫기
      document
        .getElementById("memoModal")
        ?.addEventListener("click", function (e) {
          if (e.target === this) closeMemoModal();
        });
      document
        .getElementById("stockModal")
        ?.addEventListener("click", function (e) {
          if (e.target === this) closeStockModal();
        });

      // ==================== [신규] 스마트 로딩 애니메이션 로직 ====================
      let loadingInterval;
      let currentProgress = 0;
      const CIRCLE_CIRCUMFERENCE = 327; // SVG 원의 둘레 (r=52일 때)

      function setProgress(percent) {
        const circle = document.getElementById("progressCircle");
        const text = document.getElementById("loadingPercent");
        if (!circle || !text) return;

        currentProgress = percent;
        text.textContent = `${Math.round(percent)}%`;

        // offset 계산: 100%일 때 offset이 0이 되어야 함
        const offset =
          CIRCLE_CIRCUMFERENCE - (percent / 100) * CIRCLE_CIRCUMFERENCE;
        circle.style.strokeDashoffset = offset;
      }

      function showLoading() {
        const overlay = document.getElementById("loadingOverlay");
        if (!overlay) return;

        // 기존 진행 중인 로딩이 있다면 초기화
        clearInterval(loadingInterval);
        setProgress(0);
        overlay.classList.add("show");

        // 자연스러운 로딩 시뮬레이션
        // 0~30%: 빠르게, 30~70%: 보통, 70~95%: 느리게, 95%에서 멈춤
        loadingInterval = setInterval(() => {
          let increment = 0;
          if (currentProgress < 30) {
            increment = Math.random() * 5; // 아주 빠름
          } else if (currentProgress < 70) {
            increment = Math.random() * 2; // 보통
          } else if (currentProgress < 95) {
            increment = Math.random() * 0.5; // 아주 느림
          } else {
            // 95% 이상이면 멈춰서 실제 데이터 기다림
            increment = 0;
          }

          let nextProgress = currentProgress + increment;
          if (nextProgress >= 99) nextProgress = 99;
          setProgress(nextProgress);
        }, 100); // 0.1초마다 업데이트
      }

      function hideLoading() {
        const overlay = document.getElementById("loadingOverlay");
        if (!overlay) return;

        clearInterval(loadingInterval);

        // 완료 시 순간적으로 100% 보여줌
        setProgress(100);

        // 유저가 "100%"를 볼 수 있도록 0.3초 정도 기다렸다가 사라짐
        setTimeout(() => {
          overlay.classList.remove("show");
          // 완전히 사라진 후 다음을 위해 0%로 초기화
          setTimeout(() => {
            setProgress(0);
          }, 300);
        }, 300);
      }
      // ===================================================================

      // ==================== 도착보장 입고내역서 관련 ====================

      let arrivalProducts = [];
      let addedItems = [];
      let currentCustomerId = "";
      let selectedDeliveryType = "화물";
      let calendarDate = new Date();

      function initArrivalInvoice() {
        loadArrivalProducts();
        loadCustomerId();
        renderMiniCalendar();
      }

      function selectDeliveryType(type) {
        selectedDeliveryType = type;
        document.querySelectorAll(".delivery-type-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.type === type);
        });
      }

      function renderMiniCalendar() {
        const calendar = document.getElementById("miniCalendar");
        if (!calendar) return;

        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDay = firstDay.getDay();

        const today = new Date();
        const selectedDate =
          document.getElementById("arrivalDate")?.value || "";

        let html = `
          <div class="calendar-header">
            <button type="button" class="calendar-nav" onclick="changeCalendarMonth(-1)">‹</button>
            <span class="calendar-month">${year}년 ${month + 1}월</span>
            <button type="button" class="calendar-nav" onclick="changeCalendarMonth(1)">›</button>
          </div>
          <div class="calendar-grid">
            <div class="calendar-day-header">일</div>
            <div class="calendar-day-header">월</div>
            <div class="calendar-day-header">화</div>
            <div class="calendar-day-header">수</div>
            <div class="calendar-day-header">목</div>
            <div class="calendar-day-header">금</div>
            <div class="calendar-day-header">토</div>
        `;

        const prevMonth = new Date(year, month, 0);
        for (let i = startDay - 1; i >= 0; i--) {
          const day = prevMonth.getDate() - i;
          html += `<div class="calendar-day other-month">${day}</div>`;
        }

        for (let day = 1; day <= lastDay.getDate(); day++) {
          const dateStr = `${year}${String(month + 1).padStart(2, "0")}${String(day).padStart(2, "0")}`;
          const isToday =
            today.getFullYear() === year &&
            today.getMonth() === month &&
            today.getDate() === day;
          const isSelected = selectedDate === dateStr;

          let classes = "calendar-day";
          if (isToday) classes += " today";
          if (isSelected) classes += " selected";

          html += `<div class="${classes}" onclick="selectCalendarDate('${dateStr}')">${day}</div>`;
        }

        const remaining = 42 - (startDay + lastDay.getDate());
        for (let day = 1; day <= remaining; day++) {
          html += `<div class="calendar-day other-month">${day}</div>`;
        }

        html += "</div>";
        calendar.innerHTML = html;
      }

      function changeCalendarMonth(delta) {
        calendarDate.setMonth(calendarDate.getMonth() + delta);
        renderMiniCalendar();
      }

      function selectCalendarDate(dateStr) {
        const input = document.getElementById("arrivalDate");
        if (input) input.value = dateStr;
        renderMiniCalendar();
      }

      async function loadArrivalProducts() {
        showLoading(); // [추가]
        try {
          const response = await fetch("/api/arrival-products");
          const result = await response.json();
          if (result.success) {
            arrivalProducts = result.data;
            renderArrivalProductSelect();
            renderArrivalProductsTable();
          }
        } catch (error) {
          console.error("상품 목록 로드 실패:", error);
        } finally {
          hideLoading(); // [추가]
        }
      }

      function renderArrivalProductSelect() {
        const select = document.getElementById("arrivalProductSelect");
        if (!select) return;

        select.innerHTML = '<option value="">-- 상품을 선택하세요 --</option>';

        arrivalProducts.forEach((product) => {
          const option = document.createElement("option");
          option.value = product.id;
          option.textContent = product.product_name;
          option.dataset.barcode = product.barcode;
          select.appendChild(option);
        });
      }

      function renderArrivalProductsTable() {
        const tbody = document.getElementById("arrivalProductsTableBody");
        if (!tbody) return;

        if (arrivalProducts.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="3" style="text-align: center; color: #666;">상품을 등록하세요</td></tr>';
          return;
        }

        tbody.innerHTML = arrivalProducts
          .map(
            (product) => `
          <tr>
            <td style="font-size: 13px;">${product.product_name}</td>
            <td style="color: #888; font-size: 12px;">${product.barcode}</td>
            <td style="text-align: right;">
              <button class="product-action-btn delete" onclick="deleteArrivalProduct(${product.id})">삭제</button>
            </td>
          </tr>
        `,
          )
          .join("");
      }

      function onProductSelect() {
        const select = document.getElementById("arrivalProductSelect");
        const selectedOption = select.options[select.selectedIndex];
        const barcodeInput = document.getElementById("arrivalBarcode");

        if (selectedOption && selectedOption.value) {
          barcodeInput.value = selectedOption.dataset.barcode || "";
        } else {
          barcodeInput.value = "";
        }
      }

      async function loadCustomerId() {
        try {
          const response = await fetch("/api/arrival-customer-id");
          const result = await response.json();
          if (result.success) {
            currentCustomerId = result.customer_id || "";
            const input = document.getElementById("customerIdInput");
            if (input) input.value = currentCustomerId;
            updateCustomerIdDisplay();
          }
        } catch (error) {
          console.error("고객ID 로드 실패:", error);
        }
      }

      function updateCustomerIdDisplay() {
        const displayDiv = document.getElementById("currentCustomerIdDisplay");
        const textSpan = document.getElementById("currentCustomerIdText");
        if (displayDiv && textSpan) {
          if (currentCustomerId) {
            textSpan.textContent = currentCustomerId;
            displayDiv.style.display = "block";
          } else {
            displayDiv.style.display = "none";
          }
        }
      }

      async function saveCustomerId() {
        const input = document.getElementById("customerIdInput");
        const customerId = input ? input.value.trim() : "";

        try {
          const response = await fetch("/api/arrival-customer-id", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ customer_id: customerId }),
          });

          const result = await response.json();
          if (result.success) {
            currentCustomerId = customerId;
            updateCustomerIdDisplay();
            showToast("success", "고객ID가 저장되었습니다");
          } else {
            showToast("error", result.error || "저장 실패");
          }
        } catch (error) {
          showToast("error", "저장 중 오류 발생");
        }
      }

      function toggleArrivalAddProductForm() {
        const form = document.getElementById("arrivalAddProductForm");
        if (!form) return;

        form.style.display = form.style.display === "none" ? "block" : "none";
        if (form.style.display === "block") {
          const nameInput = document.getElementById("arrivalNewProductName");
          const barcodeInput = document.getElementById(
            "arrivalNewProductBarcode",
          );
          if (nameInput) nameInput.value = "";
          if (barcodeInput) barcodeInput.value = "";
          if (nameInput) nameInput.focus();
        }
      }

      async function saveNewArrivalProduct() {
        const nameInput = document.getElementById("arrivalNewProductName");
        const barcodeInput = document.getElementById(
          "arrivalNewProductBarcode",
        );

        const name = nameInput ? nameInput.value.trim() : "";
        const barcode = barcodeInput ? barcodeInput.value.trim() : "";

        if (!name || !barcode) {
          showToast("error", "상품명과 바코드를 입력하세요");
          return;
        }

        try {
          const response = await fetch("/api/arrival-products", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ product_name: name, barcode: barcode }),
          });

          const result = await response.json();
          if (result.success) {
            showToast("success", "상품이 등록되었습니다");
            toggleArrivalAddProductForm();
            loadArrivalProducts();
          } else {
            showToast("error", result.error || "등록 실패");
          }
        } catch (error) {
          showToast("error", "등록 중 오류 발생");
        }
      }

      async function deleteArrivalProduct(productId) {
        if (!confirm("이 상품을 삭제하시겠습니까?")) return;

        try {
          const response = await fetch(`/api/arrival-products/${productId}`, {
            method: "DELETE",
          });
          const result = await response.json();
          if (result.success) {
            showToast("success", "상품이 삭제되었습니다");
            loadArrivalProducts();
          } else {
            showToast("error", result.error || "삭제 실패");
          }
        } catch (error) {
          showToast("error", "삭제 중 오류 발생");
        }
      }

      function clearArrivalForm() {
        const dateInput = document.getElementById("arrivalDate");
        const productSelect = document.getElementById("arrivalProductSelect");
        const barcodeInput = document.getElementById("arrivalBarcode");
        const quantityInput = document.getElementById("arrivalQuantity");
        const noteInput = document.getElementById("arrivalNote");

        if (dateInput) dateInput.value = "";
        if (productSelect) productSelect.value = "";
        if (barcodeInput) barcodeInput.value = "";
        if (quantityInput) quantityInput.value = "";
        if (noteInput) noteInput.value = "";

        addedItems = [];
        renderAddedItems();
        renderMiniCalendar();
      }

      function addArrivalItem() {
        const arrivalDate =
          document.getElementById("arrivalDate")?.value.trim() || "";
        const productSelect = document.getElementById("arrivalProductSelect");
        const selectedOption =
          productSelect?.options[productSelect.selectedIndex];
        const barcode =
          document.getElementById("arrivalBarcode")?.value.trim() || "";
        const quantity =
          document.getElementById("arrivalQuantity")?.value.trim() || "";
        const note = document.getElementById("arrivalNote")?.value.trim() || "";

        if (!arrivalDate) {
          showToast("error", "입고예정일을 입력하세요");
          return;
        }
        if (!productSelect?.value) {
          showToast("error", "상품을 선택하세요");
          return;
        }
        if (!quantity || parseInt(quantity) < 1) {
          showToast("error", "수량을 입력하세요");
          return;
        }

        addedItems.push({
          customer_id: currentCustomerId,
          arrival_date: arrivalDate,
          product_name: selectedOption.textContent,
          barcode: barcode,
          quantity: parseInt(quantity),
          note: note,
        });

        renderAddedItems();

        if (productSelect) productSelect.value = "";
        const barcodeInput = document.getElementById("arrivalBarcode");
        const quantityInput = document.getElementById("arrivalQuantity");
        const noteInput = document.getElementById("arrivalNote");
        if (barcodeInput) barcodeInput.value = "";
        if (quantityInput) quantityInput.value = "";
        if (noteInput) noteInput.value = "";

        showToast("success", "상품이 추가되었습니다");
      }

      function renderAddedItems() {
        const container = document.getElementById("addedProductsContainer");
        const listSection = document.getElementById("addedProductsList");
        const countEl = document.getElementById("addedCount");

        if (!container || !listSection) return;

        if (addedItems.length === 0) {
          listSection.style.display = "none";
          return;
        }

        listSection.style.display = "block";
        if (countEl) countEl.textContent = `${addedItems.length}개`;

        container.innerHTML = addedItems
          .map(
            (item, index) => `
          <div class="added-product-item">
            <div class="added-product-info">
              <div class="added-product-name">${item.product_name}</div>
              <div class="added-product-detail">${item.arrival_date} · ${item.quantity}EA · ${item.barcode}</div>
            </div>
            <button class="added-product-remove" onclick="removeAddedItem(${index})">×</button>
          </div>
        `,
          )
          .join("");
      }

      function removeAddedItem(index) {
        addedItems.splice(index, 1);
        renderAddedItems();
      }

      async function generateArrivalInvoice() {
        if (addedItems.length === 0) {
          const arrivalDate =
            document.getElementById("arrivalDate")?.value.trim() || "";
          const productSelect = document.getElementById("arrivalProductSelect");
          const selectedOption =
            productSelect?.options[productSelect.selectedIndex];
          const barcode =
            document.getElementById("arrivalBarcode")?.value.trim() || "";
          const quantity =
            document.getElementById("arrivalQuantity")?.value.trim() || "";
          const note =
            document.getElementById("arrivalNote")?.value.trim() || "";

          if (!arrivalDate || !productSelect?.value || !quantity) {
            showToast("error", "상품 정보를 입력하세요");
            return;
          }

          addedItems.push({
            customer_id: currentCustomerId,
            arrival_date: arrivalDate,
            product_name: selectedOption.textContent,
            barcode: barcode,
            quantity: parseInt(quantity),
            note: note,
          });
        }

        const generateSeparateEl = document.getElementById("generateSeparate");
        const generateSeparate = generateSeparateEl
          ? generateSeparateEl.checked
          : false;

        try {
          showToast("success", "PDF 생성 중...");

          const response = await fetch("/api/arrival-invoice/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              items: addedItems,
              delivery_type: selectedDeliveryType,
              generate_separate: generateSeparate,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            showToast("error", error.error || "생성 실패");
            return;
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;

          const contentDisposition = response.headers.get(
            "Content-Disposition",
          );
          let filename = generateSeparate ? "입고내역서.zip" : "입고내역서.pdf";
          if (contentDisposition) {
            const match = contentDisposition.match(
              /filename\*?=(?:UTF-8'')?([^;\n]*)/i,
            );
            if (match) {
              filename = decodeURIComponent(match[1].replace(/['"]/g, ""));
            }
          }

          a.download = filename;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          showToast("success", "입고내역서가 생성되었습니다");
          clearArrivalForm();
        } catch (error) {
          console.error("생성 오류:", error);
          showToast("error", "생성 중 오류 발생");
        }
      }

      // ==================== 박스 재고 파악 ====================

      let boxInventoryData = [];
      let boxInventoryModified = false;

      async function loadBoxInventory() {
        showLoading();
        try {
          const response = await fetch("/api/box-inventory");
          const result = await response.json();

          if (result.success) {
            boxInventoryData = result.data || [];
            renderBoxInventory();
          } else {
            showToast("error", result.error || "데이터 로드 실패");
          }
        } catch (error) {
          console.error("박스 재고 로드 오류:", error);
          showToast("error", "서버 연결 오류");
        }
        hideLoading();
      }

      function renderBoxInventory() {
        const tbody = document.getElementById("boxInventoryBody");
        const emptyState = document.getElementById("boxEmptyState");
        const countBadge = document.getElementById("boxInventoryCount");

        if (!tbody) return;

        if (boxInventoryData.length === 0) {
          tbody.innerHTML = "";
          if (emptyState) emptyState.style.display = "block";
          if (countBadge) countBadge.textContent = "0개";
          return;
        }

        if (emptyState) emptyState.style.display = "none";
        if (countBadge) countBadge.textContent = `${boxInventoryData.length}개`;

        tbody.innerHTML = boxInventoryData
          .map((item, index) => createBoxRow(item, index))
          .join("");

        tbody.querySelectorAll(".number-input").forEach((input) => {
          formatNumberInput(input);
        });
      }

      function createBoxRow(item, index) {
        const isNew = !item.id;
        const rowClass = isNew ? "row-new new-row" : "";

        return `
          <tr class="${rowClass}" data-id="${item.id || ""}" data-index="${index}">
            <td class="box-row-number">${index + 1}</td>
            <td>
              <input type="text" class="box-input" 
                     value="${escapeHtmlBox(item.name_cj || "")}" 
                     onchange="updateBoxField(${index}, 'name_cj', this.value)"
                     placeholder="CJ 박스명">
            </td>
            <td>
              <input type="text" class="box-input" 
                     value="${escapeHtmlBox(item.name_box4u || "")}" 
                     onchange="updateBoxField(${index}, 'name_box4u', this.value)"
                     placeholder="박스포유 명">
            </td>
            <td>
              <input type="text" class="box-input" 
                     value="${escapeHtmlBox(item.name_official || "")}" 
                     onchange="updateBoxField(${index}, 'name_official', this.value)"
                     placeholder="기타 명">
            </td>
            <td>
              <input type="text" class="box-input" 
                     value="${escapeHtmlBox(item.spec || "")}" 
                     onchange="updateBoxField(${index}, 'spec', this.value)"
                     placeholder="예: 300x200x100">
            </td>
            <td>
              <input type="text" class="box-input" 
                     value="${escapeHtmlBox(item.material || "")}" 
                     onchange="updateBoxField(${index}, 'material', this.value)"
                     placeholder="예: A골">
            </td>
            <td>
              <input type="text" class="box-input" 
                     value="${escapeHtmlBox(item.strength || "")}" 
                     onchange="updateBoxField(${index}, 'strength', this.value)"
                     placeholder="예: 강함">
            </td>
            <td>
              <select class="box-select" onchange="updateBoxField(${index}, 'print_type', this.value)">
                <option value="무지" ${item.print_type === "무지" ? "selected" : ""}>무지</option>
                <option value="취급주의" ${item.print_type === "취급주의" ? "selected" : ""}>취급주의</option>
                <option value="로고" ${item.print_type === "로고" ? "selected" : ""}>로고</option>
              </select>
            </td>
            <td>
              <input type="text" class="box-input number-input" 
                     value="${item.price || ""}" 
                     onchange="updateBoxField(${index}, 'price', parseNumberInputBox(this.value))"
                     oninput="formatNumberInput(this)"
                     placeholder="0">
            </td>
            <td>
              <select class="box-select" onchange="updateBoxField(${index}, 'vendor', this.value)">
                <option value="CJ" ${item.vendor === "CJ" ? "selected" : ""}>CJ</option>
                <option value="박스포유" ${item.vendor === "박스포유" ? "selected" : ""}>박스포유</option>
                <option value="기타" ${item.vendor === "기타" ? "selected" : ""}>기타</option>
              </select>
            </td>
            <td>
              <input type="text" class="box-input number-input" 
                     value="${item.moq_pallet || ""}" 
                     onchange="updateBoxField(${index}, 'moq_pallet', parseNumberInputBox(this.value))"
                     oninput="formatNumberInput(this)"
                     placeholder="0">
            </td>
            <td>
              <input type="text" class="box-input number-input" 
                     value="${item.moq_piece || ""}" 
                     onchange="updateBoxField(${index}, 'moq_piece', parseNumberInputBox(this.value))"
                     oninput="formatNumberInput(this)"
                     placeholder="0">
            </td>
            <td>
              <input type="text" class="box-input number-input stock-input" 
                     value="${item.stock_cj || ""}" 
                     onchange="updateBoxField(${index}, 'stock_cj', parseNumberInputBox(this.value))"
                     oninput="formatNumberInput(this)"
                     placeholder="0">
            </td>
            <td>
              <input type="text" class="box-input number-input stock-input" 
                     value="${item.stock_hyojin || ""}" 
                     onchange="updateBoxField(${index}, 'stock_hyojin', parseNumberInputBox(this.value))"
                     oninput="formatNumberInput(this)"
                     placeholder="0">
            </td>
            <td>
              <button class="box-delete-btn" onclick="deleteBoxRow(${index})" title="삭제">
                🗑️
              </button>
            </td>
          </tr>
        `;
      }

      function escapeHtmlBox(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatNumberInput(input) {
        let value = input.value.replace(/[^\d]/g, "");
        if (value) {
          value = parseInt(value, 10).toLocaleString();
        }
        input.value = value;
      }

      function parseNumberInputBox(value) {
        if (!value) return 0;
        return parseInt(value.toString().replace(/,/g, ""), 10) || 0;
      }

      function updateBoxField(index, field, value) {
        if (boxInventoryData[index]) {
          boxInventoryData[index][field] = value;
          setBoxModified(true);
        }
      }

      function setBoxModified(modified) {
        boxInventoryModified = modified;
        const badge = document.getElementById("boxInventoryModified");
        const saveBtn = document.getElementById("btnSaveBoxInventory");

        if (badge) {
          badge.style.display = modified ? "inline-flex" : "none";
        }
        if (saveBtn) {
          if (modified) {
            saveBtn.classList.add("btn-save-pulse");
          } else {
            saveBtn.classList.remove("btn-save-pulse");
          }
        }
      }

      function addBoxRow() {
        const newItem = {
          id: null,
          name_cj: "",
          name_box4u: "",
          name_official: "",
          spec: "",
          material: "",
          strength: "",
          print_type: "무지",
          price: 0,
          vendor: "CJ",
          moq_pallet: 0,
          moq_piece: 0,
          stock_cj: 0,
          stock_hyojin: 0,
        };

        boxInventoryData.push(newItem);
        renderBoxInventory();
        setBoxModified(true);

        const wrapper = document.querySelector(".box-inventory-table-wrapper");
        if (wrapper) {
          setTimeout(() => {
            wrapper.scrollTop = wrapper.scrollHeight;
          }, 100);
        }

        const tbody = document.getElementById("boxInventoryBody");
        const lastRow = tbody?.lastElementChild;
        if (lastRow) {
          const firstInput = lastRow.querySelector(".box-input");
          if (firstInput) firstInput.focus();
        }

        showToast("success", "새 행이 추가되었습니다");
      }

      function deleteBoxRow(index) {
        const item = boxInventoryData[index];

        if (item.id) {
          if (!confirm("이 박스 정보를 삭제하시겠습니까?")) return;
          deleteBoxFromDB(item.id, index);
        } else {
          boxInventoryData.splice(index, 1);
          renderBoxInventory();
          setBoxModified(boxInventoryData.some((item) => !item.id));
          showToast("success", "행이 삭제되었습니다");
        }
      }

      async function deleteBoxFromDB(id, index) {
        showLoading();
        try {
          const response = await fetch(`/api/box-inventory/${id}`, {
            method: "DELETE",
          });
          const result = await response.json();

          if (result.success) {
            boxInventoryData.splice(index, 1);
            renderBoxInventory();
            showToast("success", "삭제되었습니다");
          } else {
            showToast("error", result.error || "삭제 실패");
          }
        } catch (error) {
          showToast("error", "서버 오류");
        }
        hideLoading();
      }

      async function saveBoxInventory() {
        if (boxInventoryData.length === 0) {
          showToast("error", "저장할 데이터가 없습니다");
          return;
        }

        // 필수 필드 검증
        const requiredFields = [
          { key: "name_cj", label: "박스명(CJ)" },
          { key: "spec", label: "박스규격" },
          { key: "material", label: "재질" },
          { key: "strength", label: "강도" },
          { key: "print_type", label: "인쇄" },
          { key: "vendor", label: "구매처" },
        ];

        for (let i = 0; i < boxInventoryData.length; i++) {
          const item = boxInventoryData[i];
          const emptyFields = [];

          for (const field of requiredFields) {
            if (!item[field.key] || item[field.key].toString().trim() === "") {
              emptyFields.push(field.label);
            }
          }

          if (emptyFields.length > 0) {
            alert(
              `${i + 1}번째 줄에 내용 기입이 덜 되었습니다.\n\n미입력 항목: ${emptyFields.join(", ")}`,
            );
            return;
          }
        }

        showLoading();
        try {
          const response = await fetch("/api/box-inventory", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ items: boxInventoryData }),
          });

          const result = await response.json();

          if (result.success) {
            showToast("success", result.message || "저장 완료");
            setBoxModified(false);
            await loadBoxInventory();
          } else {
            showToast("error", result.error || "저장 실패");
          }
        } catch (error) {
          console.error("저장 오류:", error);
          showToast("error", "서버 연결 오류");
        }
        hideLoading();
      }

      window.addEventListener("beforeunload", function (e) {
        if (boxInventoryModified) {
          e.preventDefault();
          e.returnValue =
            "저장하지 않은 변경사항이 있습니다. 페이지를 떠나시겠습니까?";
          return e.returnValue;
        }
      });
    </script>
  </body>
</html>
