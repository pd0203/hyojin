<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Excel Tools - PlayAuto</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont,
          sans-serif;
        background: #000;
        color: #fff;
        display: flex;
        min-height: 100vh;
      }

      /* ì‚¬ì´ë“œë°” */
      .sidebar {
        width: 230px;
        background: linear-gradient(180deg, #0a0a0a 0%, #000 100%);
        border-right: 1px solid #1a1a1a;
        padding: 30px 0;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
      }

      .logo {
        padding: 0 20px 30px;
        border-bottom: 1px solid #1a1a1a;
        margin-bottom: 20px;
      }

      .logo h1 {
        font-size: 20px;
        background: linear-gradient(135deg, #00ff88 0%, #0088ff 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .menu-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid transparent;
        color: #888;
        font-size: 14px;
      }

      .menu-item:hover {
        background: #0a0a0a;
        color: #fff;
      }

      .menu-item.active {
        background: #0a0a0a;
        border-left-color: #00ff88;
        color: #00ff88;
      }

      /* ë©”ì¸ ì»¨í…ì¸  */
      .main-content {
        margin-left: 230px;
        flex: 1;
        padding: 40px;
        max-width: 1400px;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      .page-header {
        margin-bottom: 30px;
      }

      .page-header h2 {
        font-size: 32px;
        color: #00ff88;
        margin-bottom: 10px;
      }

      .page-header p {
        color: #888;
        font-size: 14px;
      }

      /* ì¹´ë“œ */
      .card {
        background: #0a0a0a;
        border: 1px solid #1a1a1a;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 20px;
      }

      /* ë“œë¡­ì¡´ */
      .dropzone {
        border: 2px dashed #2a2a2a;
        border-radius: 12px;
        padding: 60px 30px;
        text-align: center;
        background: #000;
        transition: all 0.3s;
        cursor: pointer;
      }

      .dropzone:hover,
      .dropzone.dragover {
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.05);
      }

      .dropzone .icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .dropzone .text {
        color: #fff;
        font-size: 16px;
        margin-bottom: 8px;
      }

      .dropzone .subtext {
        color: #666;
        font-size: 13px;
      }

      /* í†µê³„ */
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        padding: 20px;
      }

      .stat-label {
        color: #888;
        font-size: 12px;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #00ff88;
      }

      /* ë²„íŠ¼ */
      .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-block;
      }

      .btn-primary {
        background: #00ff88;
        color: #000;
      }

      .btn-primary:hover {
        background: #00dd77;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: #222;
        color: #fff;
      }

      .btn-secondary:hover {
        background: #333;
      }

      /* ì„¤ì • ì„¹ì…˜ */
      .settings-section {
        margin-top: 30px;
      }

      .settings-status {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 20px;
        background: #0a0a0a;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #666;
      }

      .status-indicator.loaded {
        background: #00ff88;
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
      }

      .settings-info {
        flex: 1;
      }

      .settings-info strong {
        color: #fff;
        display: block;
        margin-bottom: 4px;
      }

      .settings-info span {
        color: #888;
        font-size: 13px;
      }

      /* íˆë“  input */
      input[type="file"] {
        display: none;
      }

      /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .loading-overlay.active {
        display: flex;
      }

      .loader {
        text-align: center;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid #1a1a1a;
        border-top-color: #00ff88;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loader-text {
        color: #888;
        font-size: 14px;
      }

      /* ê²°ê³¼ í…Œì´ë¸” */
      .results-table {
        margin-top: 30px;
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #1a1a1a;
      }

      th {
        color: #888;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      td {
        color: #fff;
        font-size: 14px;
      }

      tr:hover {
        background: #0a0a0a;
      }
    </style>
  </head>
  <body>
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
      <div class="logo">
        <h1>âš¡ Excel Tools</h1>
      </div>
      <div class="menu-item active" onclick="showPage('filter')">
        ìŠ¤íƒ€ë°°ì†¡ í•„í„°
      </div>
      <div class="menu-item" onclick="showPage('classify')">ì†¡ì¥ ë¶„ë¥˜</div>
      <div class="menu-item" onclick="showPage('feature3')">
        ê¸°ëŠ¥ 3 (ì¤€ë¹„ì¤‘)
      </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="main-content">
      <!-- ê¸°ëŠ¥ 1: ìŠ¤íƒ€ë°°ì†¡ í•„í„° -->
      <div id="filter" class="page active">
        <div class="page-header">
          <h2>íŒë§¤ì ìŠ¤íƒ€ë°°ì†¡ í•„í„°</h2>
          <p>"íŒë§¤ì ìŠ¤íƒ€ë°°ì†¡"ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” í–‰ì„ ìë™ìœ¼ë¡œ ì‚­ì œí•©ë‹ˆë‹¤</p>
        </div>

        <div class="card">
          <div
            class="dropzone"
            onclick="document.getElementById('filterFile').click()"
            ondrop="handleDrop(event, 'filter')"
            ondragover="handleDragOver(event)"
            ondragleave="handleDragLeave(event)"
          >
            <div class="icon">ğŸ“</div>
            <div class="text">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
            <div class="subtext">(.xls, .xlsx íŒŒì¼ë§Œ ê°€ëŠ¥)</div>
          </div>
          <input
            type="file"
            id="filterFile"
            accept=".xls,.xlsx"
            onchange="uploadFilter(this.files[0])"
          />

          <div class="stats" id="filterStats" style="display: none">
            <div class="stat-card">
              <div class="stat-label">ì›ë³¸ í–‰ ìˆ˜</div>
              <div class="stat-value" id="originalCount">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ì‚­ì œëœ í–‰ ìˆ˜</div>
              <div class="stat-value" id="deletedCount">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ìµœì¢… í–‰ ìˆ˜</div>
              <div class="stat-value" id="finalCount">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ê¸°ëŠ¥ 2: ì†¡ì¥ ë¶„ë¥˜ -->
      <div id="classify" class="page">
        <div class="page-header">
          <h2>ì†¡ì¥ ë¶„ë¥˜</h2>
          <p>ì£¼ë¬¸ ì—‘ì…€ íŒŒì¼ì„ ë‹´ë‹¹ìë³„ë¡œ ìë™ ë¶„ë¥˜í•©ë‹ˆë‹¤</p>
        </div>

        <!-- ì„¤ì • íŒŒì¼ -->
        <div class="card">
          <h3 style="margin-bottom: 15px; color: #fff">1ï¸âƒ£ ì„¤ì • íŒŒì¼ ì—…ë¡œë“œ</h3>
          <div class="settings-status">
            <div class="status-indicator" id="settingsIndicator"></div>
            <div class="settings-info">
              <strong id="settingsStatus">ì„¤ì • íŒŒì¼ ì—†ìŒ</strong>
              <span id="settingsDetail"
                >playauto_settings_v4.json íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</span
              >
            </div>
            <button
              class="btn btn-secondary"
              onclick="document.getElementById('settingsFile').click()"
            >
              ì„¤ì • ì—…ë¡œë“œ
            </button>
          </div>
          <input
            type="file"
            id="settingsFile"
            accept=".json"
            onchange="uploadSettings(this.files[0])"
          />
        </div>

        <!-- ì£¼ë¬¸ íŒŒì¼ -->
        <div class="card">
          <h3 style="margin-bottom: 15px; color: #fff">2ï¸âƒ£ ì£¼ë¬¸ íŒŒì¼ ì—…ë¡œë“œ</h3>
          <div
            class="dropzone"
            onclick="document.getElementById('classifyFile').click()"
            ondrop="handleDrop(event, 'classify')"
            ondragover="handleDragOver(event)"
            ondragleave="handleDragLeave(event)"
          >
            <div class="icon">ğŸ“Š</div>
            <div class="text">ì£¼ë¬¸ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
            <div class="subtext">ì£¼ë¬¸ë²ˆí˜¸, ìƒí’ˆëª…, ìˆ˜ëŸ‰ ì»¬ëŸ¼ í•„ìˆ˜</div>
          </div>
          <input
            type="file"
            id="classifyFile"
            accept=".xls,.xlsx"
            onchange="uploadClassify(this.files[0])"
          />

          <div class="results-table" id="classifyResults" style="display: none">
            <h3 style="margin-bottom: 15px; color: #00ff88">ğŸ“‹ ë¶„ë¥˜ ê²°ê³¼</h3>
            <table id="resultsTable"></table>
          </div>
        </div>
      </div>

      <!-- ê¸°ëŠ¥ 3: ì¤€ë¹„ì¤‘ -->
      <div id="feature3" class="page">
        <div class="page-header">
          <h2>ê¸°ëŠ¥ 3</h2>
          <p>ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤</p>
        </div>
        <div class="card">
          <p style="color: #666">Coming soon...</p>
        </div>
      </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loader">
        <div class="spinner"></div>
        <div class="loader-text" id="loadingText">ì²˜ë¦¬ ì¤‘...</div>
      </div>
    </div>

    <script>
      // í˜ì´ì§€ ì „í™˜
      function showPage(pageId) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll(".menu-item")
          .forEach((m) => m.classList.remove("active"));
        document.getElementById(pageId).classList.add("active");
        event.target.classList.add("active");
      }

      // ë“œë˜ê·¸ ì•¤ ë“œë¡­
      function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add("dragover");
      }

      function handleDragLeave(e) {
        e.currentTarget.classList.remove("dragover");
      }

      function handleDrop(e, type) {
        e.preventDefault();
        e.currentTarget.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          if (type === "filter") {
            uploadFilter(files[0]);
          } else if (type === "classify") {
            uploadClassify(files[0]);
          }
        }
      }

      // ìŠ¤íƒ€ë°°ì†¡ í•„í„° ì—…ë¡œë“œ
      async function uploadFilter(file) {
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        showLoading("íŒŒì¼ ì²˜ë¦¬ ì¤‘...");

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          hideLoading();

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download =
              response.headers
                .get("content-disposition")
                ?.split("filename=")[1] || "filtered.xlsx";
            a.click();

            // í†µê³„ í‘œì‹œ
            const originalCount = response.headers.get("X-Original-Count");
            const deletedCount = response.headers.get("X-Deleted-Count");
            document.getElementById("originalCount").textContent =
              originalCount;
            document.getElementById("deletedCount").textContent = deletedCount;
            document.getElementById("finalCount").textContent =
              originalCount - deletedCount;
            document.getElementById("filterStats").style.display = "grid";
          } else {
            const error = await response.json();
            alert("ì˜¤ë¥˜: " + error.error);
          }
        } catch (error) {
          hideLoading();
          alert("ì˜¤ë¥˜: " + error.message);
        }
      }

      // ì„¤ì • íŒŒì¼ ì—…ë¡œë“œ
      async function uploadSettings(file) {
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        showLoading("ì„¤ì • íŒŒì¼ ì—…ë¡œë“œ ì¤‘...");

        try {
          const response = await fetch("/settings/upload", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();
          hideLoading();

          if (response.ok) {
            document
              .getElementById("settingsIndicator")
              .classList.add("loaded");
            document.getElementById("settingsStatus").textContent =
              "ì„¤ì • ë¡œë“œ ì™„ë£Œ";
            document.getElementById(
              "settingsDetail"
            ).textContent = `${data.workers}ëª…ì˜ ë‹´ë‹¹ì ì„¤ì •`;
            alert("ì„¤ì • íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!");
          } else {
            alert("ì˜¤ë¥˜: " + data.error);
          }
        } catch (error) {
          hideLoading();
          alert("ì˜¤ë¥˜: " + error.message);
        }
      }

      // ì†¡ì¥ ë¶„ë¥˜ ì—…ë¡œë“œ
      async function uploadClassify(file) {
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        showLoading("ì£¼ë¬¸ ë¶„ë¥˜ ì¤‘...");

        try {
          const response = await fetch("/classify", {
            method: "POST",
            body: formData,
          });

          hideLoading();

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download =
              response.headers
                .get("content-disposition")
                ?.split("filename=")[1] || "classified.xlsx";
            a.click();

            // í†µê³„ í‘œì‹œ
            const stats = JSON.parse(response.headers.get("X-Stats") || "{}");
            displayClassifyResults(stats);
          } else {
            const error = await response.json();
            alert("ì˜¤ë¥˜: " + error.error);
          }
        } catch (error) {
          hideLoading();
          alert("ì˜¤ë¥˜: " + error.message);
        }
      }

      // ë¶„ë¥˜ ê²°ê³¼ í‘œì‹œ
      function displayClassifyResults(stats) {
        const table = document.getElementById("resultsTable");
        let html =
          "<thead><tr><th>ë‹´ë‹¹ì</th><th>ì£¼ë¬¸ ìˆ˜</th></tr></thead><tbody>";

        for (const [worker, count] of Object.entries(stats)) {
          html += `<tr><td>${worker}</td><td>${count}</td></tr>`;
        }

        html += "</tbody>";
        table.innerHTML = html;
        document.getElementById("classifyResults").style.display = "block";
      }

      // ë¡œë”© í‘œì‹œ
      function showLoading(text) {
        document.getElementById("loadingText").textContent = text;
        document.getElementById("loadingOverlay").classList.add("active");
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.remove("active");
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ìƒíƒœ í™•ì¸
      async function checkSettings() {
        try {
          const response = await fetch("/settings");
          const data = await response.json();

          if (data.status === "loaded") {
            document
              .getElementById("settingsIndicator")
              .classList.add("loaded");
            document.getElementById("settingsStatus").textContent =
              "ì„¤ì • ë¡œë“œ ì™„ë£Œ";
            document.getElementById(
              "settingsDetail"
            ).textContent = `${data.workers.length}ëª…ì˜ ë‹´ë‹¹ì, ì´ ${data.total_products}ê°œ ìƒí’ˆ ê·œì¹™`;
          }
        } catch (error) {
          console.error("ì„¤ì • í™•ì¸ ì˜¤ë¥˜:", error);
        }
      }

      // ì´ˆê¸°í™”
      checkSettings();
    </script>
  </body>
</html>
