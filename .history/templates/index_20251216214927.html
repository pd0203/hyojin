<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Excel Tools - PlayAuto</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont,
          sans-serif;
        background: #000;
        color: #fff;
        display: flex;
        min-height: 100vh;
      }

      /* ì‚¬ì´ë“œë°” */
      .sidebar {
        width: 230px;
        background: linear-gradient(180deg, #0a0a0a 0%, #000 100%);
        border-right: 1px solid #1a1a1a;
        padding: 30px 0;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
      }

      .logo {
        padding: 0 20px 30px;
        border-bottom: 1px solid #1a1a1a;
        margin-bottom: 20px;
      }

      .logo h1 {
        font-size: 20px;
        background: linear-gradient(135deg, #00ff88 0%, #0088ff 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 700;
      }

      .menu-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid transparent;
        color: #888;
        font-size: 14px;
      }

      .menu-item:hover {
        background: #0a0a0a;
        color: #fff;
      }

      .menu-item.active {
        background: #0a0a0a;
        border-left-color: #00ff88;
        color: #00ff88;
      }

      /* ë©”ì¸ ì»¨í…ì¸  */
      .main-content {
        margin-left: 230px;
        flex: 1;
        padding: 40px;
        max-width: 1400px;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      .page-header {
        margin-bottom: 30px;
      }

      .page-header h2 {
        font-size: 32px;
        color: #00ff88;
        margin-bottom: 10px;
      }

      .page-header p {
        color: #888;
        font-size: 14px;
      }

      /* íƒ­ ì‹œìŠ¤í…œ */
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid #1a1a1a;
      }

      .tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        color: #888;
        font-size: 14px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
      }

      .tab:hover {
        color: #fff;
      }

      .tab.active {
        color: #00ff88;
        border-bottom-color: #00ff88;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* ì¹´ë“œ */
      .card {
        background: #0a0a0a;
        border: 1px solid #1a1a1a;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 20px;
      }

      /* ë“œë¡­ì¡´ */
      .dropzone {
        border: 2px dashed #2a2a2a;
        border-radius: 12px;
        padding: 60px 30px;
        text-align: center;
        background: #000;
        transition: all 0.3s;
        cursor: pointer;
        position: relative;
      }

      .dropzone:hover {
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.05);
      }

      .dropzone.has-file {
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.1);
      }

      .dropzone .icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .dropzone .text {
        color: #fff;
        font-size: 16px;
        margin-bottom: 8px;
      }

      .dropzone .subtext {
        color: #666;
        font-size: 13px;
      }

      .dropzone .file-info {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: #1a1a1a;
        border-radius: 8px;
      }

      .dropzone.has-file .file-info {
        display: block;
      }

      .file-info-icon {
        font-size: 32px;
        margin-bottom: 10px;
      }

      .file-info-name {
        color: #00ff88;
        font-size: 14px;
        font-weight: 600;
        word-break: break-all;
      }

      .file-info-size {
        color: #888;
        font-size: 12px;
        margin-top: 5px;
      }

      /* ë²„íŠ¼ */
      .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-right: 10px;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: #00ff88;
        color: #000;
      }

      .btn-primary:hover:not(:disabled) {
        background: #00dd77;
      }

      .btn-secondary {
        background: #0088ff;
        color: #fff;
      }

      .btn-warning {
        background: #ffdd00;
        color: #000;
      }

      /* í†µê³„ */
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        padding: 20px;
      }

      .stat-label {
        color: #888;
        font-size: 12px;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #00ff88;
      }

      /* í˜„ì¬ ì„¤ì • */
      .current-settings {
        background: #1a1a1a;
        border-left: 3px solid #00ff88;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 13px;
        color: #888;
      }

      .current-settings strong {
        color: #00ff88;
      }

      /* ê²°ê³¼ í…Œì´ë¸” */
      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #1a1a1a;
      }

      th {
        color: #888;
        font-size: 12px;
        font-weight: 600;
      }

      td {
        color: #fff;
        font-size: 14px;
      }

      tr:hover {
        background: #0a0a0a;
      }

      input[type="file"] {
        display: none;
      }

      /* ë¡œë”© */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .loading-overlay.active {
        display: flex;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid #1a1a1a;
        border-top-color: #00ff88;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loader-text {
        color: #888;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="logo">
        <h1>âš¡ Excel Tools</h1>
      </div>
      <div class="menu-item active" onclick="showPage('filter')">
        ìŠ¤íƒ€ë°°ì†¡ í•„í„°
      </div>
      <div class="menu-item" onclick="showPage('classify')">ì†¡ì¥ ë¶„ë¥˜</div>
      <div class="menu-item" onclick="showPage('feature3')">
        ê¸°ëŠ¥ 3 (ì¤€ë¹„ì¤‘)
      </div>
    </div>

    <div class="main-content">
      <!-- ìŠ¤íƒ€ë°°ì†¡ í•„í„° -->
      <div id="filter" class="page active">
        <div class="page-header">
          <h2>íŒë§¤ì ìŠ¤íƒ€ë°°ì†¡ í•„í„°</h2>
          <p>"íŒë§¤ì ìŠ¤íƒ€ë°°ì†¡"ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” í–‰ì„ ìë™ìœ¼ë¡œ ì‚­ì œí•©ë‹ˆë‹¤</p>
        </div>

        <div class="card">
          <div
            class="dropzone"
            id="filterDropzone"
            onclick="document.getElementById('filterFile').click()"
          >
            <div class="icon">ğŸ“</div>
            <div class="text">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
            <div class="subtext">(.xls, .xlsx íŒŒì¼ë§Œ ê°€ëŠ¥)</div>
            <div class="file-info">
              <div class="file-info-icon">ğŸ“„</div>
              <div class="file-info-name" id="filterFileName"></div>
              <div class="file-info-size" id="filterFileSize"></div>
            </div>
          </div>
          <input
            type="file"
            id="filterFile"
            accept=".xls,.xlsx"
            onchange="uploadFilter(this.files[0])"
          />

          <div class="stats" id="filterStats" style="display: none">
            <div class="stat-card">
              <div class="stat-label">ì›ë³¸ í–‰ ìˆ˜</div>
              <div class="stat-value" id="originalCount">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ì‚­ì œëœ í–‰ ìˆ˜</div>
              <div class="stat-value" id="deletedCount">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ìµœì¢… í–‰ ìˆ˜</div>
              <div class="stat-value" id="finalCount">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì†¡ì¥ ë¶„ë¥˜ -->
      <div id="classify" class="page">
        <div class="page-header">
          <h2>ì†¡ì¥ ë¶„ë¥˜</h2>
          <p>ì£¼ë¬¸ ì—‘ì…€ íŒŒì¼ì„ ë‹´ë‹¹ìë³„ë¡œ ìë™ ë¶„ë¥˜í•©ë‹ˆë‹¤</p>
        </div>

        <div class="current-settings">
          <strong>ğŸ“‹ í˜„ì¬ ì„¤ì •:</strong>
          <span id="settingsInfo">ë¡œë”© ì¤‘...</span>
        </div>

        <div class="tabs">
          <button class="tab active" onclick="showClassifyTab('upload')">
            ğŸ“‚ íŒŒì¼ ì—…ë¡œë“œ
          </button>
          <button class="tab" onclick="showClassifyTab('workers')">
            ğŸ‘¥ ë‹´ë‹¹ì
          </button>
          <button class="tab" onclick="showClassifyTab('products')">
            ğŸ¯ ìƒí’ˆì„¤ì •
          </button>
        </div>

        <!-- íŒŒì¼ ì—…ë¡œë“œ íƒ­ -->
        <div id="upload-tab" class="tab-content active">
          <div class="card">
            <div
              class="dropzone"
              id="classifyDropzone"
              onclick="document.getElementById('classifyFile').click()"
            >
              <div class="icon">ğŸ“Š</div>
              <div class="text">
                ì—‘ì…€ íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”
              </div>
              <div class="subtext">.xlsx ë° .xls í˜•ì‹ ì§€ì› â€¢ ì´ˆê³ ì† ì²˜ë¦¬</div>
              <div class="file-info">
                <div class="file-info-icon">ğŸ“„</div>
                <div class="file-info-name" id="classifyFileName"></div>
                <div class="file-info-size" id="classifyFileSize"></div>
              </div>
            </div>
            <input
              type="file"
              id="classifyFile"
              accept=".xls,.xlsx"
              onchange="selectClassifyFile(this.files[0])"
            />

            <div style="margin-top: 20px; text-align: center">
              <button
                class="btn btn-primary"
                id="processBtn"
                disabled
                onclick="processFile()"
              >
                âš¡ ë¶„ë¥˜ ì‹œì‘
              </button>
              <button
                class="btn btn-secondary"
                id="downloadBtn"
                disabled
                onclick="downloadResult()"
              >
                ğŸ’¾ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
              </button>
              <button
                class="btn btn-warning"
                id="reviewBtn"
                disabled
                onclick="reviewUnmatched()"
              >
                ğŸ” ë¯¸ë¶„ë¥˜ ê²€í† 
              </button>
            </div>
          </div>

          <div class="card" id="resultsCard" style="display: none">
            <h3 style="color: #00ff88; margin-bottom: 15px">ğŸ“Š ë¶„ë¥˜ ê²°ê³¼</h3>
            <table id="resultsTable"></table>
          </div>
        </div>

        <!-- ë‹´ë‹¹ì íƒ­ -->
        <div id="workers-tab" class="tab-content">
          <div class="card">
            <h3 style="color: #0088ff; margin-bottom: 15px">
              ğŸ‘¥ ë‹´ë‹¹ì ìš°ì„ ìˆœìœ„ ëª©ë¡
            </h3>
            <p style="color: #888; font-size: 13px; margin-bottom: 20px">
              ë‹´ë‹¹ì ìˆœì„œ: ì†¡ê³¼ì¥ë‹˜ â†’ ì˜ì¬ì”¨ â†’ íš¨ìƒ â†’ ê°•ë¯¼ì”¨ â†’ ë¶€ëª¨ë‹˜ â†’ í•©ë°°ì†¡ â†’
              ë³µìˆ˜ì£¼ë¬¸ â†’ ë¶„ë¥˜ì‹¤íŒ¨
            </p>
            <p style="color: #666; font-size: 12px">
              â„¹ï¸ ë‹´ë‹¹ì ê´€ë¦¬ëŠ” playauto_settings_v4.json íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬
              ì‚¬ìš©í•˜ì„¸ìš”.
            </p>
          </div>
        </div>

        <!-- ìƒí’ˆì„¤ì • íƒ­ -->
        <div id="products-tab" class="tab-content">
          <div class="card">
            <h3 style="color: #ffdd00; margin-bottom: 15px">
              ğŸ¯ ìƒí’ˆ ê·œì¹™ ì„¤ì •
            </h3>
            <p style="color: #888; font-size: 13px; margin-bottom: 20px">
              100% ì •í™•ë„ë¥¼ ìœ„í•œ ì„¸ë¶€ ìƒí’ˆ ë§¤ì¹­ ê·œì¹™ ì„¤ì •
            </p>
            <p style="color: #666; font-size: 12px">
              â„¹ï¸ ìƒí’ˆ ê·œì¹™ì€ playauto_settings_v4.json íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬
              ì‚¬ìš©í•˜ì„¸ìš”.
            </p>
          </div>
        </div>
      </div>

      <!-- ê¸°ëŠ¥ 3 -->
      <div id="feature3" class="page">
        <div class="page-header">
          <h2>ê¸°ëŠ¥ 3</h2>
          <p>ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤</p>
        </div>
        <div class="card">
          <p style="color: #666">Coming soon...</p>
        </div>
      </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
      <div class="loader">
        <div class="spinner"></div>
        <div class="loader-text" id="loadingText">ì²˜ë¦¬ ì¤‘...</div>
      </div>
    </div>

    <script>
      let selectedFile = null;
      let resultBlob = null;

      function showPage(pageId) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll(".menu-item")
          .forEach((m) => m.classList.remove("active"));
        document.getElementById(pageId).classList.add("active");
        event.target.classList.add("active");
      }

      function showClassifyTab(tabName) {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        event.target.classList.add("active");
        document.getElementById(`${tabName}-tab`).classList.add("active");
      }

      async function loadSettings() {
        try {
          const response = await fetch("/settings");
          const data = await response.json();

          if (data.status === "loaded") {
            document.getElementById(
              "settingsInfo"
            ).textContent = `${data.workers.length}ëª…ì˜ ë‹´ë‹¹ì, ${data.total_products}ê°œ ìƒí’ˆ ê·œì¹™`;
          } else {
            document.getElementById("settingsInfo").textContent =
              "ì„¤ì • íŒŒì¼ ì—†ìŒ";
          }
        } catch (error) {
          document.getElementById("settingsInfo").textContent = "ì˜¤í”„ë¼ì¸ ëª¨ë“œ";
        }
      }

      async function uploadFilter(file) {
        if (!file) return;

        // íŒŒì¼ ì •ë³´ í‘œì‹œ
        const dropzone = document.getElementById("filterDropzone");
        dropzone.classList.add("has-file");

        document.getElementById("filterFileName").textContent = file.name;
        document.getElementById("filterFileSize").textContent = `í¬ê¸°: ${(
          file.size /
          1024 /
          1024
        ).toFixed(2)} MB`;

        const formData = new FormData();
        formData.append("file", file);

        showLoading("íŒŒì¼ ì²˜ë¦¬ ì¤‘...");

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });
          hideLoading();

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "filtered.xlsx";
            a.click();

            const originalCount = response.headers.get("X-Original-Count");
            const deletedCount = response.headers.get("X-Deleted-Count");
            document.getElementById("originalCount").textContent =
              originalCount;
            document.getElementById("deletedCount").textContent = deletedCount;
            document.getElementById("finalCount").textContent =
              originalCount - deletedCount;
            document.getElementById("filterStats").style.display = "grid";

            // íŒŒì¼ ì •ë³´ ì´ˆê¸°í™”
            dropzone.classList.remove("has-file");
          } else {
            const errorText = await response.text();
            try {
              const errorJson = JSON.parse(errorText);
              alert("ì˜¤ë¥˜: " + errorJson.error);
            } catch {
              alert("ì˜¤ë¥˜: " + errorText);
            }
            dropzone.classList.remove("has-file");
          }
        } catch (error) {
          hideLoading();
          alert("ì˜¤ë¥˜: " + error.message);
          dropzone.classList.remove("has-file");
        }
      }

      function selectClassifyFile(file) {
        if (!file) return;

        selectedFile = file;

        // íŒŒì¼ ì •ë³´ í‘œì‹œ
        const dropzone = document.getElementById("classifyDropzone");
        dropzone.classList.add("has-file");

        document.getElementById("classifyFileName").textContent = file.name;
        document.getElementById("classifyFileSize").textContent = `í¬ê¸°: ${(
          file.size /
          1024 /
          1024
        ).toFixed(2)} MB`;

        // ë²„íŠ¼ í™œì„±í™”
        document.getElementById("processBtn").disabled = false;
      }

      async function processFile() {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append("file", selectedFile);

        showLoading("ì£¼ë¬¸ ë¶„ë¥˜ ì¤‘...");

        try {
          const response = await fetch("/classify", {
            method: "POST",
            body: formData,
          });
          hideLoading();

          if (response.ok) {
            resultBlob = await response.blob();

            // í—¤ë”ì—ì„œ í†µê³„ ê°€ì ¸ì˜¤ê¸°
            const statsHeader = response.headers.get("X-Stats");
            if (statsHeader) {
              try {
                const stats = JSON.parse(statsHeader);
                displayResults(stats);
                document.getElementById("downloadBtn").disabled = false;

                if (stats._summary && stats._summary.unmatched_count > 0) {
                  document.getElementById("reviewBtn").disabled = false;
                }

                if (stats._summary) {
                  alert(
                    `ë¶„ë¥˜ ì™„ë£Œ!\nì „ì²´: ${stats._summary.total_orders}ê±´\nìë™ ë¶„ë¥˜ìœ¨: ${stats._summary.auto_classification_rate}%`
                  );
                }
              } catch (parseError) {
                console.error("í†µê³„ íŒŒì‹± ì˜¤ë¥˜:", parseError);
                alert("ë¶„ë¥˜ ì™„ë£Œ! ê²°ê³¼ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.");
                document.getElementById("downloadBtn").disabled = false;
              }
            } else {
              alert("ë¶„ë¥˜ ì™„ë£Œ! ê²°ê³¼ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.");
              document.getElementById("downloadBtn").disabled = false;
            }
          } else {
            const errorText = await response.text();
            try {
              const errorJson = JSON.parse(errorText);
              alert("ì˜¤ë¥˜: " + errorJson.error);
            } catch {
              alert("ì˜¤ë¥˜: " + errorText);
            }
          }
        } catch (error) {
          hideLoading();
          alert("ì˜¤ë¥˜: " + error.message);
        }
      }

      function downloadResult() {
        if (!resultBlob) return;

        const url = window.URL.createObjectURL(resultBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `classified_${Date.now()}.xlsx`;
        a.click();
      }

      function reviewUnmatched() {
        alert(
          'ë¯¸ë¶„ë¥˜ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì˜ "ë¶„ë¥˜ì‹¤íŒ¨" ì‹œíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.'
        );
      }

      function displayResults(stats) {
        let html =
          "<thead><tr><th>ë‹´ë‹¹ì</th><th>ì£¼ë¬¸ ìˆ˜</th><th>ë¹„ìœ¨</th></tr></thead><tbody>";

        for (const [worker, data] of Object.entries(stats)) {
          if (worker === "_summary") continue;
          html += `<tr><td>${worker}</td><td>${data.count}</td><td>${data.percentage}%</td></tr>`;
        }

        html += "</tbody>";
        document.getElementById("resultsTable").innerHTML = html;
        document.getElementById("resultsCard").style.display = "block";
      }

      function showLoading(text) {
        document.getElementById("loadingText").textContent = text;
        document.getElementById("loadingOverlay").classList.add("active");
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.remove("active");
      }

      loadSettings();
    </script>
  </body>
</html>
