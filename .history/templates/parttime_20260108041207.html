<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¶œí‡´ê·¼ì¼ì§€ - íš¨ì§„ìœ í†µ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #0a0a0a;
        color: #e0e0e0;
        min-height: 100vh;
      }

      /* í—¤ë” */
      .header {
        background: linear-gradient(135deg, #111 0%, #1a1a1a 100%);
        border-bottom: 1px solid #222;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        color: #00ff88;
        font-size: 24px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-name {
        color: #888;
        font-size: 14px;
      }

      .logout-btn {
        padding: 8px 16px;
        background: transparent;
        border: 1px solid #333;
        border-radius: 6px;
        color: #888;
        cursor: pointer;
        transition: all 0.2s;
      }

      .logout-btn:hover {
        border-color: #ff6b6b;
        color: #ff6b6b;
      }

      /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
      .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 30px 20px;
      }

      /* ì •ë³´ ì¹´ë“œ */
      .info-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .info-card {
        background: #111;
        border: 1px solid #222;
        border-radius: 12px;
        padding: 20px;
      }

      .info-card-label {
        color: #666;
        font-size: 13px;
        margin-bottom: 8px;
      }

      .info-card-value {
        font-size: 24px;
        font-weight: bold;
        color: #00ff88;
      }

      .info-card-value.warning {
        color: #ffd700;
      }

      /* ì›” ì„ íƒ */
      .month-selector {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
      }

      .month-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #222;
        border: none;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .month-btn:hover {
        background: #00ff88;
        color: #000;
      }

      .current-month {
        font-size: 24px;
        font-weight: bold;
        min-width: 180px;
        text-align: center;
      }

      /* ì¶œí‡´ê·¼ ê¸°ë¡ í…Œì´ë¸” */
      .attendance-table {
        background: #111;
        border: 1px solid #222;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 30px;
      }

      .table-header {
        display: grid;
        grid-template-columns: 120px 1fr 1fr 100px 80px;
        background: #1a1a1a;
        padding: 15px 20px;
        font-weight: 600;
        color: #888;
        font-size: 14px;
      }

      .table-row {
        display: grid;
        grid-template-columns: 120px 1fr 1fr 100px 80px;
        padding: 15px 20px;
        border-top: 1px solid #222;
        align-items: center;
        transition: background 0.2s;
      }

      .table-row:hover {
        background: #1a1a1a;
      }

      .table-row.today {
        background: rgba(0, 255, 136, 0.1);
        border-left: 3px solid #00ff88;
      }

      .table-row.incomplete {
        background: rgba(255, 107, 107, 0.1);
        border-left: 3px solid #ff6b6b;
      }

      .table-row.holiday {
        background: repeating-linear-gradient(
          45deg,
          transparent,
          transparent 10px,
          rgba(255, 255, 255, 0.02) 10px,
          rgba(255, 255, 255, 0.02) 20px
        );
        color: #666;
      }

      .table-row.weekend {
        color: #ff6b6b;
      }

      .date-cell {
        display: flex;
        flex-direction: column;
      }

      .date-main {
        font-weight: 600;
      }

      .date-day {
        font-size: 12px;
        color: #666;
      }

      .time-input-wrapper {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .time-display {
        padding: 8px 12px;
        background: #222;
        border: 1px solid #333;
        border-radius: 6px;
        color: #fff;
        font-size: 14px;
        min-width: 80px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .time-display:hover {
        border-color: #00ff88;
      }

      .time-display.empty {
        color: #666;
      }

      .time-display.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .hours-cell {
        font-weight: 600;
        color: #00ff88;
      }

      .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-badge.complete {
        background: rgba(0, 255, 136, 0.2);
        color: #00ff88;
      }

      .status-badge.incomplete {
        background: rgba(255, 107, 107, 0.2);
        color: #ff6b6b;
      }

      .status-badge.holiday {
        background: rgba(136, 136, 136, 0.2);
        color: #888;
      }

      /* ê¸‰ì—¬ ìš”ì•½ */
      .salary-summary {
        background: #111;
        border: 1px solid #222;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
      }

      .salary-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .salary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .salary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: #1a1a1a;
        border-radius: 8px;
      }

      .salary-label {
        color: #888;
        font-size: 14px;
      }

      .salary-value {
        font-weight: 600;
        color: #fff;
      }

      .salary-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: linear-gradient(
          135deg,
          rgba(0, 255, 136, 0.1) 0%,
          rgba(0, 255, 136, 0.05) 100%
        );
        border: 1px solid rgba(0, 255, 136, 0.3);
        border-radius: 12px;
      }

      .salary-total-label {
        font-size: 18px;
        font-weight: bold;
      }

      .salary-total-value {
        font-size: 28px;
        font-weight: bold;
        color: #00ff88;
      }

      /* í™•ì • ë²„íŠ¼ */
      .confirm-section {
        text-align: center;
        padding: 30px;
        background: #111;
        border: 1px solid #222;
        border-radius: 12px;
      }

      .confirm-btn {
        padding: 16px 48px;
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        border: none;
        border-radius: 12px;
        color: #000;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
      }

      .confirm-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
      }

      .confirm-btn:disabled {
        background: #333;
        color: #666;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .confirm-message {
        margin-top: 15px;
        color: #888;
        font-size: 14px;
      }

      .confirmed-badge {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 15px 30px;
        background: rgba(0, 255, 136, 0.1);
        border: 1px solid #00ff88;
        border-radius: 12px;
        color: #00ff88;
        font-size: 16px;
      }

      /* ì‹œê°„ ì„ íƒ ëª¨ë‹¬ */
      .time-picker-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .time-picker-modal.show {
        display: flex;
      }

      .time-picker {
        background: #1a1a1a;
        border-radius: 16px;
        padding: 30px;
        min-width: 300px;
      }

      .time-picker-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 20px;
        text-align: center;
      }

      .time-picker-wheels {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
      }

      .wheel-container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .wheel-label {
        color: #666;
        font-size: 12px;
        margin-bottom: 10px;
      }

      .wheel {
        height: 150px;
        overflow-y: scroll;
        scrollbar-width: none;
        -ms-overflow-style: none;
        background: #222;
        border-radius: 8px;
        padding: 0 10px;
      }

      .wheel::-webkit-scrollbar {
        display: none;
      }

      .wheel-item {
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        color: #444;
        cursor: pointer;
        transition: all 0.2s;
      }

      .wheel-item.selected {
        color: #00ff88;
        transform: scale(1.2);
      }

      .time-picker-actions {
        display: flex;
        gap: 10px;
      }

      .picker-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .picker-btn.primary {
        background: #00ff88;
        color: #000;
      }

      .picker-btn.secondary {
        background: #333;
        color: #fff;
      }

      /* ê²½ê³  ë©”ì‹œì§€ */
      .warning-box {
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid #ff6b6b;
        border-radius: 12px;
        padding: 15px 20px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #ff6b6b;
      }

      /* í† ìŠ¤íŠ¸ */
      .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #222;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 15px 25px;
        display: none;
        align-items: center;
        gap: 10px;
        z-index: 2000;
        animation: slideIn 0.3s ease;
      }

      .toast.show {
        display: flex;
      }

      .toast.success {
        border-color: #00ff88;
      }

      .toast.error {
        border-color: #ff6b6b;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* ë¡œë”© */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 3000;
        justify-content: center;
        align-items: center;
      }

      .loading-overlay.show {
        display: flex;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid #333;
        border-top-color: #00ff88;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* ë°˜ì‘í˜• */
      @media (max-width: 768px) {
        .table-header,
        .table-row {
          grid-template-columns: 80px 1fr 1fr 60px;
        }

        .table-header > *:nth-child(5),
        .table-row > *:nth-child(5) {
          display: none;
        }

        .info-cards {
          grid-template-columns: 1fr 1fr;
        }

        .salary-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- í—¤ë” -->
    <header class="header">
      <div class="logo">âš¡ íš¨ì§„ìœ í†µ</div>
      <div class="user-info">
        <span class="user-name" id="userName">ë¡œë”©ì¤‘...</span>
        <button class="logout-btn" onclick="location.href='/logout'">
          ë¡œê·¸ì•„ì›ƒ
        </button>
      </div>
    </header>

    <!-- ë©”ì¸ -->
    <main class="main-container">
      <!-- ì •ë³´ ì¹´ë“œ -->
      <div class="info-cards">
        <div class="info-card">
          <div class="info-card-label">ğŸ’° ì‹œê¸‰</div>
          <div class="info-card-value" id="hourlyWage">0ì›</div>
        </div>
        <div class="info-card">
          <div class="info-card-label">â° ê¸°ë³¸ ê·¼ë¬´ì‹œê°„</div>
          <div class="info-card-value" style="font-size: 18px">
            09:00 ~ 18:00
          </div>
        </div>
        <div class="info-card">
          <div class="info-card-label">ğŸ“… ì´ë²ˆë‹¬ ì¶œê·¼ì¼</div>
          <div class="info-card-value" id="workDays">0ì¼</div>
        </div>
        <div class="info-card">
          <div class="info-card-label">â±ï¸ ì´ë²ˆë‹¬ ì´ ê·¼ë¬´ì‹œê°„</div>
          <div class="info-card-value" id="totalHours">0ì‹œê°„</div>
        </div>
      </div>

      <!-- ì›” ì„ íƒ -->
      <div class="month-selector">
        <button class="month-btn" onclick="changeMonth(-1)">â—€</button>
        <span class="current-month" id="currentMonth">2025ë…„ 1ì›”</span>
        <button class="month-btn" onclick="changeMonth(1)">â–¶</button>
      </div>

      <!-- ê²½ê³  ë©”ì‹œì§€ -->
      <div class="warning-box" id="warningBox" style="display: none">
        <span>âš ï¸</span>
        <span id="warningMessage"></span>
      </div>

      <!-- ì¶œí‡´ê·¼ ê¸°ë¡ -->
      <div class="attendance-table">
        <div class="table-header">
          <div>ë‚ ì§œ</div>
          <div>ì¶œê·¼ ì‹œê°„</div>
          <div>í‡´ê·¼ ì‹œê°„</div>
          <div>ê·¼ë¬´ì‹œê°„</div>
          <div>ìƒíƒœ</div>
        </div>
        <div id="attendanceList">
          <!-- ë™ì  ìƒì„± -->
        </div>
      </div>

      <!-- ê¸‰ì—¬ ìš”ì•½ -->
      <div class="salary-summary">
        <div class="salary-title">ğŸ’µ ì´ë²ˆë‹¬ ê¸‰ì—¬ ë‚´ì—­</div>
        <div class="salary-grid">
          <div class="salary-item">
            <span class="salary-label">ê¸°ë³¸ê¸‰</span>
            <span class="salary-value" id="basePay">0ì›</span>
          </div>
          <div class="salary-item">
            <span class="salary-label">ì´ˆê³¼ê·¼ë¬´ ìˆ˜ë‹¹</span>
            <span class="salary-value" id="overtimePay">0ì›</span>
          </div>
          <div class="salary-item">
            <span class="salary-label">ì£¼íœ´ìˆ˜ë‹¹</span>
            <span class="salary-value" id="weeklyPay">0ì›</span>
          </div>
          <div class="salary-item">
            <span class="salary-label">ë§Œê·¼ìˆ˜ë‹¹</span>
            <span class="salary-value" id="fullBonus">0ì›</span>
          </div>
        </div>
        <div class="salary-total">
            <span class="salary-total-label">ì´ ì§€ê¸‰ ì˜ˆì •ì•¡</span>
            <span class="salary-total-value" id="totalPay">0ì›</span>
        </div>
        
        <!-- ê³„ì‚° ê³¼ì • ìƒì„¸ -->
        <div id="salaryDetail" style="margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px; font-size: 13px; color: #888; display: none;">
        </div>
    </div>
      </div>

      <!-- í™•ì • ì„¹ì…˜ -->
      <div class="confirm-section" id="confirmSection">
        <div id="confirmContent">
          <!-- ë™ì  ìƒì„± -->
        </div>
      </div>
    </main>

    <!-- ì‹œê°„ ì„ íƒ ëª¨ë‹¬ -->
    <div class="time-picker-modal" id="timePickerModal">
      <div class="time-picker">
        <div class="time-picker-title" id="pickerTitle">ì¶œê·¼ ì‹œê°„ ì„ íƒ</div>
        <div class="time-picker-wheels">
          <div class="wheel-container">
            <div class="wheel-label">ì‹œ</div>
            <div class="wheel" id="hourWheel">
              <!-- ë™ì  ìƒì„± -->
            </div>
          </div>
          <div class="wheel-container">
            <div class="wheel-label">ë¶„</div>
            <div class="wheel" id="minuteWheel">
              <!-- ë™ì  ìƒì„± -->
            </div>
          </div>
        </div>
        <div class="time-picker-actions">
          <button class="picker-btn secondary" onclick="closeTimePicker()">
            ì·¨ì†Œ
          </button>
          <button class="picker-btn primary" onclick="confirmTime()">
            í™•ì¸
          </button>
        </div>
      </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast">
      <span id="toastIcon">âœ…</span>
      <span id="toastMessage"></span>
    </div>

    <!-- ë¡œë”© -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>

    <script>
      // ìƒíƒœ
      let currentYear = new Date().getFullYear();
      let currentMonth = new Date().getMonth() + 1;
      let attendanceData = null;
      let salaryData = null;
      let selectedDate = null;
      let selectedType = null; // 'in' or 'out'
      let selectedHour = 9;
      let selectedMinute = 0;

      // ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", () => {
        loadSessionInfo();
        loadAttendance();
        initTimeWheels();
      });

      // ì„¸ì…˜ ì •ë³´ ë¡œë“œ
      async function loadSessionInfo() {
        try {
          const response = await fetch("/api/session");
          const data = await response.json();
          document.getElementById("userName").textContent =
            data.user_name + "ë‹˜";
        } catch (error) {
          console.error("ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:", error);
        }
      }

      // ì¶œí‡´ê·¼ ë°ì´í„° ë¡œë“œ
      async function loadAttendance() {
        showLoading();
        try {
          const response = await fetch(
            `/api/attendance?year=${currentYear}&month=${currentMonth}`
          );
          attendanceData = await response.json();

          if (attendanceData.success) {
            document.getElementById("hourlyWage").textContent =
              formatNumber(attendanceData.hourly_wage) + "ì›";
            updateMonthDisplay();
            renderAttendanceTable();
            loadSalary();
          } else {
            showToast("error", attendanceData.error || "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
          }
        } catch (error) {
          showToast("error", "ì„œë²„ ì—°ê²° ì˜¤ë¥˜");
        }
        hideLoading();
      }

      // ê¸‰ì—¬ ê³„ì‚° ë¡œë“œ
      async function loadSalary() {
        try {
          const response = await fetch(
            `/api/salary/calculate?year=${currentYear}&month=${currentMonth}`
          );
          salaryData = await response.json();

          if (salaryData.success) {
            renderSalary(salaryData.breakdown);
            document.getElementById("workDays").textContent =
              salaryData.breakdown.work_days + "ì¼";
            document.getElementById("totalHours").textContent =
              salaryData.breakdown.total_hours + "ì‹œê°„";
            checkConfirmButton();
            document.getElementById("warningBox").style.display = "none";
          } else if (salaryData.error === "INCOMPLETE_RECORDS") {
            document.getElementById("warningBox").style.display = "flex";
            document.getElementById(
              "warningMessage"
            ).textContent = `ì¶œí‡´ê·¼ ê¸°ë¡ì´ ë¶ˆì™„ì „í•©ë‹ˆë‹¤: ${salaryData.incomplete_dates.join(
              ", "
            )}`;
            renderSalary({
              base_pay: 0,
              overtime_pay: 0,
              weekly_holiday_pay: 0,
              full_attendance_bonus: 0,
              total_pay: 0,
            });
          }
        } catch (error) {
          console.error("ê¸‰ì—¬ ê³„ì‚° ì‹¤íŒ¨:", error);
        }
      }

      // ì›” ë³€ê²½
      function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth > 12) {
          currentMonth = 1;
          currentYear++;
        } else if (currentMonth < 1) {
          currentMonth = 12;
          currentYear--;
        }
        loadAttendance();
      }

      function updateMonthDisplay() {
        document.getElementById(
          "currentMonth"
        ).textContent = `${currentYear}ë…„ ${currentMonth}ì›”`;
      }

      // ì¶œí‡´ê·¼ í…Œì´ë¸” ë Œë”ë§
      function renderAttendanceTable() {
        const container = document.getElementById("attendanceList");
        const today = new Date().toISOString().split("T")[0];
        const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
        const holidays = new Set(attendanceData.holidays || []);
        const recordsMap = {};

        (attendanceData.records || []).forEach((r) => {
          recordsMap[r.work_date] = r;
        });

        let html = "";

        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${currentYear}-${String(currentMonth).padStart(
            2,
            "0"
          )}-${String(day).padStart(2, "0")}`;
          const dateObj = new Date(currentYear, currentMonth - 1, day);
          const dayOfWeek = dateObj.getDay();
          const dayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];

          const record = recordsMap[dateStr];
          const isToday = dateStr === today;
          const isHoliday = holidays.has(dateStr);
          const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
          const isOff = isHoliday || isWeekend;
          const hasRecord = record && (record.clock_in || record.clock_out);
          const isIncomplete =
            record &&
            ((record.clock_in && !record.clock_out) ||
              (!record.clock_in && record.clock_out));
          const isEditable = isToday || (record && record.is_editable);
          const isPast = dateStr < today && !hasRecord;

          let rowClass = "table-row";
          if (isToday) rowClass += " today";
          if (isIncomplete) rowClass += " incomplete";
          if (isPast && isOff) rowClass += " holiday";
          if (isWeekend) rowClass += " weekend";

          // ê·¼ë¬´ì‹œê°„ ê³„ì‚°
          let hours = "-";
          if (record && record.clock_in && record.clock_out) {
            const [inH, inM] = record.clock_in.split(":").map(Number);
            const [outH, outM] = record.clock_out.split(":").map(Number);
            let totalMin = outH * 60 + outM - (inH * 60 + inM);
            // ì ì‹¬ì‹œê°„ ê³µì œ
            if (inH < 13 && outH >= 12) {
              totalMin -= 60;
            }
            hours = (totalMin / 60).toFixed(1) + "h";
          }

          // ìƒíƒœ
          let status = "";
          if (hasRecord) {
            if (isIncomplete) {
              status = '<span class="status-badge incomplete">ë¯¸ì™„ë£Œ</span>';
            } else {
              status = '<span class="status-badge complete">ì™„ë£Œ</span>';
            }
          } else if (isPast && isOff) {
            status = '<span class="status-badge holiday">íœ´ë¬´</span>';
          } else if (isPast) {
            status = '<span class="status-badge holiday">ë¯¸ì¶œê·¼</span>';
          }

          // ì¶œí‡´ê·¼ ì‹œê°„ í‘œì‹œ
          const clockInDisplay = record?.clock_in
            ? record.clock_in.substring(0, 5)
            : "--:--";
          const clockOutDisplay = record?.clock_out
            ? record.clock_out.substring(0, 5)
            : "--:--";

          const canEdit =
            !attendanceData.is_confirmed &&
            (isToday || isEditable) &&
            dateStr <= today;

          html += `
                    <div class="${rowClass}" data-date="${dateStr}">
                        <div class="date-cell">
                            <span class="date-main">${day}ì¼</span>
                            <span class="date-day">${dayNames[dayOfWeek]}ìš”ì¼${
            isHoliday ? " (ê³µíœ´ì¼)" : ""
          }</span>
                        </div>
                        <div class="time-input-wrapper">
                            <div class="time-display ${
                              !record?.clock_in ? "empty" : ""
                            } ${!canEdit ? "disabled" : ""}" 
                                 onclick="${
                                   canEdit
                                     ? `openTimePicker('${dateStr}', 'in', '${
                                         record?.clock_in || "09:00"
                                       }')`
                                     : ""
                                 }"
                                 ${
                                   !canEdit
                                     ? 'title="ìˆ˜ì • ë¶ˆê°€ (ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”)"'
                                     : ""
                                 }>
                                ${clockInDisplay}
                            </div>
                        </div>
                        <div class="time-input-wrapper">
                            <div class="time-display ${
                              !record?.clock_out ? "empty" : ""
                            } ${!canEdit ? "disabled" : ""}"
                                 onclick="${
                                   canEdit
                                     ? `openTimePicker('${dateStr}', 'out', '${
                                         record?.clock_out || "18:00"
                                       }')`
                                     : ""
                                 }"
                                 ${
                                   !canEdit
                                     ? 'title="ìˆ˜ì • ë¶ˆê°€ (ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”)"'
                                     : ""
                                 }>
                                ${clockOutDisplay}
                            </div>
                        </div>
                        <div class="hours-cell">${hours}</div>
                        <div>${status}</div>
                    </div>
                `;
        }

        container.innerHTML = html;
      }

      // ê¸‰ì—¬ ë Œë”ë§
      function renderSalary(breakdown) {
        document.getElementById("basePay").textContent =
          formatNumber(breakdown.base_pay) + "ì›";
        document.getElementById("overtimePay").textContent =
          formatNumber(breakdown.overtime_pay) + "ì›";
        document.getElementById("weeklyPay").textContent =
          formatNumber(breakdown.weekly_holiday_pay) + "ì›";
        document.getElementById("fullBonus").textContent =
          formatNumber(breakdown.full_attendance_bonus) + "ì›";
        document.getElementById("totalPay").textContent =
          formatNumber(breakdown.total_pay) + "ì›";
      }

      // í™•ì • ë²„íŠ¼ ì²´í¬
      function checkConfirmButton() {
        const container = document.getElementById("confirmContent");

        if (attendanceData.is_confirmed) {
          container.innerHTML = `
                    <div class="confirmed-badge">
                        âœ… ${attendanceData.year_month} ê¸‰ì—¬ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤
                    </div>
                    <p class="confirm-message">í™•ì •ì¼: ${new Date(
                      attendanceData.confirmation_data?.confirmed_at
                    ).toLocaleString()}</p>
                `;
          return;
        }

        // ë§ˆì§€ë§‰ë‚  ì²´í¬
        const today = new Date();
        const lastDay = new Date(currentYear, currentMonth, 0).getDate();
        const isLastDay =
          today.getDate() === lastDay &&
          today.getMonth() + 1 === currentMonth &&
          today.getFullYear() === currentYear;

        // ë¶ˆì™„ì „ ê¸°ë¡ ì²´í¬
        const hasIncomplete =
          salaryData && salaryData.error === "INCOMPLETE_RECORDS";

        // ì´ë²ˆë‹¬ì´ ì•„ë‹ˆë©´ ìˆ¨ê¹€
        const isCurrentMonth =
          currentMonth === new Date().getMonth() + 1 &&
          currentYear === new Date().getFullYear();

        if (!isCurrentMonth) {
          container.innerHTML = `<p class="confirm-message">ì´ë²ˆë‹¬ì´ ì•„ë‹Œ ë‹¬ì˜ ê¸‰ì—¬ëŠ” í™•ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
          return;
        }

        if (hasIncomplete) {
          container.innerHTML = `
                    <button class="confirm-btn" disabled>ğŸ”’ ì›”ê¸‰ í™•ì •</button>
                    <p class="confirm-message" style="color: #ff6b6b;">ì¶œí‡´ê·¼ ê¸°ë¡ì´ ë¶ˆì™„ì „í•˜ì—¬ í™•ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                `;
          return;
        }

        if (isLastDay || today.getDate() > lastDay) {
          container.innerHTML = `
                    <button class="confirm-btn" onclick="confirmSalary()">âœ… ì›”ê¸‰ í™•ì •</button>
                    <p class="confirm-message">ìœ„ ê¸‰ì—¬ ë‚´ì—­ì— ë™ì˜í•˜ê³  í™•ì •í•©ë‹ˆë‹¤.</p>
                `;
        } else {
          container.innerHTML = `
                    <button class="confirm-btn" disabled>ğŸ”’ ì›”ê¸‰ í™•ì •</button>
                    <p class="confirm-message">ì›”ê¸‰ í™•ì •ì€ ${lastDay}ì¼(ë§ˆì§€ë§‰ë‚ )ë¶€í„° ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                `;
        }
      }

      // ì›”ê¸‰ í™•ì •
      async function confirmSalary() {
        if (
          !confirm(
            "ì´ë²ˆë‹¬ ê¸‰ì—¬ ë‚´ì—­ì— ë™ì˜í•˜ê³  í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní™•ì • í›„ì—ëŠ” ì¶œí‡´ê·¼ ê¸°ë¡ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          )
        ) {
          return;
        }

        showLoading();
        try {
          const response = await fetch("/api/salary/confirm", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ year: currentYear, month: currentMonth }),
          });

          const result = await response.json();

          if (result.success) {
            showToast("success", "ì›”ê¸‰ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
            loadAttendance();
          } else {
            showToast("error", result.error || "í™•ì • ì‹¤íŒ¨");
          }
        } catch (error) {
          showToast("error", "ì„œë²„ ì˜¤ë¥˜");
        }
        hideLoading();
      }

      // ì‹œê°„ ì„ íƒ ëª¨ë‹¬
      function initTimeWheels() {
        const hourWheel = document.getElementById("hourWheel");
        const minuteWheel = document.getElementById("minuteWheel");

        // ì‹œê°„ (0-23)
        let hourHtml = '<div style="height: 50px;"></div>';
        for (let h = 0; h < 24; h++) {
          hourHtml += `<div class="wheel-item" data-value="${h}" onclick="selectHour(${h})">${String(
            h
          ).padStart(2, "0")}</div>`;
        }
        hourHtml += '<div style="height: 50px;"></div>';
        hourWheel.innerHTML = hourHtml;

        // ë¶„ (0, 10, 20, 30, 40, 50)
        let minHtml = '<div style="height: 50px;"></div>';
        for (let m = 0; m < 60; m += 10) {
          minHtml += `<div class="wheel-item" data-value="${m}" onclick="selectMinute(${m})">${String(
            m
          ).padStart(2, "0")}</div>`;
        }
        minHtml += '<div style="height: 50px;"></div>';
        minuteWheel.innerHTML = minHtml;
      }

      function openTimePicker(date, type, currentTime) {
        selectedDate = date;
        selectedType = type;

        const [h, m] = (currentTime || "09:00").split(":").map(Number);
        selectedHour = h;
        selectedMinute = Math.floor(m / 10) * 10;

        document.getElementById("pickerTitle").textContent =
          type === "in" ? "ì¶œê·¼ ì‹œê°„ ì„ íƒ" : "í‡´ê·¼ ì‹œê°„ ì„ íƒ";

        updateWheelSelection();
        document.getElementById("timePickerModal").classList.add("show");
      }

      function closeTimePicker() {
        document.getElementById("timePickerModal").classList.remove("show");
      }

      function selectHour(h) {
        selectedHour = h;
        updateWheelSelection();
      }

      function selectMinute(m) {
        selectedMinute = m;
        updateWheelSelection();
      }

      function updateWheelSelection() {
    document.querySelectorAll('#hourWheel .wheel-item').forEach(el => {
        el.classList.toggle('selected', parseInt(el.dataset.value) === selectedHour);
    });
    document.querySelectorAll('#minuteWheel .wheel-item').forEach(el => {
        el.classList.toggle('selected', parseInt(el.dataset.value) === selectedMinute);
    });
    
    // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ - ì„ íƒëœ í•­ëª©ì„ ì¤‘ì•™ì— ìœ„ì¹˜
    setTimeout(() => {
        const hourWheel = document.getElementById('hourWheel');
        const selectedHourEl = hourWheel.querySelector('.wheel-item.selected');
        if (selectedHourEl) {
            hourWheel.scrollTop = selectedHourEl.offsetTop - hourWheel.offsetHeight / 2 + 25;
        }
        
        const minuteWheel = document.getElementById('minuteWheel');
        const selectedMinEl = minuteWheel.querySelector('.wheel-item.selected');
        if (selectedMinEl) {
            minuteWheel.scrollTop = selectedMinEl.offsetTop - minuteWheel.offsetHeight / 2 + 25;
        }
    }, 10);
}

      async function confirmTime() {
        const timeStr = `${String(selectedHour).padStart(2, "0")}:${String(
          selectedMinute
        ).padStart(2, "0")}`;

        // ê¸°ì¡´ ê¸°ë¡ ì°¾ê¸°
        const record =
          (attendanceData.records || []).find(
            (r) => r.work_date === selectedDate
          ) || {};

        const payload = {
          work_date: selectedDate,
          clock_in: selectedType === "in" ? timeStr : record.clock_in,
          clock_out: selectedType === "out" ? timeStr : record.clock_out,
        };

        showLoading();
        closeTimePicker();

        try {
          const response = await fetch("/api/attendance", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();

          if (result.success) {
            showToast("success", "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤");
            loadAttendance();
          } else {
            showToast("error", result.error || "ì €ì¥ ì‹¤íŒ¨");
          }
        } catch (error) {
          showToast("error", "ì„œë²„ ì˜¤ë¥˜");
        }
        hideLoading();
      }

      // ìœ í‹¸ë¦¬í‹°
      function formatNumber(num) {
        return (num || 0).toLocaleString();
      }

      function showLoading() {
        document.getElementById("loadingOverlay").classList.add("show");
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.remove("show");
      }

      function showToast(type, message) {
        const toast = document.getElementById("toast");
        const icon = document.getElementById("toastIcon");
        const msg = document.getElementById("toastMessage");

        icon.textContent = type === "success" ? "âœ…" : "âŒ";
        msg.textContent = message;
        toast.className = `toast show ${type}`;

        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }
    </script>
  </body>
</html>
